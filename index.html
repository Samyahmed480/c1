<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWC System - نظام إدارة الأكاديمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <!-- Jitsi Meet API -->
    <script src='https://meet.jit.si/external_api.js'></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .sidebar-link.active { background-color: rgba(255, 255, 255, 0.1); border-right: 4px solid #FBBF24; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Jitsi Button Style */
        .btn-jitsi { background: #1d4ed8; color: white; transition: all 0.3s; }
        .btn-jitsi:hover { background: #1e40af; transform: translateY(-2px); }
        
        @media print {
            body * { visibility: hidden; }
            #certificate-print-area, #certificate-print-area * { visibility: visible; }
            #certificate-print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 0; background: white; }
            .no-print { display: none !important; }
        }
        .certificate-bg {
            background-image: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('https://www.transparenttextures.com/patterns/cubes.png');
            border: 10px solid #1E3A8A;
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#1E3A8A', secondary: '#1D4ED8', accent: '#FBBF24' } } } }
    </script>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg relative overflow-hidden">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 text-primary rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-university"></i></div>
                <h1 class="text-3xl font-bold text-primary">AWC System</h1>
                <p class="text-gray-500 mt-2">نظام إدارة الأكاديمية المتكامل</p>
            </div>

            <div class="flex justify-center bg-gray-100 p-1 rounded-lg mb-4">
                <button onclick="toggleLoginType('admin')" id="btn-login-admin" class="flex-1 py-2 rounded-md font-bold text-sm transition bg-white shadow text-primary">إدارة (Admin)</button>
                <button onclick="toggleLoginType('trainee')" id="btn-login-trainee" class="flex-1 py-2 rounded-md font-bold text-sm transition text-gray-500 hover:bg-gray-200">متدرب (Student)</button>
            </div>

            <form id="admin-login-form" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <input type="email" id="login-email" required placeholder="البريد الإلكتروني" class="w-full px-4 py-3 rounded-lg border outline-none" dir="ltr">
                    <input type="password" id="login-password" required placeholder="كلمة المرور" class="w-full px-4 py-3 rounded-lg border outline-none" dir="ltr">
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4 h-5"></p>
                <button type="submit" class="w-full mt-2 bg-primary hover:bg-secondary text-white font-bold py-3 px-6 rounded-lg shadow-md">تسجيل الدخول</button>
            </form>

            <form id="trainee-login-form" onsubmit="handleTraineeLogin(event)" class="hidden">
                <div class="space-y-4">
                    <input type="text" id="login-code" placeholder="كود الطالب (مثال: AWC-S-1234)" required class="w-full px-4 py-3 rounded-lg border outline-none" dir="ltr">
                    <input type="tel" id="login-phone" placeholder="رقم الهاتف المسجل" required class="w-full px-4 py-3 rounded-lg border outline-none" dir="ltr">
                </div>
                <p id="trainee-login-error" class="text-red-500 text-sm text-center mt-4 h-5"></p>
                <button type="submit" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">دخول الطالب</button>
            </form>
            
           
        </div>
    </div>

    <!-- ADMIN APP -->
    <main id="main-app" class="flex min-h-screen hidden">
        <nav class="bg-primary text-white w-64 p-4 pt-8 space-y-6 hidden md:block flex-shrink-0 transition-all duration-300">
            <div class="text-center mb-8 border-b border-blue-800 pb-4">
                <h1 class="text-2xl font-bold">AWC System</h1>
                <p class="text-xs text-blue-300 mt-1">للاستشارات والتدريب</p>
            </div>
            <ul class="space-y-1 text-sm">
                <li><a href="#" onclick="showView('dashboard')" id="nav-dashboard" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-tachometer-alt ml-3 w-5"></i> لوحة التحكم</a></li>
                <li><a href="#" onclick="showView('register')" id="nav-register" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-user-plus ml-3 w-5"></i> تسجيل متدرب</a></li>
                <li><a href="#" onclick="showView('attendance')" id="nav-attendance" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-user-check ml-3 w-5"></i> تفعيل الحضور</a></li>
                <li><a href="#" onclick="showView('trainees')" id="nav-trainees" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-users ml-3 w-5"></i> إدارة المتدربين</a></li>
                <li><a href="#" onclick="showView('lectures')" id="nav-lectures" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-video ml-3 w-5"></i> جدول المحاضرات</a></li>
                <li><a href="#" onclick="showView('certificates')" id="nav-certificates" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-award ml-3 w-5"></i> الشهادات</a></li>
                <li><a href="#" onclick="showView('courses')" id="nav-courses" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-book-open ml-3 w-5"></i> الكورسات</a></li>
                <li><a href="#" onclick="showView('instructors')" id="nav-instructors" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-chalkboard-teacher ml-3 w-5"></i> المدربين</a></li>
                <li><a href="#" onclick="showView('reports')" id="nav-reports" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-chart-pie ml-3 w-5"></i> التقارير</a></li>
                <li><a href="#" onclick="showView('evaluations')" id="nav-evaluations" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-star-half-alt ml-3 w-5"></i> التقييمات</a></li>
                <li><a href="#" onclick="showView('users')" id="nav-users" class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-white/5 transition"><i class="fas fa-users-cog ml-3 w-5"></i> المستخدمين</a></li>
            </ul>
        </nav>

        <div class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
            <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
                <div class="flex items-center gap-3">
                    <button class="md:hidden text-gray-600 text-2xl" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
                    <h2 id="page-title" class="text-xl md:text-2xl font-bold text-gray-800">لوحة التحكم</h2>
                </div>
                <button onclick="handleLogout()" class="text-gray-500 hover:text-red-500 transition" title="خروج"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </header>

            <!-- 1. Dashboard -->
            <div id="view-dashboard" class="view-section fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><p class="text-gray-500">المتدربين</p><h3 class="text-3xl font-bold" id="stat-total-students">0</h3></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><p class="text-gray-500">استشارات</p><h3 class="text-3xl font-bold" id="stat-consulting">0</h3></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><p class="text-gray-500">محاضرات</p><h3 class="text-3xl font-bold" id="stat-total-lectures">0</h3></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><p class="text-gray-500">شهادات</p><h3 class="text-3xl font-bold" id="stat-total-certificates">0</h3></div>
                </div>
            </div>

            <!-- 2. Register -->
            <div id="view-register" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">تسجيل متدرب أو عميل جديد</h2>
                    <form id="registerForm" onsubmit="handleRegister(event)">
                        <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <label class="block text-sm font-bold text-gray-800 mb-2">نوع الخدمة</label>
                            <select id="service-type-select" onchange="toggleServiceFields()" class="w-full p-3 rounded border bg-white border-gray-300 focus:border-blue-500 outline-none">
                                <option value="course">كورسات محاسبة (حضور/أونلاين)</option>
                                <option value="recorded">كورس مسجل (فيديوهات فقط)</option>
                                <option value="consulting">استشارات مالية</option>
                            </select>
                            <p id="recorded-hint" class="hidden text-xs text-red-600 mt-2 font-bold"><i class="fas fa-lock"></i> سيتم توليد يوزر وباسورد للمتدرب تلقائياً.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div><label class="block text-sm font-bold mb-2 text-gray-700">الاسم الكامل</label><input type="text" id="reg-name" required class="w-full p-3 border rounded-lg border-gray-300 outline-none"></div>
                            <div><label class="block text-sm font-bold mb-2 text-gray-700">الدولة</label><select id="reg-country" class="w-full p-3 border rounded-lg bg-white border-gray-300 outline-none text-left" dir="ltr"><option value="Egypt">Egypt (+20)</option><option value="KSA">KSA (+966)</option><option value="UAE">UAE (+971)</option><option value="Kuwait">Kuwait (+965)</option><option value="Qatar">Qatar (+974)</option><option value="Other">Other</option></select></div>
                            <div><label class="block text-sm font-bold mb-2 text-gray-700">رقم الهاتف</label><input type="tel" id="reg-phone" required class="w-full p-3 border rounded-lg border-gray-300 outline-none text-left" dir="ltr"></div>
                            <div><label class="block text-sm font-bold mb-2 text-gray-700">رقم واتساب</label><input type="tel" id="reg-whatsapp" class="w-full p-3 border rounded-lg border-gray-300 outline-none text-left" dir="ltr"></div>
                            <div><label class="block text-sm font-bold mb-2 text-gray-700">البريد الإلكتروني</label><input type="email" id="reg-email" class="w-full p-3 border rounded-lg border-gray-300 outline-none text-left" dir="ltr"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-bold mb-2 text-gray-700">العنوان</label><input type="text" id="reg-address" class="w-full p-3 border rounded-lg border-gray-300 outline-none"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-bold mb-2 text-gray-700">المصدر</label><select id="reg-source" class="w-full p-3 border rounded-lg border-gray-300 bg-white outline-none"><option value="Website">الموقع الإلكتروني</option><option value="Social">سوشيال ميديا</option><option value="Friend">ترشيح صديق</option></select></div>
                            
                            <div id="field-course-select" class="md:col-span-2"><label class="block text-sm font-bold mb-2 text-gray-700">اختر الكورس</label><select id="reg-service" onchange="updatePriceField()" class="w-full p-3 border rounded-lg border-gray-300 bg-white outline-none"><option value="">-- اختر --</option></select></div>
                            <div id="field-price-display" class="md:col-span-2 hidden"><label class="block text-sm font-bold mb-2 text-gray-700">قيمة الاشتراك ($)</label><input type="text" id="reg-price-display" readonly class="w-full p-3 border rounded-lg bg-gray-100 text-gray-700 font-bold border-gray-300"></div>
                            <div id="field-company-name" class="md:col-span-2 hidden"><label class="block text-sm font-bold mb-2 text-gray-700">اسم الشركة</label><input type="text" id="reg-company" class="w-full p-3 border rounded-lg border-gray-300 outline-none"></div>
                            <div id="field-consulting-price" class="md:col-span-2 hidden"><label class="block text-sm font-bold mb-2 text-gray-700">قيمة الاستشارة ($)</label><input type="number" id="reg-consulting-price" placeholder="0.00" class="w-full p-3 border rounded-lg border-gray-300 outline-none"></div>
                            <div id="field-consulting-details" class="md:col-span-2 hidden"><label class="block text-sm font-bold mb-2 text-gray-700">التفاصيل</label><textarea id="reg-consulting-details" class="w-full p-3 border rounded-lg border-gray-300 outline-none" rows="3"></textarea></div>

                            <div class="md:col-span-2 bg-gray-50 p-5 rounded-lg border border-gray-200 mt-2">
                                <h4 class="font-bold text-sm text-gray-700 mb-3 border-b pb-2">بيانات الدفع</h4>
                                <div class="flex flex-col gap-4">
                                    <label class="flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-100 rounded transition">
                                        <input type="checkbox" id="reg-is-paid" class="w-6 h-6 text-green-600 rounded cursor-pointer" onchange="toggleReceiptUpload()">
                                        <span class="font-bold text-gray-800 text-lg">تم الدفع (سداد كامل)</span>
                                    </label>
                                    <div id="reg-receipt-container" class="hidden transition-all animate-fade-in pl-8">
                                        <label class="block text-sm font-bold text-gray-600 mb-2">إرفاق إيصال السداد</label>
                                        <input type="file" id="reg-receipt" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border rounded-lg p-2 bg-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-lg hover:bg-blue-800 transition shadow-lg flex justify-center items-center gap-2"><i class="fas fa-save"></i> حفظ البيانات وإرسال واتساب تلقائي</button>
                    </form>
                </div>
            </div>

            <!-- 3. Attendance -->
            <div id="view-attendance" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">تفعيل الحضور (المسددين)</h2>
                    <input type="text" id="attendance-search-input" onkeyup="handleAttendanceSearch()" placeholder="بحث بالاسم أو الكود..." class="w-full p-3 border rounded-lg mb-6 border-gray-300 outline-none focus:border-blue-500">
                    <div id="attendance-results-container" class="space-y-3"></div>
                </div>
            </div>

            <!-- 2.5 Trainees -->
            <div id="view-trainees" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">إدارة المتدربين</h2>
                    <input type="text" id="trainee-management-search" onkeyup="updateTraineesManagementUI()" placeholder="بحث..." class="w-full p-3 border rounded mb-4">
                    <div class="overflow-x-auto"><table class="w-full text-right bg-white"><thead class="bg-gray-50"><tr><th class="p-3">الكود</th><th class="p-3">الاسم</th><th class="p-3">الهاتف</th><th class="p-3">الخدمة</th><th class="p-3">الحالة</th><th class="p-3">إجراء</th></tr></thead><tbody id="trainees-management-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- 4. Certificates -->
            <div id="view-certificates" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">إدارة الشهادات</h2>
                    <form onsubmit="handleCertificateUpload(event)" class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">اختر الطالب</label>
                            <select id="cert-trainee-select" class="w-full p-3 border rounded-lg bg-white" required>
                                <option value="">-- الرجاء الاختيار --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">ارفع ملف الشهادة (PDF أو صورة)</label>
                            <input type="file" id="cert-file-upload" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border rounded-lg p-2 bg-white" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-md">
                            <i class="fas fa-upload"></i> رفع وتعيين الشهادة
                        </button>
                    </form>
                </div>
            </div>

            <!-- 5. Lectures (Schedule Builder + Jitsi Integration) -->
            <div id="view-lectures" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center border-b mb-4 pb-3">
                        <div>
                            <button id="tab-btn-upcoming" onclick="switchLectureTab('upcoming')" class="px-4 py-2 text-blue-600 border-b-2 border-blue-600 font-semibold">الجدول القادم</button>
                            <button id="tab-btn-recorded" onclick="switchLectureTab('recorded')" class="px-4 py-2 text-gray-500 font-semibold">الأرشيف</button>
                        </div>
                        <button id="tab-btn-add" onclick="switchLectureTab('add')" class="px-4 py-2 text-gray-500 font-semibold flex items-center gap-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                            <i class="fas fa-plus-circle text-primary"></i> إضافة محاضرة
                        </button>
                    </div>

                    <div id="lecture-tab-add" class="hidden p-4 bg-gray-50 rounded-lg border mb-4 fade-in">
                        <h3 class="font-bold text-lg mb-4 text-primary">إضافة محاضرة جديدة</h3>
                        <form onsubmit="handleAddLecture(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="lec-title" placeholder="عنوان المحاضرة" required class="p-3 border rounded md:col-span-2 bg-white">
                            <select id="lec-course" required class="p-3 border rounded bg-white"><option value="">اختر الكورس</option></select>
                            <select id="lec-instructor-select" required class="p-3 border rounded bg-white"><option value="">اختر المحاضر</option></select>
                            <input type="date" id="lec-date" required class="p-3 border rounded bg-white">
                            <input type="time" id="lec-time" required class="p-3 border rounded bg-white">
                            <div class="md:col-span-2 flex items-center gap-2">
                                <input type="url" id="lec-link" placeholder="رابط الاجتماع (Zoom / Google Meet / Jitsi)" class="flex-1 p-3 border rounded bg-white" dir="ltr">
                                <button type="button" onclick="generateJitsiLink()" class="btn-jitsi px-4 py-3 rounded font-bold whitespace-nowrap shadow-md"><i class="fas fa-video mr-1"></i> إنشاء رابط Jitsi</button>
                            </div>
                            <div class="md:col-span-2"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="lec-notify" class="w-4 h-4"> <span class="text-sm">إرسال تذكير واتساب للمشتركين</span></label></div>
                            <button type="submit" class="bg-green-600 text-white font-bold py-3 rounded md:col-span-2 shadow hover:bg-green-700">إضافة للجدول</button>
                        </form>
                    </div>
                    
                    <div id="lecture-tab-upcoming" class="fade-in"><div id="upcoming-lectures-container" class="grid gap-3"></div></div>
                    <div id="lecture-tab-recorded" class="hidden fade-in"><div id="recorded-lectures-container" class="grid gap-3"></div></div>
                </div>
            </div>

            <!-- 6. Reports -->
            <div id="view-reports" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-6 text-primary">التقارير والإحصائيات</h2>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                        <div class="bg-blue-50 p-4 rounded border border-blue-100">
                            <h3 class="text-gray-500 text-sm mb-1">إجمالي العملاء</h3>
                            <p id="report-total-students" class="text-3xl font-bold text-primary">0</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded border border-green-100">
                            <h3 class="text-gray-500 text-sm mb-1">عملاء الاستشارات</h3>
                            <p id="report-consulting-count" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded border border-yellow-100">
                            <h3 class="text-gray-500 text-sm mb-1">عملاء مكتملي السداد</h3>
                            <p id="report-certificates-count" class="text-3xl font-bold text-yellow-600">0</p>
                        </div>
                    </div>

                    <!-- Details Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Financial Report -->
                        <div class="border p-4 rounded-lg lg:col-span-2">
                            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">التقرير المالي المفصل</h3>
                            <div class="grid grid-cols-3 gap-4 text-center mb-4">
                                <div class="bg-blue-50 p-3 rounded"><h4 class="text-xs text-gray-500">إجمالي الإيرادات</h4><p id="report-total-revenue" class="text-lg font-bold text-primary">$0</p></div>
                                <div class="bg-green-50 p-3 rounded"><h4 class="text-xs text-gray-500">إجمالي المحصل</h4><p id="report-total-collected" class="text-lg font-bold text-green-600">$0</p></div>
                                <div class="bg-red-50 p-3 rounded"><h4 class="text-xs text-gray-500">إجمالي المتبقي</h4><p id="report-total-due" class="text-lg font-bold text-red-600">$0</p></div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-6"><div id="report-revenue-progress" class="bg-green-500 h-4 rounded-full text-center text-white text-xs font-bold" style="width: 0%"></div></div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-600 mb-2">تفصيل حسب حالة السداد:</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span>مدفوع بالكامل</span><span id="report-fully-paid-count" class="font-bold bg-green-200 text-green-800 px-2 rounded-full">0</span></div>
                                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span>مدفوع جزئياً</span><span id="report-partially-paid-count" class="font-bold bg-yellow-200 text-yellow-800 px-2 rounded-full">0</span></div>
                                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span>غير مدفوع</span><span id="report-unpaid-count" class="font-bold bg-red-200 text-red-800 px-2 rounded-full">0</span></div>
                                </div>
                            </div>
                        </div>
                        <!-- Sources Report -->
                        <div class="border p-4 rounded-lg">
                            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">مصادر التسجيل</h3>
                            <div id="sources-report-container" class="space-y-3">
                                <!-- Dynamic content will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Instructor Performance Report -->
                    <div class="mt-8 border-t pt-6">
                        <h3 class="font-bold text-gray-700 mb-4">تقرير أداء المدربين</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <!-- Chart -->
                            <div class="lg:col-span-3 bg-white p-4 rounded-lg border h-80">
                                <canvas id="instructorPerformanceChart"></canvas>
                            </div>
                            <!-- Table -->
                            <div class="lg:col-span-2 overflow-x-auto border rounded-lg bg-white">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-3 text-sm font-semibold">المدرب</th>
                                            <th class="p-3 text-sm font-semibold text-center">الطلاب</th>
                                            <th class="p-3 text-sm font-semibold text-center">المحاضرات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="instructor-performance-report-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-700 mb-2 mt-8">أحدث المسجلين</h3>
                    <div class="overflow-x-auto border rounded-lg"><table class="w-full text-right"><thead class="bg-gray-50"><tr><th class="p-3">الاسم</th><th class="p-3">الخدمة</th><th class="p-3">الحالة</th></tr></thead><tbody id="trainees-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- 7. Instructors View (FIXED) -->
            <div id="view-instructors" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">إدارة المدربين</h2>
                    <form id="addInstructorForm" onsubmit="handleAddInstructor(event)" class="space-y-4 bg-gray-50 p-4 rounded-lg border mb-6">
                        <h3 class="font-bold text-gray-700">إضافة مدرب جديد</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="inst-name" placeholder="اسم المدرب الكامل" class="p-2 border rounded" required>
                            <input type="text" id="inst-spec" placeholder="التخصص (مثال: محاسبة مالية)" class="p-2 border rounded" required>
                            <input type="email" id="inst-email" placeholder="البريد الإلكتروني (للدخول)" class="p-2 border rounded md:col-span-2" required>
                            <input type="password" id="inst-password" placeholder="كلمة مرور مؤقتة" class="p-2 border rounded md:col-span-2" required>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white px-6 py-2 rounded font-bold">إنشاء حساب مدرب</button>
                    </form>
                    <h3 class="font-bold text-gray-700 mb-2">المدربين الحاليين</h3>
                    <table class="w-full"><tbody id="instructors-table-body"></tbody></table>
                </div>
            </div>

            <!-- 8. Courses View -->
            <div id="view-courses" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="font-bold mb-4 text-primary">إدارة الكورسات</h2>
                    <form id="addCourseForm" onsubmit="handleAddCourse(event)" class="flex flex-wrap gap-2 mb-4">
                        <input type="text" id="course-name" placeholder="اسم الكورس" class="border p-2 rounded flex-1" required>
                        <input type="number" id="course-price" placeholder="السعر" class="border p-2 rounded w-24" required>
                        <select id="course-instructor" class="border p-2 rounded"><option value="">مدرب</option></select>
                        <button type="submit" class="bg-primary text-white px-6 py-2 rounded">إضافة</button>
                    </form>
                    <table class="w-full"><tbody id="courses-table-body"></tbody></table>
                </div>
            </div>

            <!-- 9. Users View -->
            <div id="view-users" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">إدارة المستخدمين والصلاحيات</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Add User Form -->
                        <div class="md:col-span-1 bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold mb-3 text-gray-700">إضافة مستخدم جديد</h3>
                            <form id="addUserForm" onsubmit="handleAddNewUser(event)" class="space-y-4">
                                <input type="email" id="new-user-email" placeholder="البريد الإلكتروني للمستخدم" class="w-full p-2 border rounded" required>
                                <input type="password" id="new-user-password" placeholder="كلمة مرور مؤقتة" class="w-full p-2 border rounded" required>
                                <select id="new-user-role" class="w-full p-2 border rounded bg-white" required>
                                    <option value="assistant">مساعد (Assistant)</option>
                                    <option value="admin">مدير (Admin)</option>
                                </select>
                                <button type="submit" class="w-full bg-primary text-white px-4 py-2 rounded font-bold">إضافة مستخدم</button>
                            </form>
                        </div>

                        <!-- Users List -->
                        <div class="md:col-span-2">
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3 text-sm font-semibold">البريد الإلكتروني</th>
                                            <th class="p-3 text-sm font-semibold">الصلاحية</th>
                                            <th class="p-3 text-sm font-semibold">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 10. Evaluations View -->
            <div id="view-evaluations" class="view-section fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">تقييمات الطلاب</h2>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-sm font-semibold">الطالب</th>
                                    <th class="p-3 text-sm font-semibold">الكورس</th>
                                    <th class="p-3 text-sm font-semibold">المدرب المقيم</th>
                                    <th class="p-3 text-sm font-semibold">التقييم</th>
                                    <th class="p-3 text-sm font-semibold">ملاحظات</th>
                                    <th class="p-3 text-sm font-semibold">التاريخ</th>
                                </tr>
                            </thead>
                            <tbody id="evaluations-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- TRAINEE PORTAL (UPDATED + PROTECTED) -->
    <main id="trainee-app" class="flex flex-col min-h-screen hidden bg-gray-100 protected-content" oncontextmenu="return false;">
        <header class="bg-primary text-white p-4 shadow-md sticky top-0 z-20">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-user-graduate text-2xl"></i>
                    <div><h1 class="font-bold text-lg">بوابة الطالب</h1><p class="text-xs text-blue-200" id="trainee-header-name">...</p></div>
                </div>
                <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm transition font-bold flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
        </header>
        
        <div class="container mx-auto p-4 md:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <!-- Sidebar / Profile -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Profile Card -->
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-full bg-blue-100 text-primary flex items-center justify-center text-3xl"><i class="fas fa-user"></i></div>
                            <div>
                                <h3 id="trainee-profile-name" class="font-bold text-lg">...</h3>
                                <p id="trainee-profile-code" class="text-sm text-gray-500 font-mono">...</p>
                            </div>
                        </div>
                        <div class="mt-4 text-xs space-y-2 border-t pt-3">
                            <p><i class="fas fa-envelope text-gray-400 w-4 mr-2"></i> <span id="trainee-profile-email">...</span></p>
                            <p><i class="fas fa-phone text-gray-400 w-4 mr-2"></i> <span id="trainee-profile-phone">...</span></p>
                        </div>
                    </div>

                    <!-- Courses List -->
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <h2 class="font-bold text-gray-800 mb-3 border-b pb-2">دوراتي التدريبية</h2>
                        <div id="trainee-courses-list" class="space-y-2">
                            <!-- Course items will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="lg:col-span-3">
                    <div id="trainee-course-details" class="hidden space-y-6">
                        <!-- Recorded Course Credentials (NEW) -->
                        <div id="trainee-credentials-card" class="hidden bg-yellow-50 border border-yellow-200 p-4 rounded-lg flex items-start gap-3">
                            <div class="text-yellow-600 text-xl mt-1"><i class="fas fa-key"></i></div>
                            <div>
                                <h4 class="font-bold text-yellow-800">بيانات دخول المنصة</h4>
                                <p class="text-sm text-yellow-700">يمكنك الدخول للمحاضرات المسجلة باستخدام:</p>
                                <div class="mt-2 bg-white p-2 rounded border border-yellow-100 text-sm font-mono text-gray-600">
                                    User: <span id="cred-user" class="font-bold text-black">...</span><br>
                                    Pass: <span id="cred-pass" class="font-bold text-black">...</span>
                                </div>
                            </div>
                        </div>
                        <!-- Financials -->
                        <div class="bg-white rounded-xl shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-wallet text-green-600 ml-2"></i> الحالة المالية</h3>
                                <span id="trainee-detail-course-name" class="text-sm text-primary font-bold bg-blue-50 px-3 py-1 rounded-full"></span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div><p class="text-xs text-gray-500">الإجمالي</p><p class="font-bold" id="trainee-portal-total">$0</p></div>
                                <div><p class="text-xs text-gray-500">المدفوع</p><p class="font-bold text-green-600" id="trainee-portal-paid">$0</p></div>
                                <div><p class="text-xs text-gray-500">المتبقي</p><p class="font-bold text-red-600" id="trainee-portal-remain">$0</p></div>
                            </div>
                            <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-600 h-2.5 rounded-full" id="trainee-portal-progress" style="width: 0%"></div></div>
                        </div>
                        <!-- Course Schedule Table -->
                        <div class="bg-white rounded-xl shadow-sm border p-6">
                            <h3 class="font-bold text-lg text-gray-800 mb-4 border-b pb-2"><i class="fas fa-calendar-alt text-purple-600 ml-2"></i> جدول محاضرات الكورس</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-3 text-sm font-semibold">المحاضرة</th>
                                            <th class="p-3 text-sm font-semibold">التاريخ</th>
                                            <th class="p-3 text-sm font-semibold">الوقت</th>
                                            <th class="p-3 text-sm font-semibold">الحالة</th>
                                            <th class="p-3 text-sm font-semibold text-left">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trainee-schedule-tbody">
                                        <!-- Schedule rows will be injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Certificate -->
                        <div id="trainee-cert-section" class="hidden bg-white p-6 rounded-xl shadow-sm border flex justify-between items-center border-green-100 bg-green-50">
                            <div><h3 class="font-bold text-green-800">شهادة التخرج</h3><p class="text-sm text-green-600">مبارك! شهادتك جاهزة للتحميل.</p></div>
                            <button class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700"><i class="fas fa-download mr-2"></i> تحميل الشهادة</button>
                        </div>
                    </div>
                    <div id="trainee-no-course-selected" class="flex items-center justify-center h-full bg-white rounded-xl border min-h-[400px]">
                        <div class="text-center text-gray-500 p-8">
                            <i class="fas fa-graduation-cap text-5xl mb-4 text-primary"></i>
                            <h2 class="text-2xl font-bold text-gray-800">أهلاً بك في بوابتك التعليمية!</h2>
                            <p class="mt-2">أنت مسجل في <span id="trainee-welcome-courses-count" class="font-bold text-primary">0</span> دورات.</p>
                            <p class="mt-4 text-gray-400">الرجاء اختيار دورة من القائمة الجانبية لبدء رحلتك التعليمية وعرض التفاصيل.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Jitsi Meet Modal -->
    <div id="jitsi-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full h-full max-w-6xl flex flex-col">
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 id="jitsi-modal-title" class="font-bold text-lg text-primary">...</h3>
                <button onclick="closeJitsiMeeting()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="jitsi-container" class="flex-1 bg-gray-900 w-full h-full">
                <!-- Jitsi will be embedded here -->
            </div>
        </div>
    </div>
    <div id="trainee-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeTraineeDetailsModal()">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center z-10">
                <h3 class="font-bold text-lg text-primary">تفاصيل العميل</h3>
                <button onclick="closeTraineeDetailsModal()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="trainee-details-content" class="p-6">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>
    <div id="evaluation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeEvaluationModal()">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-primary">تقييم الطالب: <span id="eval-student-name"></span></h3>
                <button onclick="closeEvaluationModal()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <form id="evaluation-form" onsubmit="handleStudentEvaluation(event)" class="p-6 space-y-4">
                <input type="hidden" id="eval-trainee-id">
                <div><label class="block text-sm font-bold mb-2 text-gray-700">التقييم (من 10)</label><input type="number" id="eval-rating" min="1" max="10" class="w-full p-2 border rounded" required></div>
                <div><label class="block text-sm font-bold mb-2 text-gray-700">ملاحظات المدرب</label><textarea id="eval-comment" rows="4" class="w-full p-2 border rounded" placeholder="اكتب ملاحظاتك هنا..."></textarea></div>
                <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition">حفظ التقييم</button>
            </form>
        </div>
    </div>
    <div id="notification-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-black/50"><div class="bg-white p-6 rounded-lg w-80 text-center shadow-xl"><h3 id="notification-title" class="font-bold text-lg mb-2">تنبيه</h3><p id="notification-message" class="text-gray-600 mb-4">...</p><button onclick="closeNotification()" class="bg-primary text-white px-6 py-2 rounded">حسناً</button></div></div>

    <script>
        // === FIREBASE CONFIG ===
        let firebaseConfig; if(typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); else firebaseConfig = { apiKey: "AIzaSyAj6ykD72lDT7_5IeXRDR2paHOAqfQTdxo", authDomain: "awc-system.firebaseapp.com", projectId: "awc-system", storageBucket: "awc-system.appspot.com", messagingSenderId: "739243681978", appId: "1:739243681978:web:a1c77f354ae6424f70ba83", measurementId: "G-1PHE48ZPDK" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore(); const auth = firebase.auth(); const storage = firebase.storage(); const appId = typeof __app_id !== 'undefined' ? __app_id : 'awc-default';
        const safeDb = { collection: (n) => typeof __app_id !== 'undefined' ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection(n) : db.collection(n) };

        // === HELPERS ===
        function setText(id, val) { const el=document.getElementById(id); if(el) el.textContent=val; }
        function setHTML(id, val) { const el=document.getElementById(id); if(el) el.innerHTML=val; }
        const countryCodes = {'Egypt':'20','KSA':'966','UAE':'971','Kuwait':'965','Qatar':'974','Bahrain':'973','Oman':'968','Jordan':'962','Other':''};
        function formatPhone(c,p){ const code=countryCodes[c]||''; let cln=p.replace(/\D/g,''); if(code&&cln.startsWith('0')) cln=cln.substring(1); return code+cln; }
        function openWhatsApp(p,m){ window.open(`https://wa.me/${p}?text=${encodeURIComponent(m)}`,'_blank'); }
        function generateJitsiLink() {
            const room = 'AWC-Lecture-' + Math.random().toString(36).substring(7).toUpperCase();
            const link = `https://meet.jit.si/${room}`;
            const el = document.getElementById('lec-link');
            if(el) el.value = link;
        }

        let jitsiApi = null;
        function startJitsiMeeting(roomName, lectureTitle) {
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            const domain = 'meet.jit.si';
            const options = {
                roomName: roomName, width: '100%', height: '100%',
                parentNode: document.querySelector('#jitsi-container'),
                userInfo: { displayName: currentInstructorProfile ? currentInstructorProfile.name : 'Admin' },
                configOverwrite: { prejoinPageEnabled: false, startWithAudioMuted: true, startWithVideoMuted: true },
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false, SHOW_WATERMARK_FOR_GUESTS: false,
                    TOOLBAR_BUTTONS: [ 'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen', 'fodeviceselection', 'hangup', 'profile', 'chat', 'recording', 'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand', 'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts', 'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone', 'security' ],
                }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
            setText('jitsi-modal-title', lectureTitle);
            const modal = document.getElementById('jitsi-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            jitsiApi.addEventListener('videoConferenceLeft', () => { closeJitsiMeeting(); });
        }

        function joinJitsiMeetingAsTrainee(roomName, lectureTitle) {
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            const domain = 'meet.jit.si';
            const traineeName = currentTrainee ? currentTrainee.name : 'Student';
            const options = {
                roomName: roomName, width: '100%', height: '100%',
                parentNode: document.querySelector('#jitsi-container'),
                userInfo: { displayName: traineeName },
                configOverwrite: { prejoinPageEnabled: true, startWithAudioMuted: true, startWithVideoMuted: true },
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false, SHOW_WATERMARK_FOR_GUESTS: false,
                    TOOLBAR_BUTTONS: [ 'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen', 'fodeviceselection', 'hangup', 'profile', 'chat', 'raisehand', 'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts', 'tileview', 'videobackgroundblur', 'help' ],
                    SETTINGS_SECTIONS: [ 'devices', 'language', 'moderator', 'profile', 'sounds' ],
                    SHOW_CHROME_EXTENSION_BANNER: false
                }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
            setText('jitsi-modal-title', lectureTitle);
            const modal = document.getElementById('jitsi-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            jitsiApi.addEventListener('videoConferenceLeft', () => { closeJitsiMeeting(); });
        }

        function closeJitsiMeeting() {
            document.body.style.overflow = 'auto'; // Restore scrolling
            if (jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
            }
            const modal = document.getElementById('jitsi-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            setHTML('jitsi-container', '');
        }

        // === LECTURE NOTIFICATIONS (CLIENT-SIDE SCHEDULER) ===
        const NOTIFICATION_WINDOW_MINUTES = 15; // Send notification if lecture is within 15 mins

        function startNotificationScheduler() {
            // This function checks for upcoming lectures every minute.
            // IMPORTANT: This only works if this browser tab is open. For a reliable solution, a server-side function (like Firebase Cloud Functions) is recommended.
            console.log("Notification scheduler started. Checking every minute.");
            setInterval(async () => {
                const now = new Date();
                // Find lectures that are upcoming, require notification, and haven't had one sent yet.
                const lecturesToNotify = lectures.filter(l => 
                    l.status === 'upcoming' && 
                    l.notify === true && 
                    !l.notificationSent
                );

                for (const lecture of lecturesToNotify) {
                    const lectureTime = new Date(`${lecture.date}T${lecture.time}`);
                    const timeDiffMinutes = (lectureTime - now) / (1000 * 60);

                    // Check if the lecture is within the notification window
                    if (timeDiffMinutes > 0 && timeDiffMinutes <= NOTIFICATION_WINDOW_MINUTES) {
                        await triggerLectureNotification(lecture);
                    }
                }
            }, 60000); // Run every 60 seconds
        }

        async function triggerLectureNotification(lecture) {
            const students = trainees.filter(t => t.service === lecture.courseName && t.status === 'مفعل');
            if (students.length === 0) {
                await safeDb.collection('lectures').doc(lecture.id).update({ notificationSent: true });
                return;
            }
            const message = `📢 *تذكير بمحاضرة* 📢\n\n*المحاضرة:* ${lecture.title}\n*الكورس:* ${lecture.courseName}\n\n*الموعد:* ستبدأ قريباً، اليوم الساعة ${lecture.time}\n\n*رابط الانضمام:*\n${lecture.link || 'سيتم توفير الرابط في بوابة الطالب'}`;
            const doSend = confirm(`محاضرة "${lecture.title}" ستبدأ قريباً.\n\nهل تريد إرسال تذكير عبر واتساب لـ ${students.length} طالب الآن؟\n\n(سيتم فتح عدة نوافذ واتساب)`);
            if (doSend) {
                showNotification(`جاري إرسال ${students.length} تذكير...`);
                students.forEach((student, index) => { setTimeout(() => { const phone = formatPhone(student.country, student.whatsapp || student.phone); openWhatsApp(phone, message); }, index * 500); });
                await safeDb.collection('lectures').doc(lecture.id).update({ notificationSent: true });
            }
        }

        function startArchivingScheduler() {
            const ARCHIVE_DELAY_HOURS = 3; // أرشفة المحاضرة بعد 3 ساعات من بدايتها
            console.log(`Archiving scheduler started. Checking every 5 minutes for lectures to archive.`);

            setInterval(async () => {
                const now = new Date();
                const upcomingLectures = lectures.filter(l => l.status === 'upcoming');

                for (const lecture of upcomingLectures) {
                    if (!lecture.date || !lecture.time) continue; // تخطي المحاضرات بدون تاريخ أو وقت

                    try {
                        const lectureStartTime = new Date(`${lecture.date}T${lecture.time}`);
                        const archiveTime = new Date(lectureStartTime.getTime() + ARCHIVE_DELAY_HOURS * 60 * 60 * 1000);

                        if (now > archiveTime) {
                            console.log(`Archiving lecture: ${lecture.title} (ID: ${lecture.id})`);
                            await safeDb.collection('lectures').doc(lecture.id).update({ status: 'recorded' });
                        }
                    } catch (error) { console.error(`Error archiving lecture ${lecture.id}:`, error); }
                }
            }, 300000); // التشغيل كل 5 دقائق
        }

        // === PERMISSIONS & RBAC ===
        async function fetchUserRole(user) {
            currentInstructorProfile = null; // Reset on every fetch
            if (!user) {
                currentUserRole = null;
                applyPermissions();
                return;
            }
            const userDoc = await db.collection('system_users').doc(user.uid).get();
            if (userDoc.exists) {
                currentUserRole = userDoc.data().role;
                if (currentUserRole === 'instructor') {
                    // Find the instructor profile linked by UID. Assuming 'uid' field exists in instructors collection.
                    const instructorQuery = await safeDb.collection('instructors').where('uid', '==', user.uid).limit(1).get();
                    if (!instructorQuery.empty) {
                        currentInstructorProfile = { id: instructorQuery.docs[0].id, ...instructorQuery.docs[0].data() };
                    }
                }
            } else {
                // This might be the very first admin. Let's check if system_users is empty.
                const usersSnapshot = await db.collection('system_users').limit(1).get();
                if (usersSnapshot.empty) {
                    // First user ever, make them an admin.
                    await db.collection('system_users').doc(user.uid).set({
                        email: user.email,
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    });
                    currentUserRole = 'admin';
                } else {
                    // User exists in Auth but not in our roles collection. Deny access.
                    currentUserRole = 'guest'; 
                    showNotification('ليس لديك صلاحية الوصول للنظام. تواصل مع المدير.', 'error');
                    handleLogout();
                }
            }
            applyPermissions();
        }

        function applyPermissions() {
            const isAdmin = currentUserRole === 'admin';
            const isInstructor = currentUserRole === 'instructor';

            // Restore original names first
            const traineesLink = document.querySelector('#nav-trainees');
            if (traineesLink) traineesLink.innerHTML = '<i class="fas fa-users ml-3 w-5"></i> إدارة المتدربين';
            const lecturesLink = document.querySelector('#nav-lectures');
            if (lecturesLink) lecturesLink.innerHTML = '<i class="fas fa-video ml-3 w-5"></i> جدول المحاضرات';
            
            // Show all links by default, then hide based on role
            document.querySelectorAll('.sidebar-link').forEach(el => el.style.display = 'flex');

            if (isInstructor) {
                const instructorHiddenLinks = ['nav-register', 'nav-attendance', 'nav-certificates', 'nav-courses', 'nav-instructors', 'nav-reports', 'nav-users', 'nav-evaluations'];
                instructorHiddenLinks.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                // Rename links for instructor
                if (traineesLink) traineesLink.innerHTML = '<i class="fas fa-users ml-3 w-5"></i> طلابي';
                if (lecturesLink) lecturesLink.innerHTML = '<i class="fas fa-video ml-3 w-5"></i> محاضراتي';
            } else { // Assistant or Admin
                const adminOnlyElements = ['nav-reports', 'nav-users', 'nav-instructors', 'nav-courses', 'nav-evaluations'];
                if (!isAdmin) { // This is an assistant
                    adminOnlyElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = 'none';
                    });
                }
            }

            // If a non-admin is on a restricted view, redirect them.
            const currentViewId = document.querySelector('.view-section:not(.hidden)')?.id.replace('view-', '');
            const adminRestrictedViews = ['reports', 'users', 'instructors', 'courses', 'evaluations'];
            if (!isAdmin && adminRestrictedViews.includes(currentViewId)) {
                showView('dashboard');
            }
            const instructorRestrictedViews = ['register', 'attendance', 'certificates', 'courses', 'instructors', 'reports', 'users', 'evaluations'];
            if (isInstructor && instructorRestrictedViews.includes(currentViewId)) {
                showView('dashboard');
            }
        }

        // === STATE ===
        let trainees=[], lectures=[], instructors=[], courses=[], currentTrainee=null, allTraineeEnrollments=[], systemUsers=[], currentUserRole = null, currentInstructorProfile = null, instructorPerformanceChart = null;

        // === INIT ===
        document.addEventListener('DOMContentLoaded', async () => {
            // Force Logout on Load
            await auth.signOut(); 

            if(typeof __initial_auth_token!=='undefined'&&__initial_auth_token) try{await auth.signInWithCustomToken(__initial_auth_token);}catch(e){}
            
            auth.onAuthStateChanged(async u => {
                if(u && !currentTrainee) {
                    await fetchUserRole(u); // Fetch role for the logged-in user
                    if (currentUserRole && currentUserRole !== 'guest') {
                        document.getElementById('login-screen').classList.add('hidden'); 
                        document.getElementById('main-app').classList.remove('hidden');
                        showView('dashboard'); 
                        initListeners(); 
                        startNotificationScheduler();
                        startArchivingScheduler();
                    }
                } else if(!currentTrainee) {
                    currentUserRole = null; // Clear role on logout
                    applyPermissions();
                    document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden');
                }
            });
            initListeners();
        });

        function initListeners() {
            safeDb.collection('instructors').onSnapshot(s => { instructors=s.docs.map(d=>({id:d.id,...d.data()})); updateInstructorsUI(); });
            safeDb.collection('courses').onSnapshot(s => { courses=s.docs.map(d=>({id:d.id,...d.data()})); updateCoursesUI(); });
            safeDb.collection('lectures').orderBy('date','desc').onSnapshot(s => { lectures=s.docs.map(d=>({id:d.id,...d.data()})); updateLecturesUI(); if(currentTrainee) selectTraineeCourse(currentTrainee.id); });
            safeDb.collection('trainees').orderBy('date','desc').onSnapshot(s => { trainees=s.docs.map(d=>({id:d.id,...d.data()})); updateTraineesUI(); updateTraineesManagementUI(); updateReportsUI(); updateEvaluationsUI(); });
            db.collection('system_users').onSnapshot(s => { systemUsers = s.docs.map(d => ({ id: d.id, ...d.data() })); updateUsersUI(); });
        }

        // === VIEWS ===
        function showView(id) {
            // RBAC check
            const adminRestrictedViews = ['reports', 'users', 'instructors', 'courses', 'evaluations'];
            if (currentUserRole !== 'admin' && adminRestrictedViews.includes(id)) {
                showNotification('ليس لديك الصلاحية للوصول لهذه الصفحة.', 'error');
                id = 'dashboard'; // Redirect to dashboard
            }

            document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden'));
            const v=document.getElementById('view-'+id); if(v) { v.classList.remove('hidden'); v.classList.add('fade-in'); }
            const n=document.getElementById('nav-'+id); 
            if(n) { document.querySelectorAll('.sidebar-link').forEach(e=>e.classList.remove('active')); n.classList.add('active'); }
            if(id==='lectures') switchLectureTab('upcoming');
            if(id==='trainees') updateTraineesManagementUI();
            if(id==='reports') updateReportsUI();
            if(id==='users') updateUsersUI();
            if(id==='evaluations') updateEvaluationsUI();
            let pageTitle = {'dashboard':'لوحة التحكم','register':'تسجيل متدرب','attendance':'تفعيل الحضور','trainees':'إدارة المتدربين','certificates':'الشهادات','lectures':'المحاضرات','instructors':'المدربين','courses':'الكورسات','reports':'التقارير','users':'المستخدمين', 'evaluations':'التقييمات'}[id]||'AWC System';
            
            if (currentUserRole === 'instructor') {
                if (id === 'trainees') pageTitle = 'طلابك';
                if (id === 'lectures') pageTitle = 'محاضراتك';
            }

            setText('page-title', pageTitle);
        }
        function toggleLoginType(t) {
            if(t==='admin') { document.getElementById('admin-login-form').classList.remove('hidden'); document.getElementById('trainee-login-form').classList.add('hidden'); }
            else { document.getElementById('admin-login-form').classList.add('hidden'); document.getElementById('trainee-login-form').classList.remove('hidden'); }
        }
        function toggleMobileMenu() { document.getElementById('mobile-menu-overlay')?.classList.toggle('hidden'); }

        // === AUTH & TRAINEE PORTAL ===
        async function handleLogin(e) { e.preventDefault(); try{ await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); }catch(err){ showNotification('خطأ في الدخول','error'); } }
        async function demoLogin() { try{ await auth.signInWithEmailAndPassword('admin@awc.com', '123456'); }catch(e){ showNotification('حساب تجريبي غير متاح.','error'); } }
        async function handleLogout() { try{ await auth.signOut(); }catch(e){} window.location.reload(); }
        
        function handleTraineeLogin(e) {
            e.preventDefault();
            const c = document.getElementById('login-code').value.trim();
            const p = document.getElementById('login-phone').value.trim();
            const found = trainees.filter(t => (t.code==c || (t.code&&t.code.toLowerCase()==c.toLowerCase())) && (t.phone==p || t.whatsapp==p));
            
            if(found.length > 0) {
                const userPhone = found[0].phone; 
                allTraineeEnrollments = trainees.filter(t => t.phone === userPhone || t.whatsapp === userPhone);
                currentTrainee = found[0];
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('trainee-app').classList.remove('hidden');
                loadTraineePortal(allTraineeEnrollments);
            } else { showNotification('بيانات غير صحيحة','error'); }
        }

        function loadTraineePortal(enrollments) {
            const studentName = enrollments[0].name;
            const studentCode = enrollments[0].code;
            const studentEmail = enrollments[0].email || 'غير مسجل';
            const studentPhone = enrollments[0].phone;

            setText('trainee-header-name', studentName);
            setText('trainee-profile-name', studentName);
            setText('trainee-profile-code', studentCode);
            setText('trainee-profile-email', studentEmail);
            setText('trainee-profile-phone', studentPhone);

            const container = document.getElementById('trainee-courses-list');
            if(container) {
                container.innerHTML = enrollments.map((en, index) => `
                    <div onclick="selectTraineeCourse('${en.id}')" id="course-card-${en.id}" class="course-card p-3 rounded-lg border cursor-pointer hover:bg-gray-50 hover:border-blue-300 transition">
                        <h4 class="font-bold text-sm text-gray-800">${en.service}</h4>
                        <p class="text-xs text-gray-500">${en.serviceType==='recorded'?'مسجل (أونلاين)':'تفاعلي'}</p>
                    </div>`).join('');
            }
            
            // عرض شاشة الترحيب بدلاً من تحديد دورة تلقائياً
            document.getElementById('trainee-no-course-selected').classList.remove('hidden');
            document.getElementById('trainee-course-details').classList.add('hidden');
            setText('trainee-welcome-courses-count', enrollments.length);
        }

        function selectTraineeCourse(id) {
            const s = allTraineeEnrollments.find(t => t.id === id);
            if(!s) return;
            document.querySelectorAll('.course-card').forEach(el => { el.classList.remove('bg-blue-50', 'border-blue-400'); });
            const card = document.getElementById(`course-card-${id}`);
            if(card) card.classList.add('bg-blue-50', 'border-blue-400');
            
            document.getElementById('trainee-no-course-selected').classList.add('hidden');
            document.getElementById('trainee-course-details').classList.remove('hidden');

            // Credentials for Recorded Courses
            if(s.serviceType === 'recorded' && s.payment.status === 'مدفوع بالكامل') {
                document.getElementById('trainee-credentials-card').classList.remove('hidden');
                setText('cred-user', s.platformUser || s.code);
                setText('cred-pass', s.platformPass || '123456');
            } else {
                document.getElementById('trainee-credentials-card').classList.add('hidden');
            }

            setText('trainee-detail-course-name', s.service);
            const tot=s.payment?.total||0, pd=s.payment?.paid||0;
            setText('trainee-portal-total', '$'+tot); setText('trainee-portal-paid', '$'+pd); setText('trainee-portal-remain', '$'+(tot-pd));
            const pct=tot>0?Math.min(100,(pd/tot)*100):0;
            const prog=document.getElementById('trainee-portal-progress'); if(prog) prog.style.width=pct+'%';

            const myLecs = lectures.filter(l => l.courseName === s.service).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const scheduleRows = myLecs.map(l => {
                const roomName = l.link ? `'${l.link.split('/').pop()}'` : null;
                const lectureTitle = `'${l.title.replace(/'/g, "\\'")}'`;
                
                let actionButton = '';
                let statusBadge = '';

                if (l.status === 'upcoming') {
                    statusBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">قادمة</span>`;
                    if (l.link) {
                        actionButton = `<button onclick="joinJitsiMeetingAsTrainee(${roomName}, ${lectureTitle})" class="text-white bg-blue-500 px-3 py-1 rounded text-xs shadow hover:bg-blue-600">انضمام</button>`;
                    }
                } else if (l.status === 'recorded') {
                    statusBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">مسجلة</span>`;
                    if (l.recordingUrl) { // NEW: Check for recordingUrl
                        actionButton = `<a href="${l.recordingUrl}" target="_blank" class="text-white bg-green-500 px-3 py-1 rounded text-xs shadow hover:bg-green-600">مشاهدة التسجيل</a>`;
                    } else if (l.link) { // Fallback to Jitsi link if no recording
                        actionButton = `<button onclick="joinJitsiMeetingAsTrainee(${roomName}, ${lectureTitle})" class="text-white bg-gray-500 px-3 py-1 rounded text-xs shadow hover:bg-gray-600">مشاهدة</button>`;
                    }
                }

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-bold text-sm">${l.title}</td>
                        <td class="p-3 text-sm text-gray-600" dir="ltr">${l.date}</td>
                        <td class="p-3 text-sm text-gray-600" dir="ltr">${l.time}</td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3 text-left">${actionButton}</td>
                    </tr>
                `;
            }).join('');

            const emptyRow = `<tr><td colspan="5" class="text-center p-6 text-gray-400">لا يوجد محاضرات مجدولة لهذا الكورس.</td></tr>`;
            setHTML('trainee-schedule-tbody', myLecs.length > 0 ? scheduleRows : emptyRow);
            
            const certSection = document.getElementById('trainee-cert-section');
            if (certSection) {
                if (s.certificateUrl) {
                    certSection.classList.remove('hidden');
                    const downloadButton = certSection.querySelector('button');
                    downloadButton.onclick = () => window.open(s.certificateUrl, '_blank');
                } else {
                    certSection.classList.add('hidden');
                }
            }
        }

        function showTraineeDetails(id) {
            const trainee = trainees.find(t => t.id === id);
            if (!trainee) return;

            const contentEl = document.getElementById('trainee-details-content');
            
            let serviceDetailsHtml = '';
            if (trainee.serviceType === 'consulting') {
                serviceDetailsHtml = `
                    <div class="col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-100 mt-4">
                        <h4 class="font-bold text-primary mb-2">بيانات الاستشارة</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                            <p><strong>الخدمة:</strong> ${trainee.service}</p>
                            <p><strong>اسم الشركة:</strong> ${trainee.company || 'لم يحدد'}</p>
                            <div class="col-span-1 sm:col-span-2">
                                <p><strong>التفاصيل:</strong></p>
                                <p class="whitespace-pre-wrap bg-white p-2 mt-1 rounded border text-sm">${trainee.consultingDetails || 'لا يوجد'}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else { // course or recorded
                serviceDetailsHtml = `
                    <div class="col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-100 mt-4">
                        <h4 class="font-bold text-primary mb-2">بيانات الكورس</h4>
                        <p><strong>الكورس:</strong> ${trainee.service}</p>
                        <p><strong>نوع الخدمة:</strong> ${trainee.serviceType === 'recorded' ? 'كورس مسجل' : 'كورس تفاعلي'}</p>
                        ${trainee.serviceType === 'recorded' && trainee.platformUser ? `
                            <div class="mt-2 bg-yellow-100 p-2 rounded text-sm border border-yellow-200">
                                <p class="font-bold text-yellow-800">بيانات دخول المنصة:</p>
                                <p><strong>يوزر:</strong> ${trainee.platformUser}</p>
                                <p><strong>باسورد:</strong> ${trainee.platformPass}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            const detailsHtml = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 text-sm">
                    <div><p class="text-gray-500">الاسم الكامل</p><p class="font-bold text-base">${trainee.name}</p></div>
                    <div><p class="text-gray-500">الكود</p><p class="font-bold text-base font-mono">${trainee.code}</p></div>
                    <div><p class="text-gray-500">رقم الهاتف</p><p class="font-bold" dir="ltr">${trainee.phone}</p></div>
                    <div><p class="text-gray-500">رقم واتساب</p><p class="font-bold" dir="ltr">${trainee.whatsapp || trainee.phone}</p></div>
                    <div class="sm:col-span-2"><p class="text-gray-500">البريد الإلكتروني</p><p class="font-bold" dir="ltr">${trainee.email || 'لم يسجل'}</p></div>
                    <div class="sm:col-span-2"><p class="text-gray-500">العنوان</p><p class="font-bold">${trainee.address || 'لم يسجل'}</p></div>
                    <div><p class="text-gray-500">الدولة</p><p class="font-bold">${trainee.country}</p></div>
                    <div><p class="text-gray-500">المصدر</p><p class="font-bold">${trainee.source}</p></div>
                    <div><p class="text-gray-500">تاريخ التسجيل</p><p class="font-bold">${new Date(trainee.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</p></div>
                    <div><p class="text-gray-500">الحالة</p><p class="font-bold px-2 py-1 rounded inline-block ${trainee.status==='مفعل'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}">${trainee.status}</p></div>
                    
                    ${trainee.certificateUrl ? `
                        <div class="sm:col-span-2 mt-2">
                            <p class="text-gray-500">الشهادة</p>
                            <a href="${trainee.certificateUrl}" target="_blank" class="inline-block bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition">
                                <i class="fas fa-download mr-2"></i> عرض/تحميل الشهادة
                            </a>
                        </div>
                    ` : ''}
                    
                    ${serviceDetailsHtml}

                    <div class="col-span-2 bg-gray-50 p-4 rounded-lg border mt-4">
                        <h4 class="font-bold text-gray-700 mb-2">البيانات المالية</h4>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div><p class="text-xs text-gray-500">الإجمالي</p><p class="font-bold text-lg">$${trainee.payment.total}</p></div>
                            <div><p class="text-xs text-gray-500">المدفوع</p><p class="font-bold text-lg text-green-600">$${trainee.payment.paid}</p></div>
                            <div><p class="text-xs text-gray-500">حالة السداد</p><p class="font-bold text-base">${trainee.payment.status}</p></div>
                        </div>
                    </div>
                </div>
            `;
            
            contentEl.innerHTML = detailsHtml;
            document.getElementById('trainee-details-modal').classList.remove('hidden');
        }

        function closeTraineeDetailsModal() {
            document.getElementById('trainee-details-modal').classList.add('hidden');
        }

        // === DATA HANDLERS ===
        function toggleServiceFields() {
            const t = document.getElementById('service-type-select').value;
            const crs = document.getElementById('field-course-select'), cmp = document.getElementById('field-company-name'), prc = document.getElementById('field-price-display'), hint = document.getElementById('recorded-hint'), consultPrice = document.getElementById('field-consulting-price'), details = document.getElementById('field-consulting-details');
            if(t==='course' || t==='recorded'){ if(crs) crs.classList.remove('hidden'); if(cmp) cmp.classList.add('hidden'); if(prc) prc.classList.remove('hidden'); if(consultPrice) consultPrice.classList.add('hidden'); if(details) details.classList.add('hidden'); }
            else { if(crs) crs.classList.add('hidden'); if(cmp) cmp.classList.remove('hidden'); if(prc) prc.classList.add('hidden'); if(consultPrice) consultPrice.classList.remove('hidden'); if(details) details.classList.remove('hidden'); }
            if(t==='recorded') hint.classList.remove('hidden'); else hint.classList.add('hidden');
        }
        function updatePriceField() {
            const srvEl = document.getElementById('reg-service');
            const priceEl = document.getElementById('reg-price-display');
            if(srvEl.selectedIndex >= 0) { const p = srvEl.options[srvEl.selectedIndex].dataset.price; if(priceEl) priceEl.value = p ? p : 0; }
        }
        function toggleReceiptUpload() {
            const isPaid = document.getElementById('reg-is-paid').checked;
            const receiptDiv = document.getElementById('reg-receipt-container');
            if(receiptDiv) isPaid ? receiptDiv.classList.remove('hidden') : receiptDiv.classList.add('hidden');
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name=document.getElementById('reg-name').value, country=document.getElementById('reg-country').value, phone=document.getElementById('reg-phone').value;
            const type=document.getElementById('service-type-select').value;
            const srv = type==='consulting' ? 'استشارة مالية' : document.getElementById('reg-service').value;
            const srvEl = document.getElementById('reg-service');
            let price = 0;
            if (type === 'consulting') {
                price = parseFloat(document.getElementById('reg-consulting-price').value) || 0;
            } else if (srvEl.selectedIndex >= 0) {
                price = parseFloat(srvEl.options[srvEl.selectedIndex].dataset.price) || 0;
            }
            const code = (type==='consulting'?'AWC-C-':'AWC-S-') + Math.floor(10000+Math.random()*90000);
            const isPaid = document.getElementById('reg-is-paid').checked;
            
            let platUser = '', platPass = '';
            if(type === 'recorded') { platUser = code; platPass = Math.random().toString(36).slice(-8); }

            try {
                await safeDb.collection('trainees').add({
                    name, country, phone, whatsapp: document.getElementById('reg-whatsapp').value||phone,
                    email: document.getElementById('reg-email').value, address: document.getElementById('reg-address').value,
                    service: srv, serviceType: type, company: document.getElementById('reg-company').value, source: document.getElementById('reg-source').value, consultingDetails: document.getElementById('reg-consulting-details').value,
                    code, status: 'غير مفعل', payment: {total:price, paid:isPaid?price:0, status:isPaid?'مدفوع بالكامل':'غير مدفوع'}, 
                    platformUser: platUser, platformPass: platPass, date: new Date().toISOString()
                });
                
                let msg = '';
                if (type === 'consulting') {
                    msg = `مرحباً ${name}،\nتم تسجيل طلب الاستشارة المالية الخاص بكم بنجاح.\n\nكود العميل: ${code}\n\nسيتم التواصل معكم قريباً من خلال فريقنا لتحديد الموعد ومناقشة التفاصيل.\n\nشكراً لاختياركم AWC System.`;
                } else { // course or recorded
                    if (isPaid) {
                        msg = `مرحباً، ${name}
تم تأكيد اشتراكك وتفعيل حضورك في كورس "${srv}"
كود الطالب الخاص بك هو: ${code}

يرجى الاحتفاظ بالكود، سيتم استخدامه في متابعة حضورك.`;

                        if (type === 'recorded') {
                            msg += `\n\nلأن الكورس مسجل، يمكنك الآن الدخول إلى منصة المحاضرات باستخدام البيانات التالية:
User: ${platUser}
Pass: ${platPass}
(يرجى عدم مشاركة هذه البيانات)`;
                        }

                        msg += `\n\nتم الارسال بواسطة،
AWC Academy`;
                    } else {
                        msg = `مرحباً ${name}،\nتم تسجيلك مبدئياً في كورس "${srv}".\n\nالكود الخاص بك هو: ${code}\n\nيرجى إتمام عملية سداد الرسوم لتفعيل اشتراكك واستلام بيانات الدخول.\n\nشكراً لك.`;
                    }
                }

                openWhatsApp(formatPhone(country, phone), msg);
                showNotification('تم الحفظ بنجاح', 'success', 'نجاح'); 
                e.target.reset(); document.getElementById('reg-receipt-container').classList.add('hidden');
            } catch(err) { console.error(err); showNotification('حدث خطأ أثناء الحفظ', 'error', 'خطأ'); }
        }

        // === SEED DATA ===
        async function seedDatabase() {
            // Instructors
            try {
                await auth.createUserWithEmailAndPassword('admin@awc.com', '123456');
                const userDoc = await db.collection('system_users').where('email', '==', 'admin@awc.com').get();
                if (userDoc.empty) {
                    const adminUser = auth.currentUser;
                    if(adminUser) {
                        await db.collection('system_users').doc(adminUser.uid).set({ email: 'admin@awc.com', role: 'admin', createdAt: new Date().toISOString() });
                    }
                }
            } catch (e) {
                console.log("Demo admin user likely already exists.");
            }
            await auth.signOut();

            const i1 = await safeDb.collection('instructors').add({name: "أحمد علي", spec: "محاسبة", email: "demo.instructor@awc.com"});
            // Courses
            await safeDb.collection('courses').add({name: "محاسبة المطاعم", price: 1200, instructorId: i1.id, instructorName: "أحمد علي"});
            await safeDb.collection('courses').add({name: "محاسبة المقاولات", price: 1500, instructorId: i1.id, instructorName: "أحمد علي"});
            await safeDb.collection('courses').add({name: "تحليل البيانات المالية", price: 2000, instructorId: i1.id, instructorName: "أحمد علي"});
            await safeDb.collection('courses').add({name: "محاسبة المصانع", price: 1800, instructorId: i1.id, instructorName: "أحمد علي"});
            
            // Students
            await safeDb.collection('trainees').add({
                name: "طالب مسجل (أونلاين)", phone: "01000000000", whatsapp: "01000000000", code: "AWC-S-5555",
                service: "محاسبة المقاولات", serviceType: "recorded", country: "Egypt", status: "مفعل",
                payment: {total: 1500, paid: 1500, status: "مدفوع بالكامل"}, 
                platformUser: "AWC-S-5555", platformPass: "secret123", date: new Date().toISOString()
            });
            
            alert(`تم إنشاء البيانات التجريبية!\n\nيمكنك الدخول كمدير باستخدام:\nEmail: admin@awc.com\nPass: 123456\n\nبيانات الطالب المسجل (أونلاين):\nالكود: AWC-S-5555\nالهاتف: 01000000000`);
            window.location.reload();
        }

        // === UI UPDATERS ===
        function updateInstructorsUI() { const h = instructors.map(i=>`<tr class="border-b"><td class="p-2">${i.name}</td><td class="p-2">${i.spec}</td><td class="p-2"><button onclick="deleteItem('instructors','${i.id}')" class="text-red-500">X</button></td></tr>`).join(''); setHTML('instructors-table-body', h); const opts = '<option value="">اختر</option>' + instructors.map(i=>`<option value="${i.id}">${i.name}</option>`).join(''); setHTML('course-instructor', opts); setHTML('lec-instructor-select', opts); }
        function updateCoursesUI() { const h = courses.map(c=>`<tr class="border-b"><td class="p-2">${c.name}</td><td class="p-2">$${c.price}</td><td class="p-2">${c.instructorName}</td><td class="p-2"><button onclick="deleteItem('courses','${c.id}')" class="text-red-500">X</button></td></tr>`).join(''); setHTML('courses-table-body', h); const opts = '<option value="">-- اختر --</option>' + courses.map(c=>`<option value="${c.name}" data-price="${c.price}">${c.name}</option>`).join(''); const opts2 = '<option value="">-- اختر --</option>' + courses.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); setHTML('reg-service', opts); setHTML('lec-course', opts2); }
        function updateTraineesUI() { 
            setText('stat-total-students', trainees.length); 
            setText('stat-consulting', trainees.filter(t=>t.serviceType==='consulting').length); 
            setHTML('trainees-table-body', trainees.slice(0,15).map(t=>`<tr class="border-b"><td class="p-2">${t.name}</td><td class="p-2">${t.service}</td><td class="p-2">${t.status}</td></tr>`).join('')); 
            updateCertificateTraineeSelect();
        }
        function updateTraineesManagementUI() { 
            const term = document.getElementById('trainee-management-search')?.value.toLowerCase()||''; 
            
            let traineesToDisplay = trainees;

            if (currentUserRole === 'instructor' && currentInstructorProfile) {
                const myCourses = courses.filter(c => c.instructorId === currentInstructorProfile.id).map(c => c.name);
                traineesToDisplay = trainees.filter(t => myCourses.includes(t.service));
            } else if (currentUserRole === 'instructor') {
                traineesToDisplay = []; // Instructor profile not found or not loaded, show no students
            }

            const res = traineesToDisplay.filter(t => t.name.toLowerCase().includes(term)||(t.code&&t.code.toLowerCase().includes(term))); 
            
            const canDelete = currentUserRole === 'admin';
            const canEvaluate = currentUserRole === 'instructor';

            setHTML('trainees-management-table-body', res.map(t => {
                let actions = `<button onclick="showTraineeDetails('${t.id}')" class="text-blue-600 hover:text-blue-800" title="عرض التفاصيل"><i class="fas fa-eye"></i></button>`;
                if (canDelete) { actions += `<button onclick="deleteItem('trainees','${t.id}')" class="text-red-500 hover:text-red-700" title="حذف"><i class="fas fa-trash"></i></button>`; }
                if (canEvaluate) { actions += `<button onclick="openEvaluationModal('${t.id}')" class="text-yellow-600 hover:text-yellow-800" title="تقييم الطالب"><i class="fas fa-star"></i></button>`; }
                return `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-mono text-xs">${t.code}</td><td class="p-3 font-bold">${t.name}</td><td class="p-3" dir="ltr">${t.phone}</td><td class="p-3">${t.service}</td><td class="p-3"><span class="px-2 py-1 text-xs rounded ${t.status==='مفعل'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}">${t.status}</span></td><td class="p-3 flex gap-3">${actions}</td></tr>`;
            }).join('')); 
        }
        function updateUsersUI() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;

            const tableBody = systemUsers.map(user => {
                const isSelf = user.id === currentUser.uid;
                const deleteButton = isSelf 
                    ? `<span class="text-gray-400 text-xs">لا يمكن الحذف</span>`
                    : `<button onclick="deleteSystemUser('${user.id}')" class="text-red-500 hover:text-red-700" title="حذف"><i class="fas fa-trash"></i></button>`;

                return `<tr class="border-b">
                    <td class="p-3 text-sm" dir="ltr">${user.email}</td>
                    <td class="p-3 text-sm">${user.role === 'admin' ? 'مدير' : 'مساعد'}</td>
                    <td class="p-3">${deleteButton}</td>
                </tr>`;
            }).join('');
            setHTML('users-table-body', tableBody);
        }
        function updateReportsUI() {
            // Summary Cards
            setText('report-total-students', trainees.length);
            setText('report-consulting-count', trainees.filter(t => t.serviceType === 'consulting').length);
            const completedTrainees = trainees.filter(t => t.payment?.status === 'مدفوع بالكامل').length;
            setText('report-certificates-count', completedTrainees);

            // Financial Stats
            const totalRevenue = trainees.reduce((sum, t) => sum + (t.payment?.total || 0), 0);
            const totalCollected = trainees.reduce((sum, t) => sum + (t.payment?.paid || 0), 0);
            const totalDue = totalRevenue - totalCollected;
            const progressPercentage = totalRevenue > 0 ? (totalCollected / totalRevenue) * 100 : 0;

            setText('report-total-revenue', `$${totalRevenue.toLocaleString()}`);
            setText('report-total-collected', `$${totalCollected.toLocaleString()}`);
            setText('report-total-due', `$${totalDue.toLocaleString()}`);
            
            const progressBar = document.getElementById('report-revenue-progress');
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.textContent = `${Math.round(progressPercentage)}%`;
            }

            // Payment Status Breakdown
            const fullyPaid = trainees.filter(t => t.payment?.status === 'مدفوع بالكامل').length;
            const partiallyPaid = trainees.filter(t => t.payment?.status === 'جزئي').length;
            const unpaid = trainees.filter(t => t.payment?.status === 'غير مدفوع' || !t.payment?.status).length;

            setText('report-fully-paid-count', fullyPaid);
            setText('report-partially-paid-count', partiallyPaid);
            setText('report-unpaid-count', unpaid);

            // Sources Report
            const sources = trainees.reduce((acc, t) => { const source = t.source || 'Unknown'; acc[source] = (acc[source] || 0) + 1; return acc; }, {});
            const totalSources = trainees.length;
            const sourcesContainer = document.getElementById('sources-report-container');
            if (sourcesContainer) {
                if (Object.keys(sources).length > 0) {
                    sourcesContainer.innerHTML = Object.entries(sources).map(([source, count]) => {
                        const percentage = totalSources > 0 ? (count / totalSources) * 100 : 0;
                        const sourceName = { 'Website': 'الموقع الإلكتروني', 'Social': 'سوشيال ميديا', 'Friend': 'ترشيح صديق' }[source] || 'غير معروف';
                        const color = { 'Website': 'bg-blue-500', 'Social': 'bg-purple-500', 'Friend': 'bg-green-500' }[source] || 'bg-gray-500';
                        return `<div class="flex justify-between items-center text-sm"><span class="text-gray-600">${sourceName} (${count})</span><div class="w-2/3 bg-gray-200 rounded-full h-2.5"><div class="${color} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
                    }).join('');
                } else {
                    sourcesContainer.innerHTML = '<p class="text-center text-gray-400">لا توجد بيانات لعرضها.</p>';
                }
            }
            updateInstructorPerformanceReport();
        }
        function updateInstructorPerformanceReport() {
            const reportBody = document.getElementById('instructor-performance-report-body');
            if (!reportBody) return;

            if (instructors.length === 0) {
                reportBody.innerHTML = `<tr><td colspan="3" class="text-center p-6 text-gray-400">لا يوجد مدربين.</td></tr>`;
                return;
            }

            const reportData = instructors.map(instructor => {
                const instructorCourses = courses.filter(c => c.instructorId === instructor.id);
                const instructorCourseNames = instructorCourses.map(c => c.name);
                const lectureCount = lectures.filter(l => instructorCourseNames.includes(l.courseName)).length;
                const studentCount = trainees.filter(t => instructorCourseNames.includes(t.service)).length;
                return { name: instructor.name, studentCount, lectureCount };
            });

            const tableRowsHtml = reportData.map(data => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold">${data.name}</td>
                    <td class="p-3 text-center font-bold text-lg text-primary">${data.studentCount}</td>
                    <td class="p-3 text-center font-bold text-lg text-secondary">${data.lectureCount}</td>
                </tr>`).join('');
            reportBody.innerHTML = tableRowsHtml;

            renderInstructorPerformanceChart(reportData);
        }

        function renderInstructorPerformanceChart(reportData) {
            const ctx = document.getElementById('instructorPerformanceChart')?.getContext('2d');
            if (!ctx) return;

            if (instructorPerformanceChart) {
                instructorPerformanceChart.destroy();
            }

            const labels = reportData.map(d => d.name);
            const studentData = reportData.map(d => d.studentCount);
            const lectureData = reportData.map(d => d.lectureCount);

            instructorPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'عدد الطلاب', data: studentData, backgroundColor: 'rgba(30, 58, 138, 0.7)', borderColor: 'rgba(30, 58, 138, 1)', borderWidth: 1 },
                        { label: 'عدد المحاضرات', data: lectureData, backgroundColor: 'rgba(29, 78, 216, 0.7)', borderColor: 'rgba(29, 78, 216, 1)', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        }
        function updateLecturesUI() {
            setText('stat-total-lectures', lectures.length);

            let myCourses = [];
            if (currentUserRole === 'instructor' && currentInstructorProfile) {
                myCourses = courses.filter(c => c.instructorId === currentInstructorProfile.id).map(c => c.name);
            }

            const lecturesToDisplay = (currentUserRole === 'instructor' && currentInstructorProfile)
                ? lectures.filter(l => myCourses.includes(l.courseName))
                : lectures;

            const up = lecturesToDisplay.filter(l => l.status === 'upcoming');
            const rec = lecturesToDisplay.filter(l => l.status === 'recorded');

            const card = l => {
                const roomName = l.link ? `'${l.link.split('/').pop()}'` : null;
                const lectureTitle = `'${l.title.replace(/'/g, "\\'")}'`;
                let actionButton = '';

                if (currentUserRole === 'instructor') {
                    if (l.status === 'upcoming' && l.link) {
                        actionButton = `<button onclick="startJitsiMeeting(${roomName}, ${lectureTitle})" class="text-white bg-blue-500 px-3 py-1 rounded text-xs shadow hover:bg-blue-600">بدء المحاضرة</button>`;
                    } else if (l.status === 'recorded') {
                        if (l.recordingUrl) {
                            actionButton = `<a href="${l.recordingUrl}" target="_blank" class="text-white bg-green-500 px-3 py-1 rounded text-xs shadow hover:bg-green-600">مشاهدة التسجيل</a>`;
                        } else {
                            actionButton = `
                                <label class="cursor-pointer text-white bg-purple-500 px-3 py-1 rounded text-xs shadow hover:bg-purple-600">
                                    <span>رفع تسجيل</span>
                                    <input type="file" class="hidden" accept="video/*,audio/*" onchange="handleRecordingUpload(event, '${l.id}')">
                                </label>
                            `;
                        }
                    }
                } else { // Admin/Assistant view
                    actionButton = l.link ? `<button onclick="startJitsiMeeting(${roomName}, ${lectureTitle})" class="text-white bg-blue-500 px-3 py-1 rounded text-xs shadow hover:bg-blue-600">بدء/انضمام</button>` : '';
                }

                return `<div class="bg-white border p-3 rounded mb-2 flex justify-between items-center"><div><b>${l.title}</b> <span class="text-xs text-gray-500">${l.courseName}</span><div id="upload-progress-${l.id}" class="text-xs text-blue-600 font-bold"></div></div> ${actionButton}</div>`;
            };
            setHTML('upcoming-lectures-container', up.map(card).join('') || '<p class="text-center text-gray-400">لا يوجد محاضرات قادمة.</p>');
            setHTML('recorded-lectures-container', rec.map(card).join('') || '<p class="text-center text-gray-400">لا يوجد محاضرات في الأرشيف.</p>');
            
            if (document.getElementById('tab-btn-add')) {
                document.getElementById('tab-btn-add').style.display = currentUserRole === 'instructor' ? 'none' : 'flex';
            }
        }
        function handleAttendanceSearch() { const v = document.getElementById('attendance-search-input').value.toLowerCase(); const res = trainees.filter(t=>t.name.toLowerCase().includes(v)||(t.code&&t.code.toLowerCase().includes(v))); setHTML('attendance-results-container', res.map(t=>`<div class="bg-white border p-4 rounded-lg mb-2 flex justify-between items-center hover:shadow-md transition"><div><b>${t.name}</b><br><small>${t.service}</small></div><div><small>مدفوع: ${t.payment?.paid}/${t.payment?.total}</small> ${t.payment?.status!=='مدفوع بالكامل'?`<div class="flex gap-1 mt-1"><input type="number" id="pay-${t.id}" class="border w-20 p-1 text-xs" placeholder="مبلغ"><button onclick="addPayment('${t.id}')" class="bg-green-500 text-white px-2 rounded text-xs">دفع</button></div>`:'<span class="text-green-600 font-bold text-xs">✓</span>'}</div>${t.status!=='مفعل'?`<button onclick="activateT('${t.id}','${t.name}','${t.whatsapp||t.phone}','${t.country}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs">تفعيل</button>`:'<span class="text-gray-400 text-xs">مفعل</span>'}</div>`).join('')); }
        async function addPayment(id) { const v = parseFloat(document.getElementById('pay-'+id).value); if(!v) return; const t = trainees.find(x=>x.id==id); const np = (t.payment.paid||0)+v; await safeDb.collection('trainees').doc(id).update({'payment.paid':np, 'payment.status': np>=t.payment.total?'مدفوع بالكامل':'جزئي'}); showNotification('تم تحديث المدفوعات','success', 'نجاح'); }
        async function activateT(id, n, p, c) {
            const trainee = trainees.find(t => t.id === id);
            if (!trainee) {
                showNotification('خطأ: لم يتم العثور على الطالب.', 'error');
                return;
            }
            const code = trainee.code;
            const loginLink = 'https://samyahmed480.github.io/c1/';

            const msg = `مرحبا، ${n}
تم إنشاء حسابك على منصة أكاديمية AWC لمتابعة الجدول والحضور الأونلاين.

رابط الدخول:
${loginLink}

اسم المستخدم:
${code}

كلمة المرور:
رقم الهاتف

يرجى الاحتفاظ ببيانات الدخول ومتابعة المنصة لمعرفة مواعيد الدروس والتواجد الأونلاين.
*لا تشارك بياناتك مع أحد ، حيث أن إدارة الأكاديمية لا تطلب من المتدربين الإفصاح عن بياناتهم الخاصة باسم المستخدم والباسورد ، فى أى حال من الأحوال *
تم الارسال بواسطة،
AWC Academy`;
            
            await safeDb.collection('trainees').doc(id).update({status:'مفعل'});
            openWhatsApp(formatPhone(c, p), msg);
            showNotification('تم التفعيل بنجاح', 'success', 'نجاح');
            handleAttendanceSearch();
        }
        function handleCertificateSearch() { const v = document.getElementById('certificate-search-input').value.toLowerCase(); const s = trainees.find(t=>t.phone==v || (t.code&&t.code.toLowerCase()==v)); if(s) { if(s.payment?.status==='مدفوع بالكامل') { document.getElementById('certificate-preview-area').classList.remove('hidden'); setText('cert-student-name', s.name); setText('cert-course-name', s.service); setText('cert-code', s.code); setText('cert-date', new Date().toLocaleDateString('ar-EG')); } else alert('يجب سداد الرسوم أولاً'); } }
        function switchLectureTab(t) {
            if (t === 'add') {
                document.getElementById('lecture-tab-add').classList.toggle('hidden');
                return;
            }
            ['upcoming', 'recorded'].forEach(tab => {
                document.getElementById('lecture-tab-' + tab).classList.add('hidden');
                const btn = document.getElementById('tab-btn-' + tab);
                btn.className = "px-4 py-2 text-gray-500 font-semibold";
            });
            document.getElementById('lecture-tab-' + t).classList.remove('hidden');
            const activeBtn = document.getElementById('tab-btn-' + t);
            activeBtn.className = "px-4 py-2 text-blue-600 border-b-2 border-blue-600 font-semibold";
            document.getElementById('lecture-tab-add').classList.add('hidden');
        }
        async function handleAddInstructor(e) {
            e.preventDefault();
            const name = document.getElementById('inst-name').value;
            const spec = document.getElementById('inst-spec').value;
            const email = document.getElementById('inst-email').value;
            const password = document.getElementById('inst-password').value;

            if (currentUserRole !== 'admin') {
                showNotification('ليس لديك الصلاحية لإضافة مدربين.', 'error');
                return;
            }

            try {
                const tempAppName = 'instructor-creation-app-' + Date.now();
                const tempApp = firebase.initializeApp(firebaseConfig, tempAppName);
                const tempAuth = tempApp.auth();
                const userCredential = await tempAuth.createUserWithEmailAndPassword(email, password);
                const newInstructorUser = userCredential.user;

                await db.collection('system_users').doc(newInstructorUser.uid).set({ 
                    email: newInstructorUser.email, role: 'instructor', createdAt: new Date().toISOString() 
                });

                await safeDb.collection('instructors').add({ name, spec, email, uid: newInstructorUser.uid });

                await tempAuth.signOut();
                await tempApp.delete();
                showNotification('تم إنشاء حساب المدرب بنجاح.', 'success');
                e.target.reset();
            } catch (error) {
                console.error("Error creating new instructor:", error);
                showNotification(`خطأ في إنشاء المدرب: ${error.message}`, 'error');
            }
        }
        async function handleAddCourse(e) { e.preventDefault(); const iId=document.getElementById('course-instructor').value; const iName=instructors.find(i=>i.id==iId)?.name; await safeDb.collection('courses').add({name:document.getElementById('course-name').value, price:document.getElementById('course-price').value, instructorId:iId, instructorName:iName}); showNotification('تم','success'); e.target.reset(); }
        async function handleAddLecture(e) {
            e.preventDefault();
            const cId = document.getElementById('lec-course').value;
            const cName = courses.find(c => c.id == cId)?.name;
            const notify = document.getElementById('lec-notify').checked;

            const lectureData = {
                title: document.getElementById('lec-title').value, courseName: cName,
                date: document.getElementById('lec-date').value, time: document.getElementById('lec-time').value,
                link: document.getElementById('lec-link').value, status: 'upcoming', recordingUrl: null,
                notify: notify, notificationSent: false
            };

            await safeDb.collection('lectures').add(lectureData);

            // Automatic notification for new lecture
            const activeStudentsInCourse = trainees.filter(t => t.service === cName && t.status === 'مفعل');
            if (activeStudentsInCourse.length > 0) {
                const doSend = confirm(`تمت إضافة المحاضرة بنجاح.\n\nهل تريد إرسال إشعار فوري للطلاب المسجلين في هذا الكورس؟ (العدد: ${activeStudentsInCourse.length})`);
                if (doSend) {
                    const message = `📢 *محاضرة جديدة* 📢\n\nتمت إضافة محاضرة جديدة لكورس "${cName}".\n\n*المحاضرة:* ${lectureData.title}\n*التاريخ:* ${lectureData.date}\n*الوقت:* ${lectureData.time}\n\nيمكنك متابعة التفاصيل من خلال بوابة الطالب.\n\nبالتوفيق!`;
                    activeStudentsInCourse.forEach((student, index) => {
                        setTimeout(() => {
                            const phone = formatPhone(student.country, student.whatsapp || student.phone);
                            openWhatsApp(phone, message);
                        }, index * 500);
                    });
                    showNotification(`جاري إرسال ${activeStudentsInCourse.length} إشعار...`, 'info');
                }
            }

            showNotification('تمت إضافة المحاضرة بنجاح', 'success');
            e.target.reset();
            switchLectureTab('upcoming');
        }
        async function deleteItem(col, id) { if(confirm('حذف؟')) await safeDb.collection(col).doc(id).delete(); }
        async function handleCertificateUpload(e) {
            e.preventDefault();
            const traineeId = document.getElementById('cert-trainee-select').value;
            const file = document.getElementById('cert-file-upload').files[0];

            if (!traineeId || !file) {
                showNotification('الرجاء اختيار طالب ورفع ملف الشهادة.', 'error');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';

            try {
                const filePath = `certificates/${traineeId}/${file.name}`;
                const storageRef = storage.ref(filePath);
                const uploadTask = await storageRef.put(file);
                const downloadURL = await uploadTask.ref.getDownloadURL();

                await safeDb.collection('trainees').doc(traineeId).update({ certificateUrl: downloadURL });

                showNotification('تم رفع الشهادة وتعيينها للطالب بنجاح.', 'success');
                e.target.reset();
            } catch (error) {
                console.error("Error uploading certificate:", error);
                showNotification('حدث خطأ أثناء رفع الشهادة.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-upload"></i> رفع وتعيين الشهادة';
            }
        }
        async function handleRecordingUpload(event, lectureId) {
            const file = event.target.files[0];
            if (!file) return;

            const progressEl = document.getElementById(`upload-progress-${lectureId}`);
            const labelEl = event.target.parentElement;

            if (!progressEl || !labelEl) return;

            labelEl.style.display = 'none'; // Hide button
            progressEl.textContent = 'جاري الرفع... 0%';

            try {
                const filePath = `recordings/${lectureId}/${file.name}`;
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressEl.textContent = `جاري الرفع... ${Math.round(progress)}%`;
                    }, 
                    (error) => {
                        console.error("Upload failed:", error);
                        showNotification('فشل رفع التسجيل.', 'error');
                        labelEl.style.display = 'inline-block'; // Show button again
                        progressEl.textContent = '';
                    }, 
                    async () => {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        await safeDb.collection('lectures').doc(lectureId).update({ recordingUrl: downloadURL });
                        progressEl.textContent = 'تم الرفع بنجاح!';
                    }
                );
            } catch (error) {
                console.error("Error uploading recording:", error);
                showNotification('حدث خطأ أثناء رفع التسجيل.', 'error');
            }
        }
        function openEvaluationModal(traineeId) {
            const trainee = trainees.find(t => t.id === traineeId);
            if (!trainee) return;
            document.getElementById('eval-trainee-id').value = traineeId;
            setText('eval-student-name', trainee.name);
            document.getElementById('evaluation-modal').classList.remove('hidden');
        }

        function closeEvaluationModal() {
            document.getElementById('evaluation-modal').classList.add('hidden');
            document.getElementById('evaluation-form').reset();
        }

        async function handleStudentEvaluation(e) {
            e.preventDefault();
            const traineeId = document.getElementById('eval-trainee-id').value;
            const rating = document.getElementById('eval-rating').value;
            const comment = document.getElementById('eval-comment').value;

            if (!traineeId || !rating || !currentInstructorProfile) {
                showNotification('بيانات غير مكتملة أو أنك لست مدرباً.', 'error');
                return;
            }

            const trainee = trainees.find(t => t.id === traineeId);
            if (!trainee) return;

            const evaluationData = {
                instructorId: currentInstructorProfile.id,
                instructorName: currentInstructorProfile.name,
                courseName: trainee.service,
                rating: parseInt(rating),
                comment: comment,
                date: new Date().toISOString()
            };

            try {
                await safeDb.collection('trainees').doc(traineeId).update({
                    evaluations: firebase.firestore.FieldValue.arrayUnion(evaluationData)
                });
                showNotification('تم حفظ التقييم بنجاح.', 'success');
                closeEvaluationModal();
            } catch (error) {
                console.error("Error saving evaluation:", error);
                showNotification('حدث خطأ أثناء حفظ التقييم. قد تحتاج لإضافة حقل التقييمات أولاً.', 'error');
            }
        }

        function updateEvaluationsUI() {
            const tableBody = document.getElementById('evaluations-table-body');
            if (!tableBody) return;
            let allEvaluations = [];
            trainees.forEach(t => { if (t.evaluations && Array.isArray(t.evaluations)) { t.evaluations.forEach(ev => allEvaluations.push({ studentName: t.name, ...ev })); } });
            allEvaluations.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (allEvaluations.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-gray-400">لا توجد تقييمات حالياً.</td></tr>`; return; }
            tableBody.innerHTML = allEvaluations.map(eval => `
                <tr class="border-b hover:bg-gray-50"><td class="p-3 font-bold">${eval.studentName}</td><td class="p-3 text-sm">${eval.courseName}</td><td class="p-3 text-sm">${eval.instructorName}</td><td class="p-3 text-center font-bold text-lg ${eval.rating >= 7 ? 'text-green-600' : (eval.rating >= 4 ? 'text-yellow-600' : 'text-red-600')}">${eval.rating}/10</td><td class="p-3 text-sm text-gray-600">${eval.comment || 'لا يوجد'}</td><td class="p-3 text-xs text-gray-500">${new Date(eval.date).toLocaleDateString('ar-EG')}</td></tr>
            `).join('');
        }
        function showNotification(m,t,title='تنبيه') { setText('notification-title', title); setText('notification-message', m); document.getElementById('notification-modal').classList.remove('hidden'); }
        function closeNotification() { document.getElementById('notification-modal').classList.add('hidden'); }
        async function handleAddNewUser(e) {
            e.preventDefault();
            if (currentUserRole !== 'admin') {
                showNotification('ليس لديك الصلاحية لإضافة مستخدمين.', 'error');
                return;
            }

            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;

            if (role === 'instructor') {
                showNotification('لإضافة مدرب، يرجى استخدام صفحة "إدارة المدربين" لإنشاء حساب متكامل.', 'error');
                return;
            }

            try {
                const tempAppName = 'user-creation-app-' + Date.now();
                const tempApp = firebase.initializeApp(firebaseConfig, tempAppName);
                const tempAuth = tempApp.auth();
                const userCredential = await tempAuth.createUserWithEmailAndPassword(email, password);
                const newUser = userCredential.user;
                await db.collection('system_users').doc(newUser.uid).set({ email: newUser.email, role: role, createdAt: new Date().toISOString() });
                await tempAuth.signOut();
                await tempApp.delete();
                showNotification('تم إنشاء المستخدم بنجاح.', 'success');
                e.target.reset();
            } catch (error) {
                console.error("Error creating new user:", error);
                showNotification(`خطأ في إنشاء المستخدم: ${error.message}`, 'error');
            }
        }
        async function deleteSystemUser(uid) {
            if (currentUserRole !== 'admin') { showNotification('ليس لديك الصلاحية للحذف.', 'error'); return; }
            if (confirm(`هل أنت متأكد؟\nسيتم حذف صلاحيات المستخدم. يجب حذفه من Firebase Console بشكل كامل.`)) {
                try { await db.collection('system_users').doc(uid).delete(); showNotification('تم حذف صلاحيات المستخدم.', 'success'); } 
                catch (error) { showNotification('حدث خطأ.', 'error'); }
            }
        }
        function updateCertificateTraineeSelect() {
            const selectEl = document.getElementById('cert-trainee-select');
            if (!selectEl) return;
            const options = trainees
                .filter(t => t.payment?.status === 'مدفوع بالكامل')
                .map(t => `<option value="${t.id}">${t.name} - ${t.service} (${t.code})</option>`)
                .join('');
            selectEl.innerHTML = `<option value="">-- اختر طالب مكتمل السداد --</option>${options}`;
        }
    </script>
</body>
</html>
