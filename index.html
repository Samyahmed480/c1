<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العملاء - CRP </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fc; /* Light background typical of modern dashboards */
        }
        
        .dark body {
            background-color: #0f172a;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        /* Input Styles matching the reference images */
        .form-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.6rem 1rem;
            font-size: 1rem; /* Prevent zoom on mobile */
            transition: all 0.2s;
            outline: none;
            background-color: #ffffff;
        }
        .form-input:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        @media (min-width: 768px) {
            .form-input {
                font-size: 0.875rem;
            }
        }
        
        /* Dark Mode for Inputs */
        .dark .form-input {
            background-color: #1e293b;
            border-color: #334155;
            color: #f1f5f9;
        }
        .dark .form-input:focus {
            border-color: #60a5fa;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.25rem;
        }
        .dark .form-label {
            color: #94a3b8;
        }

        /* Upload Zone Style */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            transition: all 0.2s;
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .dark .upload-zone {
            background-color: #1e293b;
            border-color: #334155;
        }
        .dark .upload-zone:hover {
            background-color: #334155;
            border-color: #60a5fa;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scaleIn {
            animation: scaleIn 0.2s ease-out forwards;
        }
        
        .active-nav-item {
            background-color: #1a4b82;
            color: white;
            border-right: 4px solid #e5b57f;
        }
        .inactive-nav-item {
            color: #dbeafe; /* blue-100 */
            border-right: 4px solid transparent;
        }
        .inactive-nav-item:hover {
            background-color: #0a2342;
            color: white;
        }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden dark:text-slate-100">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-[#0f3057] text-white w-64 flex-shrink-0 flex flex-col transition-all duration-300 shadow-2xl z-50 h-full md:relative fixed top-0 right-0 transform translate-x-full md:translate-x-0">
        <div class="p-6 flex flex-col items-center border-b border-blue-900/50 relative">
            <!-- Mobile Close Button -->
            <button onclick="toggleSidebar()" class="md:hidden absolute top-4 left-4 text-blue-300 hover:text-white transition-colors p-1 rounded-full hover:bg-white/10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <!-- Logo -->
            <div id="company-logo-container" class="w-20 h-20 mb-3 bg-[#fdf6e7] rounded-2xl flex items-center justify-center shadow-lg relative overflow-hidden transform rotate-3 hover:rotate-0 transition-transform duration-300">
                <svg viewBox="0 0 100 100" class="w-full h-full p-1">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            </div>
            <h1 id="company-name-display" class="text-lg font-bold tracking-wider text-center font-sans">IN ONE OPERATION</h1>
            <p id="company-subtitle-display" class="text-[10px] text-blue-200 mt-1 uppercase tracking-widest opacity-80">System Management</p>
        </div>

        <nav class="flex-1 px-3 space-y-2 md:space-y-1.5 mt-6 overflow-y-auto custom-scrollbar">
            <!-- Navigation Items -->
            <button onclick="switchTab('registration')" id="nav-registration" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 active-nav-item group">
                <i data-lucide="user-check" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">تسجيل العملاء</span>
            </button>
            <button onclick="switchTab('measurements')" id="nav-measurements" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="ruler" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">أخذ المقاسات</span>
            </button>
            <button onclick="switchTab('design')" id="nav-design" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="pen-tool" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">التصميم</span>
            </button>
            <button onclick="switchTab('pricing')" id="nav-pricing" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="calculator" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">التسعير التفصيلي</span>
            </button>
            <button onclick="switchTab('installation')" id="nav-installation" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="hammer" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">مرحلة التركيب</span>
            </button>
            <button onclick="switchTab('completed')" id="nav-completed" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="archive" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">المشاريع المنتهية</span>
            </button>
            
            <div class="my-3 border-t border-blue-800/30 mx-2"></div>
            
            <button onclick="switchTab('offers')" id="nav-offers" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="file-text" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">العروض والفواتير</span>
            </button>
            <button onclick="switchTab('financials')" id="nav-financials" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="wallet" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">المتابعة المالية</span>
            </button>
            <button onclick="switchTab('accounts')" id="nav-accounts" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="landmark" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">الحسابات والمصروفات</span>
            </button>
            <button onclick="switchTab('reports')" id="nav-reports" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">التقارير</span>
            </button>
            <button onclick="switchTab('users')" id="nav-users" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="users" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">إدارة المستخدمين</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3.5 md:py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="settings" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-base md:text-sm">الإعدادات</span>
            </button>
        </nav>

        <!-- User Profile -->
        <div class="p-4 bg-[#0a2342]/80 backdrop-blur-sm mt-auto border-t border-blue-800/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center font-bold text-white shadow-md border border-white/10 relative">
                    خ
                    <span id="role-indicator" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-400 border-2 border-[#0a2342] rounded-full"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate" id="user-name">خالد رمزي</p>
                    <p class="text-[10px] text-blue-300 truncate" id="user-role">مدير النظام</p>
                </div>
                <button onclick="toggleRole()" class="text-blue-300 hover:text-white p-1.5 rounded-lg hover:bg-white/10 transition-colors" title="تبديل الصلاحية">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full bg-[#f8f9fc] dark:bg-slate-900 transition-colors">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 shadow-sm min-h-16 h-auto py-2 md:py-0 flex flex-wrap md:flex-nowrap items-center justify-between px-4 md:px-6 z-30 sticky top-0 border-b border-slate-100 dark:border-slate-700 transition-colors gap-y-2">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 dark:text-slate-400 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="relative w-full md:w-auto md:flex-1 max-w-lg order-3 md:order-none group">
                <i data-lucide="search" class="absolute right-3 top-2.5 h-5 w-5 text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
                <input type="text" id="global-search" oninput="handleSearch(this.value)" placeholder="ابحث باسم العميل، رقم الهاتف، أو الكود..." 
                    class="w-full pr-10 pl-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:bg-white dark:focus:bg-slate-600 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 rounded-full text-sm transition-all outline-none text-slate-600 dark:text-slate-200 placeholder-slate-400">
            </div>

            <div class="flex items-center gap-3 order-2 md:order-none ml-auto md:ml-0">
                <button onclick="toggleDarkMode()" class="relative p-2.5 text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700 hover:text-blue-600 rounded-full transition-all" title="الوضع الليلي">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>

                <button onclick="resetData()" class="text-red-500 text-xs hover:bg-red-50 px-3 py-1.5 rounded-full transition-colors hidden md:block font-medium">إعادة تعيين</button>
                
                <button class="relative p-2.5 text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700 hover:text-blue-600 rounded-full transition-all">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                
                <button onclick="switchTab('registration')" class="hidden md:flex items-center gap-2 text-xs px-4 py-2 bg-[#0f3057] text-white rounded-lg hover:bg-[#1a4b82] transition shadow-sm hover:shadow active:scale-95 font-bold">
                    <i data-lucide="plus" class="w-4 h-4"></i> إضافة عميل
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 animate-fadeIn scroll-smooth">
            <!-- Content will be injected via JS -->
        </div>
    </main>

    <!-- Floating Client Button -->
    <button id="floating-client-btn" onclick="openCurrentClientModal()" class="fixed bottom-6 left-6 z-40 bg-[#0f3057] text-white p-3 pl-5 rounded-full shadow-2xl hover:bg-[#1a4b82] transition-all duration-300 hidden items-center gap-3 group animate-fadeIn border-2 border-white/10">
        <div class="text-right">
            <p class="text-[10px] text-blue-200 font-normal leading-tight">العميل الحالي</p>
            <p id="floating-client-name" class="text-sm font-bold leading-tight">اسم العميل</p>
        </div>
        <div class="relative bg-white/10 p-2 rounded-full group-hover:bg-white/20 transition-colors">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span class="absolute top-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-[#0f3057] rounded-full"></span>
        </div>
    </button>

    <!-- Client Detail Modal -->
    <div id="clientModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <!-- Modal content injected via JS -->
    </div>

    <!-- Edit Client Modal -->
    <div id="editClientModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- Data & Constants ---
        let users = [
            { id: 1, name: 'خالد رمزي', role: 'admin', username: 'admin', password: '123' },
            { id: 2, name: 'أحمد مندوب', role: 'sales', username: 'sales', password: '123' }
        ];

        let companySettings = {
            name: 'IN ONE OPERATION',
            subtitle: 'System Management',
            address: 'المملكة العربية السعودية - الرياض',
            phone: '920000000',
            email: 'info@inone.sa',
            taxId: '300000000000003',
            taxRate: '15',
            contractTerms: '',
            logo: '',
            currency: 'SAR'
        };

        let currentUser = users[0]; // Start as Admin

        const INITIAL_CLIENTS = [
            { 
                id: 1, code: 'BK-5464', name: 'أحمد محمد', phone: '0501234567', 
                email: 'ahmed@email.com', address: 'الرياض - حي العليا', type: 'شركات',
                source: 'social', status: 'potential', employeeId: 1,
                projectDetails: { kitchen: 1, bedroom: 2, cladding: 0, doors: 5, vanity: 2, tvUnit: 1 },
                measurements: { status: 'pending', date: '', files: [] },
                design: { status: 'pending', total: 0, firstPayment: 0, offerApproved: false, contractSigned: false },
                designImages: [],
                quotationItems: [],
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                logs: [
                    { date: '2023-10-01', type: 'system', text: 'تم تسجيل العميل' },
                    { date: '2023-10-02', type: 'whatsapp', text: 'تم إرسال رسالة ترحيب' }
                ],
                invoices: []
            },
            { 
                id: 2, code: 'LD-9383', name: 'سارة علي', phone: '0559876543', 
                email: 'sara@email.com', address: 'جدة - الروضة', type: 'أفراد',
                source: 'referral', status: 'design', employeeId: 2,
                projectDetails: { kitchen: 1, bedroom: 0, cladding: 10, doors: 0, vanity: 3, tvUnit: 1 },
                measurements: { status: 'completed', date: '2025-02-15', files: ['croquis.pdf'] },
                design: { status: 'waiting_approval', total: 55000, firstPayment: 20000, offerApproved: true, contractSigned: false },
                designImages: [],
                quotationItems: [
                    { name: 'أعمال تجليد خشب', qty: 10, price: 2500 },
                    { name: 'وحدة تلفاز', qty: 1, price: 5000 },
                    { name: 'خزائن ملابس', qty: 3, price: 8333.33 }
                ],
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                logs: [
                     { date: '2023-10-05', type: 'system', text: 'تم رفع المقاسات' }
                ],
                invoices: [
                    { id: 101, date: '2025-02-20', amount: 20000, status: 'paid', type: 'دفعة أولى' }
                ]
            }
        ];

        const USER_ROLES = {
            admin: 'آدمن',
            sales: 'موظف مبيعات',
            measure_eng: 'مهندس رفع المقاسات',
            design_eng: 'مهندس التصميم',
            pricing: 'موظف التسعير',
            install_eng: 'مهندس التركيب',
            supervisor: 'مشرف'
        };

        const STATUS_OPTIONS = [
            { id: 'new', label: 'جديد', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { id: 'potential', label: 'محتمل', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
            { id: 'measurements', label: 'جاري القياس', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { id: 'design', label: 'مرحلة التصميم', color: 'bg-indigo-100 text-indigo-700 border-indigo-200' },
            { id: 'installation', label: 'مرحلة التركيب', color: 'bg-orange-100 text-orange-700 border-orange-200' },
            { id: 'completed', label: 'مكتمل', color: 'bg-green-100 text-green-700 border-green-200' },
            { id: 'rejected', label: 'مرفوض', color: 'bg-red-100 text-red-700 border-red-200' },
        ];

        const EXPENSE_CATEGORIES = [
            { id: 'rent', label: 'إيجارات', icon: 'building' },
            { id: 'salaries', label: 'رواتب وأجور', icon: 'users' },
            { id: 'bills', label: 'فواتير وخدمات', icon: 'zap' },
            { id: 'materials', label: 'مشتريات ومواد', icon: 'shopping-cart' },
            { id: 'marketing', label: 'تسويق وإعلانات', icon: 'megaphone' },
            { id: 'maintenance', label: 'صيانة وتشغيل', icon: 'wrench' },
            { id: 'other', label: 'نثريات أخرى', icon: 'more-horizontal' }
        ];

        // --- State Management ---
        let clients = [];
        let activeTab = 'registration';
        let searchQuery = '';
        let statusFilter = 'all'; // For Registration View
        
        // Active Selections
        let selectedClientId = null;
        let selectedClientForDesignId = null;
        let selectedClientForPricingId = null;
        let selectedClientForInstallId = null;
        let currentActiveClientId = null;

        let newClientForm = {
            code: generateCode(),
            name: '', phone: '', whatsapp: '', email: '', address: '', location: '', 
            type: 'أفراد', source: 'social', taxId: '', clientStatus: 'potential',
            projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 },
            customProjects: [], // For companies
            notes: '',
            measureRequest: { date: '', time: '', isPaid: false, amount: 0 }
        };

        let expenses = [
            { id: 1, category: 'rent', amount: 15000, date: '2025-01-01', description: 'إيجار المعرض - ربع سنوي' },
            { id: 2, category: 'salaries', amount: 8500, date: '2025-01-25', description: 'رواتب شهر يناير' },
            { id: 3, category: 'bills', amount: 1200, date: '2025-02-02', description: 'فاتورة كهرباء' }
        ];

        // --- Initialization ---
        function init() {
            loadClients();
            loadExpenses();
            loadUsers();
            loadSettings();
            initDarkMode();
            render();
            lucide.createIcons();
        }

        function loadClients() {
            const saved = localStorage.getItem('crm_clients_data');
            clients = saved ? JSON.parse(saved) : INITIAL_CLIENTS;
        }

        function saveClients() {
            try {
                localStorage.setItem('crm_clients_data', JSON.stringify(clients));
                render();
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    alert('عذراً، ذاكرة التخزين ممتلئة! لا يمكن حفظ المزيد من الصور أو الفيديوهات. يرجى حذف بعض الملفات القديمة.');
                } else {
                    alert('حدث خطأ أثناء الحفظ: ' + e.message);
                }
            }
        }

        function loadExpenses() {
            const saved = localStorage.getItem('crm_expenses');
            if(saved) expenses = JSON.parse(saved);
        }

        function saveExpenses() {
            localStorage.setItem('crm_expenses', JSON.stringify(expenses));
            render();
        }

        function loadUsers() {
            const saved = localStorage.getItem('crm_users');
            if(saved) users = JSON.parse(saved);
            if(!currentUser) currentUser = users[0];
        }

        function saveUsers() {
            localStorage.setItem('crm_users', JSON.stringify(users));
            render();
        }

        function loadSettings() {
            const saved = localStorage.getItem('crm_settings');
            if(saved) companySettings = JSON.parse(saved);
            updateSidebarInfo();
        }

        function saveSettingsData() {
            localStorage.setItem('crm_settings', JSON.stringify(companySettings));
            updateSidebarInfo();
            alert('تم حفظ الإعدادات بنجاح');
        }

        function updateSidebarInfo() {
            document.getElementById('company-name-display').textContent = companySettings.name;
            document.getElementById('company-subtitle-display').textContent = companySettings.subtitle;
            const logoContainer = document.getElementById('company-logo-container');
            if(companySettings.logo) logoContainer.innerHTML = `<img src="${companySettings.logo}" class="w-full h-full object-cover">`;
        }

        function initDarkMode() {
            if (localStorage.getItem('crm_dark_mode') === 'true' || (!('crm_dark_mode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('crm_dark_mode', isDark);
        }

        function generateCode() { return 'BK-' + Math.floor(1000 + Math.random() * 9000); }

        function toggleRole() {
            const currentIndex = users.findIndex(u => u.id === currentUser.id);
            const nextIndex = (currentIndex + 1) % users.length;
            currentUser = users[nextIndex];
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = USER_ROLES[currentUser.role];
            document.getElementById('role-indicator').className = `absolute bottom-0 right-0 w-2.5 h-2.5 border-2 border-[#0a2342] rounded-full ${currentUser.role === 'admin' ? 'bg-green-400' : 'bg-yellow-400'}`;
            render();
        }

        function getVisibleClients() {
            let filtered = clients;
            if (currentUser.role !== 'admin') {
                filtered = filtered.filter(c => c.employeeId === currentUser.id);
            }
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || c.phone.includes(q) || c.code.toLowerCase().includes(q));
            }
            if (activeTab === 'registration' && statusFilter !== 'all') {
                filtered = filtered.filter(c => c.status === statusFilter);
            }
            return filtered;
        }

        function switchTab(tabName) {
            activeTab = tabName;
            
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active-nav-item');
                btn.classList.add('inactive-nav-item');
                const icon = btn.querySelector('i') || btn.querySelector('svg');
                if(icon) {
                    icon.classList.remove('text-[#e5b57f]'); // Remove active color if any
                    icon.classList.add('opacity-70');
                }
            });

            const activeBtn = document.getElementById(`nav-${tabName}`);
            if (activeBtn) {
                activeBtn.classList.remove('inactive-nav-item');
                activeBtn.classList.add('active-nav-item');
                const activeIcon = activeBtn.querySelector('i') || activeBtn.querySelector('svg');
                if(activeIcon) {
                    activeIcon.classList.remove('opacity-70');
                    activeIcon.classList.add('text-[#e5b57f]');
                }
            }
            
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }

            render();
        }

        function handleSearch(val) {
            searchQuery = val;
            render();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('translate-x-full')) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function resetData() {
            if(confirm('هل أنت متأكد؟ سيتم حذف جميع البيانات والعودة للوضع الافتراضي.')) {
                clients = INITIAL_CLIENTS;
                saveClients();
                location.reload();
            }
        }

        // --- Render Views ---

        function render() {
            const container = document.getElementById('content-area');
            const visibleClients = getVisibleClients();
            
            let html = '';
            
            if (activeTab === 'registration') {
                html = renderRegistrationView(visibleClients);
            } else if (activeTab === 'measurements') {
                html = renderMeasurementsView(visibleClients);
            } else if (activeTab === 'design') {
                html = renderDesignView(visibleClients);
            } else if (activeTab === 'pricing') {
                html = renderPricingView(visibleClients);
            } else if (activeTab === 'installation') {
                html = renderInstallationView(visibleClients);
            } else if (activeTab === 'completed') {
                html = renderCompletedProjectsView(visibleClients);
            } else if (activeTab === 'offers') {
                html = renderOffersView(visibleClients);
            } else if (activeTab === 'financials') {
                html = renderFinancialsView(visibleClients);
            } else if (activeTab === 'accounts') {
                html = renderAccountsView(visibleClients);
            } else if (activeTab === 'users') {
                html = renderUsersView();
            } else if (activeTab === 'reports') {
                html = renderReportsView(clients);
            } else if (activeTab === 'settings') {
                html = renderSettingsView();
            }

            container.innerHTML = html;
            lucide.createIcons();
            attachInputListeners();
            updateFloatingButton();

            if (activeTab === 'reports') {
                initReportsCharts();
            }
        }

        // 1. Registration View
        function renderRegistrationView(data) {
            return `
                <div class="space-y-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        ${renderStatCard('إجمالي العملاء', data.length, 'users', 'bg-gradient-to-br from-blue-500 to-blue-600', 'text-white')}
                        ${renderStatCard('مشاريع نشطة', data.filter(c => !['new','completed','rejected'].includes(c.status)).length, 'briefcase', 'bg-white', 'text-slate-800', 'border-l-4 border-yellow-500')}
                        ${renderStatCard('مشاريع مكتملة', data.filter(c => c.status === 'completed').length, 'check-circle', 'bg-white', 'text-slate-800', 'border-l-4 border-green-500')}
                        ${renderStatCard('جديد هذا الشهر', data.filter(c => c.status === 'new').length, 'star', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <!-- Add Client Form Card -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 relative overflow-hidden transition-colors">
                        <div class="absolute top-0 right-0 w-2 h-full bg-blue-600"></div>
                        <div class="mb-6 flex justify-between items-center border-b border-slate-100 dark:border-slate-700 pb-4">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i data-lucide="user-plus" class="text-blue-600 w-6 h-6"></i>
                                بيانات العميل الجديد
                            </h2>
                            <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">ID: ${newClientForm.code}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-6">
                            <div class="space-y-1">
                                <label class="form-label">الاسم الكامل <span class="text-red-500">*</span></label>
                                <input type="text" id="in-name" value="${newClientForm.name}" class="form-input" placeholder="اسم العميل...">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رقم الجوال <span class="text-red-500">*</span></label>
                                <input type="text" id="in-phone" value="${newClientForm.phone}" class="form-input text-left dir-ltr font-mono" placeholder="05xxxxxxxx">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رقم واتساب</label>
                                <input type="text" id="in-whatsapp" value="${newClientForm.whatsapp}" class="form-input text-left dir-ltr font-mono" placeholder="05xxxxxxxx">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">نوع العميل</label>
                                <select id="in-type" class="form-input bg-white dark:bg-slate-700">
                                    <option ${newClientForm.type === 'أفراد' ? 'selected' : ''}>أفراد</option>
                                    <option ${newClientForm.type === 'شركات' ? 'selected' : ''}>شركات</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" id="in-email" value="${newClientForm.email}" class="form-input" placeholder="example@mail.com">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">المصدر</label>
                                <select id="in-source" class="form-input bg-white dark:bg-slate-700">
                                    <option value="social" ${newClientForm.source === 'social' ? 'selected' : ''}>سوشيال ميديا</option>
                                    <option value="showroom" ${newClientForm.source === 'showroom' ? 'selected' : ''}>زيارة المعرض</option>
                                    <option value="website" ${newClientForm.source === 'website' ? 'selected' : ''}>موقع الكترونى</option>
                                    <option value="referral" ${newClientForm.source === 'referral' ? 'selected' : ''}>عن طريق صديق</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">الرقم الضريبي</label>
                                <input type="text" id="in-tax" value="${newClientForm.taxId}" class="form-input font-mono" placeholder="الرقم الضريبي للعميل">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">حالة العميل</label>
                                <select id="in-status" class="form-input bg-white dark:bg-slate-700">
                                    <option value="potential" ${newClientForm.clientStatus === 'potential' ? 'selected' : ''}>محتمل</option>
                                    <option value="interested" ${newClientForm.clientStatus === 'interested' ? 'selected' : ''}>مهتم</option>
                                    <option value="inquiry" ${newClientForm.clientStatus === 'inquiry' ? 'selected' : ''}>استفسار</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رابط اللوكيشن</label>
                                <input type="url" id="in-location" value="${newClientForm.location}" class="form-input text-left dir-ltr" placeholder="https://maps.google.com/...">
                            </div>
                            <div class="md:col-span-3 space-y-1">
                                <label class="form-label">العنوان</label>
                                <input type="text" id="in-address" value="${newClientForm.address}" class="form-input" placeholder="المدينة، الحي...">
                            </div>
                        </div>

                        <!-- Project Details Counter -->
                        <div class="bg-slate-50 dark:bg-slate-900 p-5 rounded-xl border border-dashed border-slate-300 dark:border-slate-600 mb-6">
                            <label class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-4 block flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4 text-blue-500"></i> تفاصيل المشروع المطلوبة:
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 pb-6 border-b border-slate-200 dark:border-slate-700 border-dashed">
                                ${renderCounter('مطبخ', 'kitchen')}
                                ${renderCounter('غرفة نوم', 'bedroom')}
                                ${renderCounter('تجليد', 'cladding')}
                                ${renderCounter('وحدة TV', 'tvUnit')}
                                ${renderCounter('أبواب', 'doors')}
                                ${renderCounter('خزائن', 'vanity')}
                            </div>
                            <div class="space-y-3">
                                <label class="text-xs font-bold text-slate-500 dark:text-slate-400 block">بنود مخصصة (إضافة يدوية)</label>
                                <div class="flex gap-2 items-end">
                                    <div class="flex-1">
                                        <label class="text-xs text-slate-500 mb-1 block">اسم البند</label>
                                        <input type="text" id="comp-item-name" class="form-input" placeholder="مثال: مكتبة، دولاب..">
                                    </div>
                                    <div class="w-24">
                                        <label class="text-xs text-slate-500 mb-1 block">العدد</label>
                                        <input type="number" id="comp-item-qty" class="form-input" placeholder="0">
                                    </div>
                                    <button onclick="addCompanyItem()" class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 transition-colors h-[42px] w-[42px] flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                </div>
                                <div class="space-y-2 mt-3">
                                    ${newClientForm.customProjects.map((item, idx) => `
                                        <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                                            <span class="font-medium text-slate-700 dark:text-slate-200">${item.name}</span>
                                            <div class="flex items-center gap-4">
                                                <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">العدد: ${item.qty}</span>
                                                <button onclick="removeCompanyItem(${idx})" class="text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${newClientForm.customProjects.length === 0 ? '<p class="text-sm text-slate-400 text-center py-2 italic">لم يتم إضافة بنود بعد</p>' : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Measurement Request Section -->
                        <div class="bg-blue-50/50 dark:bg-blue-900/20 p-5 rounded-xl border border-blue-100 dark:border-blue-800 mb-6">
                            <label class="text-sm font-bold text-blue-800 mb-4 block flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-4 h-4 text-blue-600"></i> طلب رفع مقاسات (اختياري):
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">تاريخ الزيارة</label>
                                    <input type="date" id="in-measure-date" value="${newClientForm.measureRequest.date}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">الوقت</label>
                                    <input type="time" id="in-measure-time" value="${newClientForm.measureRequest.time}" class="form-input">
                                </div>
                                <div class="flex items-center gap-2 h-[42px] bg-white dark:bg-slate-700 px-3 rounded-lg border border-slate-200 dark:border-slate-600">
                                    <input type="checkbox" id="in-measure-paid" onchange="togglePaidAmount()" ${newClientForm.measureRequest.isPaid ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                                    <label for="in-measure-paid" class="text-sm text-slate-700 dark:text-slate-200 cursor-pointer select-none">مدفوع؟</label>
                                </div>
                                <div id="measure-amount-div" class="space-y-1 ${newClientForm.measureRequest.isPaid ? '' : 'hidden'}">
                                    <label class="text-xs font-bold text-slate-500">المبلغ</label>
                                    <input type="number" id="in-measure-amount" value="${newClientForm.measureRequest.amount}" class="form-input" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-6">
                            <label class="form-label">ملاحظات أخرى</label>
                            <textarea id="in-notes" class="form-input h-24 resize-none" placeholder="أي تفاصيل إضافية...">${newClientForm.notes}</textarea>
                        </div>

                        <div class="flex flex-wrap gap-3 justify-end border-t border-slate-100 dark:border-slate-700 pt-4">
                            <button onclick="notifyClient()" class="bg-green-600 text-white px-6 py-2.5 rounded-lg hover:bg-green-700 flex items-center gap-2 shadow-lg shadow-green-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> إشعار العميل
                            </button>
                            <button onclick="sendToMeasurements()" class="bg-purple-600 text-white px-6 py-2.5 rounded-lg hover:bg-purple-700 flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="ruler" class="w-4 h-4"></i> إرسال لرفع المقاسات
                            </button>
                            <button onclick="saveNewClient()" class="bg-[#0f3057] text-white px-8 py-2.5 rounded-lg hover:bg-[#1a4b82] flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="save" class="w-4 h-4"></i> حفظ البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Clients Table -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                <i data-lucide="list" class="w-5 h-5 text-slate-400"></i> سجل العملاء
                            </h3>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-1 rounded-full font-bold">${data.length} عميل</span>
                        </div>
                        
                        <!-- Filters -->
                        <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex gap-2 overflow-x-auto custom-scrollbar">
                            <button onclick="setStatusFilter('all')" class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${statusFilter === 'all' ? 'bg-[#0f3057] text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">الكل</button>
                            <button onclick="setStatusFilter('potential')" class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${statusFilter === 'potential' ? 'bg-yellow-500 text-white' : 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100'}">محتمل</button>
                            <button onclick="setStatusFilter('interested')" class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${statusFilter === 'interested' ? 'bg-blue-500 text-white' : 'bg-blue-50 text-blue-700 hover:bg-blue-100'}">مهتم</button>
                            <button onclick="setStatusFilter('inquiry')" class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${statusFilter === 'inquiry' ? 'bg-purple-500 text-white' : 'bg-purple-50 text-purple-700 hover:bg-purple-100'}">استفسار</button>
                            <button onclick="setStatusFilter('measurements')" class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${statusFilter === 'measurements' ? 'bg-indigo-500 text-white' : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'}">رفع مقاسات</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-medium">
                                    <tr>
                                        <th class="p-3">بيانات العميل</th>
                                        <th class="p-3">الجوال</th>
                                        <th class="p-3">المشاريع</th>
                                        <th class="p-3">الحالة</th>
                                        <th class="p-3 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${data.map(c => `
                                        <tr class="hover:bg-blue-50/30 dark:hover:bg-slate-700/50 transition-colors group">
                                            <td class="p-3">
                                                <div class="font-bold text-[#0f3057] dark:text-blue-300 text-base">${c.name}</div>
                                                <div class="text-xs text-slate-400 font-mono flex items-center gap-1">
                                                    <span class="bg-slate-100 dark:bg-slate-700 px-1 rounded">${c.code}</span>
                                                    ${c.type === 'شركات' ? '<span class="bg-orange-100 text-orange-700 px-1 rounded">شركة</span>' : ''}
                                                </div>
                                            </td>
                                            <td class="p-3 font-mono dir-ltr text-right text-slate-600 dark:text-slate-300">${c.phone}</td>
                                            <td class="p-3">
                                                <div class="flex gap-1 flex-wrap">
                                                    ${Object.entries(c.projectDetails).map(([k, v]) => v > 0 ? 
                                                        `<span class="text-[10px] bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 shadow-sm">${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'نوم' : k} <b class="text-blue-600 dark:text-blue-400">${v}</b></span>` 
                                                        : '').join('')}
                                                    ${(c.customProjects || []).map(p => 
                                                        `<span class="text-[10px] bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 shadow-sm">${p.name} <b class="text-blue-600 dark:text-blue-400">${p.qty}</b></span>`
                                                    ).join('')}
                                                </div>
                                            </td>
                                            <td class="p-3">
                                                <span class="px-2.5 py-1 rounded-full text-xs font-bold border ${getStatusColor(c.status)}">
                                                    ${getStatusLabel(c.status)}
                                                </span>
                                            </td>
                                            <td class="p-3">
                                                <div class="flex items-center justify-center gap-2">
                                                    <button onclick="openWhatsAppModal(${c.id})" class="p-2 text-green-600 bg-green-50 rounded-lg hover:bg-green-100 transition-colors" title="واتساب">
                                                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="openClientModal(${c.id})" class="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors" title="التفاصيل">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="openEditClientModal(${c.id})" class="p-2 text-orange-600 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors" title="تعديل">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${data.length === 0 ? '<div class="p-10 text-center text-slate-400 flex flex-col items-center"><i data-lucide="inbox" class="w-12 h-12 mb-2 opacity-20"></i>لا توجد بيانات للعرض</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // 2. Measurements View
        function renderMeasurementsView(data) {
            // Filter: Only show clients who are in 'measurements' status OR have a pending measurement request
            const measureClients = data.filter(c => c.status === 'measurements' || (c.measureRequest && c.measureRequest.date));
            const selectedClient = selectedClientId ? clients.find(c => c.id == selectedClientId) : null;
            const projectDetails = selectedClient ? selectedClient.projectDetails : { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 };
            const appointment = selectedClient?.appointment || { date: '', time: '', status: 'pending' };
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-[calc(100vh-140px)] h-auto">
                    <div class="lg:col-span-2 space-y-6 lg:overflow-y-auto overflow-visible custom-scrollbar p-1">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-8 border-t-4 border-t-indigo-500 transition-colors">
                            <div class="mb-8 border-b border-slate-100 dark:border-slate-700 pb-4">
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                                    <span class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="ruler" class="w-6 h-6"></i></span>
                                    تفاصيل المشروع والمقاسات
                                </h2>
                                <p class="text-slate-500 mt-1 mr-12 text-sm">إدارة ملفات الرفع المساحي والوسائط</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="space-y-1">
                                    <label class="form-label">اسم العميل</label>
                                    <div class="relative">
                                        <select onchange="selectClientForMeasure(this.value)" class="form-input appearance-none bg-white dark:bg-slate-700 cursor-pointer">
                                            <option value="">اختر عميل...</option>
                                            ${measureClients.map(c => `<option value="${c.id}" ${c.id == selectedClientId ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute left-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">حالة المقاسات</label>
                                    <div class="form-input bg-slate-50 dark:bg-slate-900 flex items-center justify-between">
                                        <span class="${selectedClient && selectedClient.measurements.status === 'completed' ? 'text-green-600 font-bold' : 'text-slate-500'}">
                                            ${selectedClient ? (selectedClient.measurements.status === 'completed' ? 'مكتمل' : 'معلق') : '-'}
                                        </span>
                                        ${selectedClient && selectedClient.measurements.status === 'completed' ? '<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>' : ''}
                                    </div>
                                </div>
                            </div>

                            <!-- Appointment Info (Read Only) -->
                            <div class="bg-blue-50/50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800 mb-8 ${!selectedClient ? 'hidden' : ''}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="text-sm font-bold text-blue-800 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> موعد الزيارة المحدد</h4>
                                        <p class="text-sm text-blue-600 mt-1">${selectedClient?.appointment?.date ? `${selectedClient.appointment.date} - ${selectedClient.appointment.time}` : 'لم يتم تحديد موعد (يرجى التعديل من التسجيل)'}</p>
                                    </div>
                                    <button onclick="openEditClientModal(${selectedClient?.id})" class="text-xs bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded hover:bg-blue-50">تعديل الموعد</button>
                                </div>
                            </div>

                            <!-- 2. Measurement Items Uploads -->
                            <div class="space-y-6 mb-8 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                                <div class="flex items-center justify-between">
                                    <label class="form-label text-base">تفاصيل الرفع المساحي (صور/فيديو + كروكي):</label>
                                    <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">يتم الرفع لكل بند على حدة</span>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-4">
                                    ${selectedClient ? getMeasurementItems(selectedClient).map(item => `
                                        ${(() => {
                                            const mFiles = (selectedClient.measurements.itemFiles && selectedClient.measurements.itemFiles[item.id]) || [];
                                            return `
                                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:border-indigo-300 transition-colors">
                                            <h5 class="font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-indigo-500"></span> ${item.label}
                                            </h5>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="upload-zone bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all h-32 relative">
                                                    <input type="file" multiple accept="image/*,video/*" onchange="handleMeasurementUpload(this, '${item.id}', 'site')" class="absolute inset-0 opacity-0 cursor-pointer">
                                                    <i data-lucide="image" class="w-6 h-6 text-slate-400 mb-2"></i>
                                                    <span class="text-xs font-bold text-slate-600">صور/فيديو الموقع (قبل)</span>
                                                    <span class="text-[10px] text-slate-400 mt-1">JPG, MP4</span>
                                                </div>
                                                <div class="upload-zone bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-purple-50 hover:border-purple-300 transition-all h-32 relative">
                                                    <input type="file" multiple accept="image/*,.pdf" onchange="handleMeasurementUpload(this, '${item.id}', 'croquis')" class="absolute inset-0 opacity-0 cursor-pointer">
                                                    <i data-lucide="pen-tool" class="w-6 h-6 text-slate-400 mb-2"></i>
                                                    <span class="text-xs font-bold text-slate-600">كروكي المقاسات</span>
                                                    <span class="text-[10px] text-slate-400 mt-1">PDF, PNG</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Uploaded Files Preview -->
                                            <div class="grid grid-cols-4 gap-2 mt-4">
                                                ${mFiles.map((file, idx) => `
                                                    <div class="relative group aspect-square bg-slate-100 dark:bg-slate-900 rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                                        ${file.type.startsWith('video') ? 
                                                            `<video src="${file.url}" class="w-full h-full object-cover" controls></video>` :
                                                            (file.type.includes('pdf') ? 
                                                                `<div onclick="window.open('${file.url}')" class="w-full h-full flex flex-col items-center justify-center cursor-pointer"><i data-lucide="file-text" class="w-6 h-6 text-red-500"></i><span class="text-[8px] mt-1 truncate w-full text-center">${file.name}</span></div>` :
                                                                `<img src="${file.url}" onclick="openLightbox('${file.url}')" class="w-full h-full object-cover cursor-zoom-in">`
                                                            )
                                                        }
                                                        <button onclick="deleteMeasurementFile('${item.id}', ${idx})" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                            `;
                                        })()}
                                    `).join('') : '<div class="text-center py-8 text-slate-400 bg-slate-50 dark:bg-slate-900 rounded-xl border border-dashed border-slate-200 dark:border-slate-700">اختر عميلاً لعرض البنود</div>'}
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-3 justify-end pt-4 border-t border-slate-100 dark:border-slate-700 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                                <button onclick="notifyClientMeasurement()" class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 shadow-lg shadow-green-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                    <i data-lucide="message-circle" class="w-4 h-4"></i> إشعار العميل
                                </button>
                                <button onclick="sendToDesign()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 shadow-lg shadow-purple-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                    <i data-lucide="send" class="w-4 h-4"></i> إرسال للتصميم
                                </button>
                                <button onclick="handleSaveMeasurements()" class="bg-[#0f3057] text-white px-6 py-2.5 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                    <i data-lucide="save" class="w-4 h-4"></i> تم رفع المقاسات
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-4">
                        ${renderClientInfoCard(selectedClient)}
                    </div>
                </div>
            `;
        }

        // 3. Design View
        function renderDesignView(data) {
            const selectedClient = selectedClientForDesignId ? clients.find(c => c.id == selectedClientForDesignId) : null;
            const designItems = selectedClient ? getMeasurementItems(selectedClient) : [];
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-[calc(100vh-140px)] h-auto">
                    <div class="lg:col-span-2 space-y-6 lg:overflow-y-auto overflow-visible custom-scrollbar p-1">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-purple-500 transition-colors">
                            <div class="mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <span class="p-2 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="pen-tool" class="w-5 h-5"></i></span>
                                    مرحلة التصميم
                                </h2>
                            </div>
                            
                            <div class="space-y-4 mb-6">
                                <label class="form-label">اختيار العميل</label>
                                <div class="relative">
                                    <select onchange="selectClientForDesign(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.filter(c => c.status === 'design' || c.status === 'measurements').map(c => `<option value="${c.id}" ${c.id == selectedClientForDesignId ? 'selected' : ''}>${c.name} - ${getStatusLabel(c.status)}</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="space-y-6 ${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm transition-all' : 'transition-all'}">
                                
                                <!-- 1. Requirements & Measurements Info -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Requirements -->
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                                        <h3 class="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2"><i data-lucide="list-checks" class="w-4 h-4"></i> المطلوب تنفيذه</h3>
                                        <div class="flex flex-wrap gap-2">
                                            ${designItems.map(item => `<span class="bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-2 py-1 rounded text-xs border border-slate-200 dark:border-slate-600">${item.label}</span>`).join('')}
                                            ${designItems.length === 0 ? '<span class="text-xs text-slate-400">لا توجد بنود محددة</span>' : ''}
                                        </div>
                                    </div>

                                    <!-- Measurements Files -->
                                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800">
                                        <h3 class="font-bold text-indigo-800 text-sm mb-2 flex items-center gap-2"><i data-lucide="ruler" class="w-4 h-4"></i> ملفات المقاسات</h3>
                                        <div class="space-y-2">
                                            ${(() => {
                                                if (!selectedClient) return '';
                                                const croquis = getMeasurementCroquis(selectedClient);
                                                const sitePhotos = getSitePhotos(selectedClient);
                                                
                                                let html = '';
                                                if(croquis.length > 0) {
                                                    html += '<p class="text-[10px] font-bold text-indigo-400">الكروكي:</p>';
                                                    html += croquis.map(f => `
                                                    <div class="flex items-center gap-2 text-xs bg-white dark:bg-slate-800 p-2 rounded border border-indigo-100 dark:border-indigo-700">
                                                        <i data-lucide="file" class="w-3 h-3 text-indigo-500"></i>
                                                        <span class="truncate flex-1 dark:text-slate-300">${f.name || f}</span>
                                                        <button onclick="window.open('${f.url || '#'}')" class="text-indigo-600 hover:underline">عرض</button>
                                                    </div>`).join('');
                                                }
                                                if(sitePhotos.length > 0) {
                                                    html += '<p class="text-[10px] font-bold text-indigo-400 mt-2">صور/فيديو الموقع:</p>';
                                                    html += `<div class="flex gap-1 overflow-x-auto pb-1">${sitePhotos.map(f => `
                                                        <div onclick="openLightbox('${f.url}')" class="w-10 h-10 flex-shrink-0 bg-white rounded border cursor-pointer"><img src="${f.url}" class="w-full h-full object-cover"></div>
                                                    `).join('')}</div>`;
                                                }
                                                return html || '<span class="text-xs text-slate-400">لا توجد ملفات</span>';
                                            })()} 
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. Design Uploads Per Item -->
                                <div class="space-y-4">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-2">
                                        <i data-lucide="image" class="w-5 h-5 text-purple-500"></i> تصاميم البنود
                                    </h3>
                                    
                                    ${designItems.map(item => {
                                        const itemFiles = (selectedClient?.design?.itemFiles && selectedClient.design.itemFiles[item.id]) || [];
                                        const itemNotes = (selectedClient?.design?.itemNotes && selectedClient.design.itemNotes[item.id]) || '';
                                        const measureFiles = (selectedClient?.measurements?.itemFiles && selectedClient.measurements.itemFiles[item.id]) || [];
                                        return `
                                            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                                                <div class="p-3 bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                                                    <span class="font-bold text-sm text-slate-700 dark:text-slate-200">${item.label}</span>
                                                    <div class="relative overflow-hidden">
                                                        <button class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 transition flex items-center gap-1">
                                                            <i data-lucide="upload" class="w-3 h-3"></i> رفع تصميم
                                                        </button>
                                                        <input type="file" multiple accept="image/*,.pdf" onchange="handleItemDesignUpload(this, '${item.id}')" class="absolute inset-0 opacity-0 cursor-pointer">
                                                    </div>
                                                </div>
                                                ${measureFiles.length > 0 ? `
                                                <div class="p-3 border-b border-slate-200 dark:border-slate-700 bg-blue-50/50 dark:bg-blue-900/20">
                                                    <p class="text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><i data-lucide="ruler" class="w-3 h-3"></i> ملفات المقاسات (صور/فيديو):</p>
                                                    <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                                                        ${measureFiles.map(f => `
                                                            <div class="relative flex-shrink-0 w-20 h-20 bg-white dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-600 overflow-hidden cursor-pointer group" onclick="${f.type.includes('pdf') ? `window.open('${f.url}')` : `openLightbox('${f.url}')`}">
                                                                ${f.type.startsWith('video') ? 
                                                                    `<video src="${f.url}" class="w-full h-full object-cover"></video><div class="absolute inset-0 flex items-center justify-center bg-black/30"><i data-lucide="play" class="w-6 h-6 text-white"></i></div>` :
                                                                    (f.type.includes('pdf') ? 
                                                                        `<div class="w-full h-full flex flex-col items-center justify-center"><i data-lucide="file-text" class="w-6 h-6 text-red-500"></i><span class="text-[8px] mt-1 truncate w-full text-center">${f.name}</span></div>` :
                                                                        `<img src="${f.url}" class="w-full h-full object-cover">`
                                                                    )
                                                                }
                                                                <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-[8px] py-0.5 text-center truncate">${f.category === 'croquis' ? 'كروكي' : 'موقع'}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                                ` : ''}
                                                <div class="p-3">
                                                    <div class="grid grid-cols-3 md:grid-cols-4 gap-3">
                                                        ${itemFiles.map((file, idx) => {
                                                            const isPdf = file.type === 'application/pdf' || (file.name && file.name.toLowerCase().endsWith('.pdf'));
                                                            return `
                                                            <div class="relative group aspect-square bg-white dark:bg-slate-800 rounded-lg overflow-hidden border border-slate-200 dark:border-slate-600 shadow-sm">
                                                                ${isPdf ? `
                                                                    <div onclick="window.open('${file.url}', '_blank')" class="w-full h-full flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                                                        <i data-lucide="file-text" class="w-8 h-8 text-red-500 mb-2"></i>
                                                                        <span class="text-[10px] text-slate-500 dark:text-slate-400 px-2 text-center truncate w-full">${file.name}</span>
                                                                    </div>
                                                                ` : `
                                                                    <img src="${file.url}" onclick="openLightbox('${file.url}')" class="w-full h-full object-cover transition-transform group-hover:scale-105 cursor-zoom-in" title="${file.name}">
                                                                `}
                                                                <button onclick="deleteItemDesignImage('${item.id}', ${idx})" class="absolute top-1 right-1 bg-red-500/90 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-all shadow-sm"><i data-lucide="x" class="w-3 h-3"></i></button>
                                                            </div>
                                                            `;
                                                        }).join('')}
                                                        ${itemFiles.length === 0 ? '<p class="col-span-full text-center text-xs text-slate-400 py-2">لا توجد تصاميم لهذا البند</p>' : ''}
                                                    </div>
                                                </div>
                                                <div class="p-3 border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50">
                                                    <label class="text-xs font-bold text-slate-500 mb-1 block flex items-center gap-1"><i data-lucide="sticky-note" class="w-3 h-3"></i> ملاحظات المصمم:</label>
                                                    <textarea onchange="updateItemDesignNote('${item.id}', this.value)" class="form-input text-xs h-16 resize-none bg-slate-50 dark:bg-slate-900" placeholder="اكتب ملاحظات حول هذا التصميم...">${itemNotes}</textarea>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>

                                <!-- 3. Design Status Controls -->
                                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm flex items-center gap-2">
                                        <i data-lucide="check-circle-2" class="w-4 h-4 text-slate-400"></i> حالة اعتماد التصميم
                                    </h3>
                                    <div class="mb-4 flex flex-wrap justify-end gap-2">
                                        <button onclick="downloadFiles('measurements')" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 flex items-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> تحميل ملفات المقاسات</button>
                                        <button onclick="downloadFiles('design')" class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 flex items-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> تحميل ملفات التصميم</button>
                                        <button onclick="createDesignPackage()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 flex items-center gap-1"><i data-lucide="package" class="w-3 h-3"></i> تجميع ملف PDF</button>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <button onclick="updateDesignStatus('approved')" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg border transition-all ${selectedClient?.design?.status === 'approved' ? 'bg-green-50 border-green-500 text-green-700 dark:bg-green-900/20 dark:text-green-400' : 'border-slate-200 text-slate-500 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-400 dark:hover:bg-slate-700'}">
                                            <i data-lucide="check" class="w-5 h-5"></i>
                                            <span class="text-xs font-bold">موافقة</span>
                                        </button>
                                        <button onclick="updateDesignStatus('review')" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg border transition-all ${selectedClient?.design?.status === 'review' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-400' : 'border-slate-200 text-slate-500 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-400 dark:hover:bg-slate-700'}">
                                            <i data-lucide="clock" class="w-5 h-5"></i>
                                            <span class="text-xs font-bold">قيد المراجعة</span>
                                        </button>
                                        <button onclick="updateDesignStatus('rejected')" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg border transition-all ${selectedClient?.design?.status === 'rejected' ? 'bg-red-50 border-red-500 text-red-700 dark:bg-red-900/20 dark:text-red-400' : 'border-slate-200 text-slate-500 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-400 dark:hover:bg-slate-700'}">
                                            <i data-lucide="x" class="w-5 h-5"></i>
                                            <span class="text-xs font-bold">رفض / تعديل</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="pt-6 border-t border-slate-100 dark:border-slate-700">
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="saveDesignWork()" class="flex-1 bg-slate-600 text-white hover:bg-slate-700 py-3 rounded-lg font-bold transition shadow-lg flex justify-center gap-2">
                                            <i data-lucide="save" class="w-5 h-5"></i> حفظ العمل
                                        </button>
                                        <button onclick="openWhatsAppModal(${selectedClient?.id})" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 shadow-lg font-bold flex items-center gap-2 transition-colors" title="تواصل مع العميل">
                                            <i data-lucide="message-circle" class="w-5 h-5"></i> تواصل
                                        </button>
                                        <button onclick="sendToPricing()" class="flex-1 bg-purple-600 text-white hover:bg-purple-700 py-3 rounded-lg font-bold transition shadow-lg flex justify-center gap-2">
                                            <i data-lucide="arrow-right" class="w-5 h-5"></i> إرسال للتسعير
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-4">
                        ${renderClientInfoCard(selectedClient)}
                    </div>
                </div>
            `;
        }
        
        // New Pricing View
        function renderPricingView(data) {
            const selectedClient = selectedClientForPricingId ? clients.find(c => c.id == selectedClientForPricingId) : null;
            const items = selectedClient ? (selectedClient.quotationItems || []) : [];
            const subTotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const taxRate = parseFloat(companySettings.taxRate) || 0;
            const taxAmount = subTotal * (taxRate / 100);
            const totalAmount = subTotal + taxAmount;

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-[calc(100vh-140px)] h-auto">
                    <div class="lg:col-span-2 space-y-6 lg:overflow-y-auto overflow-visible custom-scrollbar p-1">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-green-500 transition-colors">
                            <div class="mb-6 border-b border-slate-100 dark:border-slate-700 pb-4 flex justify-between items-center">
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <span class="p-2 bg-green-100 rounded-lg text-green-600"><i data-lucide="calculator" class="w-5 h-5"></i></span>
                                    إعداد عرض السعر التفصيلي
                                </h2>
                            </div>

                            <div class="mb-6">
                                <label class="form-label">اختيار العميل</label>
                                <div class="relative max-w-md">
                                    <select onchange="selectClientForPricing(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.map(c => `<option value="${c.id}" ${c.id == selectedClientForPricingId ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm' : ''} transition-all">
                                <!-- Project Files Section -->
                                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-4 border border-slate-200 dark:border-slate-700 mb-6">
                                    <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm flex items-center gap-2">
                                        <i data-lucide="folder-input" class="w-4 h-4 text-blue-500"></i> ملفات المشروع (من التصميم والمقاسات)
                                    </h4>
                                    <div class="flex gap-3">
                                        <button onclick="downloadFiles('measurements')" class="flex items-center gap-2 text-xs bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 px-3 py-2 rounded hover:bg-slate-50 dark:hover:bg-slate-700 transition text-indigo-600 font-bold"><i data-lucide="ruler" class="w-4 h-4"></i> استعراض المقاسات</button>
                                        <button onclick="downloadFiles('design')" class="flex items-center gap-2 text-xs bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 px-3 py-2 rounded hover:bg-slate-50 dark:hover:bg-slate-700 transition text-purple-600 font-bold"><i data-lucide="image" class="w-4 h-4"></i> استعراض التصاميم</button>
                                    </div>
                                </div>

                                <!-- Items Table -->
                                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6">
                                    <table class="w-full text-right text-sm">
                                        <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold">
                                            <tr>
                                                <th class="p-3 w-12">#</th>
                                                <th class="p-3">البند / الوصف</th>
                                                <th class="p-3 w-24">الكمية</th>
                                                <th class="p-3 w-32">السعر الإفرادي</th>
                                                <th class="p-3 w-32">الإجمالي</th>
                                                <th class="p-3 w-16"></th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                            ${items.map((item, idx) => `
                                                <tr class="bg-white dark:bg-slate-800">
                                                    <td class="p-3 text-center text-slate-400">${idx + 1}</td>
                                                    <td class="p-3"><input type="text" value="${item.name}" onchange="updatePricingItem(${idx}, 'name', this.value)" class="w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500 transition-colors" placeholder="اسم البند..."></td>
                                                    <td class="p-3"><input type="number" value="${item.qty}" onchange="updatePricingItem(${idx}, 'qty', this.value)" class="w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500 transition-colors text-center" min="1"></td>
                                                    <td class="p-3"><input type="number" value="${item.price}" onchange="updatePricingItem(${idx}, 'price', this.value)" class="w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500 transition-colors" step="0.01"></td>
                                                    <td class="p-3 font-bold text-slate-700 dark:text-slate-200">${(item.qty * item.price).toLocaleString()}</td>
                                                    <td class="p-3 text-center"><button onclick="removePricingItem(${idx})" class="text-red-400 hover:text-red-600"><i data-lucide="trash" class="w-4 h-4"></i></button></td>
                                                </tr>
                                            `).join('')}
                                            <tr class="bg-slate-50 dark:bg-slate-900">
                                                <td colspan="6" class="p-2 text-center">
                                                    <div class="flex justify-center gap-4">
                                                        <button onclick="addPricingItem()" class="text-blue-600 hover:text-blue-700 font-bold text-sm flex items-center gap-2 py-2 px-4 hover:bg-blue-50 dark:hover:bg-slate-800 rounded transition-colors">
                                                            <i data-lucide="plus-circle" class="w-4 h-4"></i> إضافة بند جديد
                                                        </button>
                                                        <button onclick="resetPricingItems()" class="text-orange-500 hover:text-orange-600 font-bold text-sm flex items-center gap-2 py-2 px-4 hover:bg-orange-50 dark:hover:bg-slate-800 rounded transition-colors" title="استرجاع البنود الأصلية من المشروع">
                                                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> إعادة تعيين
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Summary & Actions -->
                                <div class="flex flex-col md:flex-row justify-between items-end gap-6">
                                    <div class="w-full md:w-1/3 space-y-4">
                                         <div class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl p-4 space-y-3">
                                            <div class="flex items-center gap-3">
                                                <input type="checkbox" id="offer-approved" ${selectedClient?.design?.offerApproved ? 'checked' : ''} class="w-5 h-5 text-blue-600 rounded cursor-pointer accent-blue-600">
                                                <label for="offer-approved" class="font-bold text-slate-700 dark:text-slate-200 select-none cursor-pointer">اعتماد عرض السعر</label>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <input type="checkbox" id="contract-signed" ${selectedClient?.design?.contractSigned ? 'checked' : ''} class="w-5 h-5 text-green-600 rounded cursor-pointer accent-green-600">
                                                <label for="contract-signed" class="font-bold text-slate-700 dark:text-slate-200 select-none cursor-pointer">توقيع العقد</label>
                                            </div>
                                            <hr class="border-slate-200 dark:border-slate-600">
                                            <label class="text-xs font-bold text-slate-500 block mb-1">تاريخ التركيب المتوقع (بالعقد)</label>
                                            <input type="date" id="contract-install-date" value="${selectedClient?.installation?.startDate || ''}" class="form-input text-sm">
                                        </div>
                                        <button onclick="generateContract()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold hover:bg-slate-900"><i data-lucide="file-signature" class="w-3 h-3 inline"></i> إنشاء العقد</button>
                                        <button onclick="downloadContract()" class="w-full bg-red-700 text-white py-2 rounded-lg text-xs font-bold hover:bg-red-800 mt-2"><i data-lucide="file-down" class="w-3 h-3 inline"></i> تحميل العقد PDF</button>
                                        
                                        <!-- Contract Upload -->
                                        <div class="mt-4 border-t border-slate-200 dark:border-slate-700 pt-4">
                                            <label class="text-xs font-bold text-slate-500 mb-2 block">رفع العقد الموقع (PDF/Image)</label>
                                            <div class="upload-zone bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 p-3 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-50 transition-all relative rounded-xl">
                                                <input type="file" accept="application/pdf,image/*" onchange="handleContractUpload(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                                                ${selectedClient?.design?.contractFile ? 
                                                    `<div class="flex items-center gap-2 text-green-600 w-full justify-center"><i data-lucide="check-circle" class="w-5 h-5"></i><span class="text-xs font-bold">تم الرفع</span><button onclick="event.preventDefault(); window.open('${selectedClient.design.contractFile}')" class="z-10 text-blue-600 hover:underline text-xs px-2 border-r border-slate-300">عرض</button><button onclick="event.preventDefault(); deleteContractFile()" class="z-10 text-red-500 hover:text-red-700 text-xs px-2">حذف</button></div>` : 
                                                    `<div class="flex flex-col items-center">
                                                        <i data-lucide="upload-cloud" class="w-6 h-6 text-slate-400 mb-1"></i>
                                                        <span class="text-[10px] text-slate-500">اضغط لرفع العقد الموقع</span>
                                                     </div>`
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-slate-100 dark:bg-slate-900 p-5 rounded-xl min-w-[300px] space-y-3">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">المجموع قبل الضريبة:</span>
                                            <span class="font-bold text-slate-800 dark:text-white">${subTotal.toLocaleString()} <span class="text-xs font-normal">${companySettings.currency || 'SAR'}</span></span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">الضريبة (${taxRate}%):</span>
                                            <span class="font-bold text-red-500">${taxAmount.toLocaleString()} <span class="text-xs font-normal">${companySettings.currency || 'SAR'}</span></span>
                                        </div>
                                        <div class="flex justify-between text-sm border-t border-slate-200 dark:border-slate-700 pt-2 mt-2">
                                            <span class="text-slate-500 font-bold">المجموع الكلي:</span>
                                            <span class="font-bold text-lg text-slate-800 dark:text-white">${totalAmount.toLocaleString()} <span class="text-xs font-normal">${companySettings.currency || 'SAR'}</span></span>
                                        </div>
                                        <div class="flex justify-between items-center gap-4">
                                            <span class="text-slate-500 text-sm">الدفعة الأولى:</span>
                                            <input type="number" id="pricing-first-payment" value="${selectedClient?.design?.firstPayment || 0}" oninput="updatePricingRemaining(this.value, ${totalAmount})" class="w-24 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-sm font-bold" placeholder="0">
                                        </div>
                                        <div class="flex justify-between items-center gap-4 mt-2 border-t border-slate-200 dark:border-slate-700 pt-2">
                                            <span class="text-slate-500 text-sm font-bold">المتبقي:</span>
                                            <span id="pricing-remaining" class="font-bold text-red-500">${(totalAmount - (selectedClient?.design?.firstPayment || 0)).toLocaleString()} <span class="text-xs font-normal">${companySettings.currency || 'SAR'}</span></span>
                                        </div>
                                        <div class="flex gap-2 mt-2">
                                            <button onclick="printDetailedQuotation(${selectedClient?.id})" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-900/20 flex justify-center gap-2" title="طباعة PDF">
                                                <i data-lucide="printer" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="savePricingData()" class="flex-[2] bg-slate-600 text-white py-2 rounded-lg font-bold hover:bg-slate-700 transition shadow-lg flex justify-center gap-2">
                                                <i data-lucide="save" class="w-4 h-4"></i> حفظ العرض
                                            </button>
                                        </div>
                                        <button onclick="sendToInstallationFromPricing()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition shadow-lg shadow-green-900/20 flex justify-center gap-2 mt-2">
                                            <i data-lucide="wrench" class="w-4 h-4"></i> إرسال للتركيب
                                        </button>
                                        <button onclick="openWhatsAppModal(${selectedClient?.id})" class="w-full bg-green-100 text-green-700 py-2 rounded-lg font-bold hover:bg-green-200 transition flex justify-center gap-2 mt-2">
                                            <i data-lucide="message-circle" class="w-4 h-4"></i> تواصل مع العميل
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-4">
                        ${renderClientInfoCard(selectedClient)}
                    </div>
                </div>
            `;
        }

        function downloadContract() {
            if (!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if (!client) return;

            // Notify user
            const btn = document.activeElement;
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin inline"></i> جاري التحميل...';
            lucide.createIcons();

            const element = document.createElement('div');
            element.style.width = '800px';
            element.style.padding = '40px';
            element.style.direction = 'rtl';
            element.style.fontFamily = 'Cairo, sans-serif';
            element.style.background = 'white';
            element.style.color = '#000';
            element.style.fontSize = '12px';

            const total = parseFloat(client.design.total) || 0;
            const first = parseFloat(client.design.firstPayment) || 0;
            const remaining = total - first;

            const logoHtml = companySettings.logo ? `<img src="${companySettings.logo}" style="max-height:80px; max-width:150px;">` : '';

            element.innerHTML = `
                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #0f3057; padding-bottom:20px; margin-bottom:30px;">
                    <div style="text-align:right;">
                        <h2 style="color:#0f3057; margin:0 0 5px 0; font-size:18px;">${companySettings.name}</h2>
                        <p style="margin:2px 0; color:#64748b;">${companySettings.subtitle || ''}</p>
                        <p style="margin:2px 0; color:#64748b;">${companySettings.phone}</p>
                        <p style="margin:2px 0; color:#64748b;">${companySettings.address}</p>
                    </div>
                    <div>${logoHtml}</div>
                </div>
                
                <div style="text-align:center; margin-bottom:30px;">
                    <h1 style="background:#0f3057; color:white; display:inline-block; padding:8px 30px; border-radius:20px; font-size:16px; margin:0;">عقد اتفاق وتوريد أعمال ديكور</h1>
                </div>

                <div style="margin-bottom:20px; line-height:1.8;">
                    <p>إنه في يوم <strong>${new Date().toLocaleDateString('ar-EG')}</strong>، تم الاتفاق بين كل من:</p>
                    <p><strong>الطرف الأول:</strong> شركة ${companySettings.name}، سجل تجاري رقم (${companySettings.taxId})، ويمثلها في هذا العقد إدارة المبيعات.</p>
                    <p><strong>الطرف الثاني:</strong> السيد/ة <strong>${client.name}</strong>، جوال رقم <strong>${client.phone}</strong>، وعنوانه: ${client.address}.</p>
                </div>

                <!-- Scope -->
                <div style="margin-bottom:20px;">
                    <h3 style="color:#0f3057; border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">أولاً: موضوع العقد</h3>
                    <p>يقوم الطرف الأول بتنفيذ أعمال الديكور/المفروشات للطرف الثاني وفقاً للتصاميم والمواصفات المعتمدة في عرض السعر رقم (QT-${client.code}).</p>
                    
                    <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:11px;">
                        <thead style="background:#f1f5f9;">
                            <tr>
                                <th style="border:1px solid #cbd5e1; padding:8px; text-align:right;">م</th>
                                <th style="border:1px solid #cbd5e1; padding:8px; text-align:right;">البند</th>
                                <th style="border:1px solid #cbd5e1; padding:8px; text-align:center;">الكمية</th>
                                <th style="border:1px solid #cbd5e1; padding:8px; text-align:left;">السعر</th>
                                <th style="border:1px solid #cbd5e1; padding:8px; text-align:left;">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(client.quotationItems || []).map((item, idx) => `
                            <tr>
                                <td style="border:1px solid #cbd5e1; padding:8px;">${idx + 1}</td>
                                <td style="border:1px solid #cbd5e1; padding:8px;">${item.name}</td>
                                <td style="border:1px solid #cbd5e1; padding:8px; text-align:center;">${item.qty}</td>
                                <td style="border:1px solid #cbd5e1; padding:8px; text-align:left;">${item.price.toLocaleString()}</td>
                                <td style="border:1px solid #cbd5e1; padding:8px; text-align:left;">${(item.qty * item.price).toLocaleString()}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Financials -->
                <div style="margin-bottom:20px;">
                    <h3 style="color:#0f3057; border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">ثانياً: القيمة المالية والدفعات</h3>
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1; background:#f8fafc; padding:15px; border:1px solid #e2e8f0; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span>إجمالي العقد (شامل الضريبة):</span>
                                <span style="font-weight:bold;">${total.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#16a34a;">
                                <span>الدفعة الأولى (عند التوقيع):</span>
                                <span style="font-weight:bold;">${first.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; color:#dc2626; border-top:1px solid #e2e8f0; pt-2;">
                                <span>المتبقي (قبل التركيب):</span>
                                <span style="font-weight:bold;">${remaining.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms -->
                <div style="margin-bottom:40px;">
                    <h3 style="color:#0f3057; border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">ثالثاً: الشروط والأحكام</h3>
                    <div style="font-size:10px; line-height:1.6; white-space: pre-line; color:#334155; columns: 2;">
                        ${companySettings.contractTerms || 'تطبق الشروط العامة للشركة.'}
                    </div>
                </div>

                <!-- Signatures -->
                <div style="display:flex; justify-content:space-between; margin-top:40px;">
                    <div style="text-align:center; width:40%;">
                        <p style="font-weight:bold; margin-bottom:40px;">الطرف الأول (الشركة)</p>
                        <p>_________________</p>
                        <p style="font-size:10px; color:#94a3b8; margin-top:5px;">التوقيع والختم</p>
                    </div>
                    <div style="text-align:center; width:40%;">
                        <p style="font-weight:bold; margin-bottom:40px;">الطرف الثاني (العميل)</p>
                        <p>_________________</p>
                        <p style="font-size:10px; color:#94a3b8; margin-top:5px;">الاسم والتوقيع</p>
                    </div>
                </div>
            `;

            const opt = {
                margin: 10,
                filename: `Contract_${client.code}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
            }).catch(err => {
                console.error(err);
                alert('حدث خطأ أثناء إنشاء الملف');
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
            });
        }

        function handleContractUpload(input) {
            if (!selectedClientForPricingId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if (!client) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if(!client.design) client.design = {};
                client.design.contractFile = e.target.result;
                client.design.contractSigned = true; // Auto sign
                saveClients();
                render();
                alert('تم رفع العقد بنجاح');
            };
            reader.readAsDataURL(input.files[0]);
        }

        function deleteContractFile() {
            if (!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if (client && client.design && client.design.contractFile) {
                if(confirm('هل أنت متأكد من حذف ملف العقد؟')) {
                    delete client.design.contractFile;
                    client.design.contractSigned = false;
                    saveClients();
                    render();
                }
            }
        }

        function updateFloatingButton() {
            let clientId = null;
            if (activeTab === 'measurements') clientId = selectedClientId;
            else if (activeTab === 'design') clientId = selectedClientForDesignId;
            else if (activeTab === 'pricing') clientId = selectedClientForPricingId;
            else if (activeTab === 'installation') clientId = selectedClientForInstallId;
            
            const btn = document.getElementById('floating-client-btn');
            const nameEl = document.getElementById('floating-client-name');
            
            if (clientId) {
                const client = clients.find(c => c.id == clientId);
                if (client && btn && nameEl) {
                    currentActiveClientId = clientId;
                    nameEl.textContent = client.name;
                    btn.classList.remove('hidden');
                    btn.classList.add('flex');
                    return;
                }
            }
            
            if(btn) {
                btn.classList.add('hidden');
                btn.classList.remove('flex');
            }
            currentActiveClientId = null;
        }

        function openCurrentClientModal() {
            if(currentActiveClientId) openClientModal(currentActiveClientId);
        }

        // 4. Installation View
        function renderInstallationView(data) {
            const selectedClient = selectedClientForInstallId ? clients.find(c => c.id == selectedClientForInstallId) : null;
            // Calculate financials
            const total = selectedClient ? (parseFloat(selectedClient.design.total) || 0) : 0;
            const firstPay = selectedClient ? (parseFloat(selectedClient.design.firstPayment) || 0) : 0;
            const remaining = total - firstPay;
            const isFinalPaid = selectedClient?.installation?.finalPaymentPaid || false;
            
            // Get items for upload sections
            const items = selectedClient ? getMeasurementItems(selectedClient) : [];

            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Content -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-orange-500 transition-colors">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-slate-800 dark:text-white text-lg flex items-center gap-2">
                                        <span class="p-2 bg-orange-100 rounded-lg text-orange-600"><i data-lucide="wrench" class="w-5 h-5"></i></span>
                                        إدارة التركيبات والتسليم
                                    </h3>
                                    ${selectedClient ? `<span class="text-xs font-mono bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500">${selectedClient.code}</span>` : ''}
                                </div>

                                <!-- Client Selection -->
                                <div class="mb-8">
                                    <label class="form-label">اختيار العميل (مرحلة التركيب)</label>
                                    <div class="relative">
                                        <select onchange="selectClientForInstall(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                            <option value="">اختر عميل...</option>
                                            ${clients.filter(c => c.design.contractSigned && c.status !== 'completed').map(c => `<option value="${c.id}" ${c.id == selectedClientForInstallId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>

                                <div class="${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm' : ''} space-y-8">
                                    
                                    <!-- 1. Project & Design Info (Read Only) -->
                                    <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                                                <i data-lucide="folder-open" class="w-4 h-4 text-blue-500"></i> ملفات المشروع (تصميم + مقاسات)
                                            </h4>
                                            <div class="flex gap-2">
                                                 <button onclick="downloadFiles('measurements')" class="text-[10px] bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 px-2 py-1 rounded hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-300">تحميل المقاسات</button>
                                                 <button onclick="downloadFiles('design')" class="text-[10px] bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 px-2 py-1 rounded hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-300">تحميل التصاميم</button>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar pr-1">
                                            ${items.map(item => {
                                                const designFiles = (selectedClient?.design?.itemFiles && selectedClient.design.itemFiles[item.id]) || [];
                                                const measureFiles = (selectedClient?.measurements?.itemFiles && selectedClient.measurements.itemFiles[item.id]) || [];
                                                const itemNotes = (selectedClient?.design?.itemNotes && selectedClient.design.itemNotes[item.id]) || '';
                                                
                                                if (designFiles.length === 0 && measureFiles.length === 0 && !itemNotes) return '';

                                                return `
                                                    <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden">
                                                        <div class="p-2 bg-slate-100 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600 font-bold text-sm flex justify-between">
                                                            <span>${item.label}</span>
                                                        </div>
                                                        <div class="p-3 space-y-3">
                                                            ${measureFiles.length > 0 ? `
                                                            <div>
                                                                <p class="text-[10px] font-bold text-slate-500 mb-1 flex items-center gap-1"><i data-lucide="ruler" class="w-3 h-3"></i> المقاسات والموقع:</p>
                                                                <div class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                                                                    ${measureFiles.map(f => `
                                                                        <div onclick="${f.type.includes('pdf') ? `window.open('${f.url}')` : `openLightbox('${f.url}')`}" class="w-12 h-12 flex-shrink-0 rounded border border-slate-200 cursor-pointer overflow-hidden relative group bg-slate-50">
                                                                             ${f.type.startsWith('video') ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30"><i data-lucide="play" class="w-4 h-4 text-white"></i></div>' : ''}
                                                                             ${f.type.includes('pdf') ? '<div class="w-full h-full flex items-center justify-center"><i data-lucide="file-text" class="w-5 h-5 text-red-500"></i></div>' : `<img src="${f.url}" class="w-full h-full object-cover">`}
                                                                        </div>
                                                                    `).join('')}
                                                                </div>
                                                            </div>` : ''}

                                                            ${designFiles.length > 0 ? `
                                                            <div>
                                                                <p class="text-[10px] font-bold text-purple-500 mb-1 flex items-center gap-1"><i data-lucide="image" class="w-3 h-3"></i> التصاميم المعتمدة:</p>
                                                                <div class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                                                                    ${designFiles.map(f => `
                                                                        <div onclick="${f.type.includes('pdf') ? `window.open('${f.url}')` : `openLightbox('${f.url}')`}" class="w-16 h-16 flex-shrink-0 rounded border border-purple-200 cursor-pointer overflow-hidden relative group bg-white">
                                                                             ${f.type.startsWith('video') ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30"><i data-lucide="play" class="w-4 h-4 text-white"></i></div>' : ''}
                                                                             ${f.type.includes('pdf') ? '<div class="w-full h-full flex items-center justify-center"><i data-lucide="file-text" class="w-6 h-6 text-red-500"></i></div>' : `<img src="${f.url}" class="w-full h-full object-cover">`}
                                                                        </div>
                                                                    `).join('')}
                                                                </div>
                                                            </div>` : ''}

                                                            ${itemNotes ? `
                                                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded border border-yellow-100 dark:border-yellow-800">
                                                                <p class="text-[10px] font-bold text-yellow-700 dark:text-yellow-500 mb-1 flex items-center gap-1"><i data-lucide="sticky-note" class="w-3 h-3"></i> ملاحظات:</p>
                                                                <p class="text-xs text-slate-700 dark:text-slate-300">${itemNotes}</p>
                                                            </div>` : ''}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                            ${items.length === 0 ? '<p class="text-center text-slate-400 text-sm">لا توجد بنود</p>' : ''}
                                        </div>
                                    </div>

                                    <!-- 2. Financials & Final Payment -->
                                    <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-5 border border-green-100 dark:border-green-800">
                                        <h4 class="font-bold text-green-800 dark:text-green-400 mb-4 text-sm flex items-center gap-2">
                                            <i data-lucide="banknote" class="w-4 h-4"></i> المتابعة المالية (الدفعة الأخيرة)
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                            <div class="bg-white dark:bg-slate-800 p-3 rounded-lg border border-green-100 dark:border-green-700">
                                                <span class="text-xs text-slate-500 block">إجمالي العقد</span>
                                                <span class="font-bold text-slate-800 dark:text-white">${total.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                                            </div>
                                            <div class="bg-white dark:bg-slate-800 p-3 rounded-lg border border-green-100 dark:border-green-700">
                                                <span class="text-xs text-slate-500 block">الدفعة الأولى (مدفوعة)</span>
                                                <span class="font-bold text-green-600">${firstPay.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                                            </div>
                                            <div class="bg-white dark:bg-slate-800 p-3 rounded-lg border border-red-100 dark:border-red-900/50">
                                                <span class="text-xs text-slate-500 block">الدفعة الأخيرة (المتبقي)</span>
                                                <span class="font-bold text-red-500">${remaining.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-wrap items-center justify-between gap-4 bg-white dark:bg-slate-800 p-3 rounded-lg border border-green-200 dark:border-green-700">
                                            <div class="flex items-center gap-3">
                                                <input type="checkbox" id="final-payment-check" onchange="toggleFinalPayment(this.checked)" ${isFinalPaid ? 'checked' : ''} class="w-5 h-5 text-green-600 rounded cursor-pointer">
                                                <label for="final-payment-check" class="font-bold text-sm text-slate-700 dark:text-slate-200 cursor-pointer select-none">
                                                    تم استلام الدفعة الأخيرة بالكامل
                                                </label>
                                            </div>
                                            <button onclick="sendPaymentReminder(${remaining})" class="text-xs bg-green-100 text-green-700 hover:bg-green-200 px-3 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors">
                                                <i data-lucide="message-circle" class="w-3 h-3"></i> إرسال مطالبة بالسداد
                                            </button>
                                        </div>
                                        ${(() => {
                                            // 15 days warning logic
                                            if(selectedClient?.installation?.startDate && !isFinalPaid) {
                                                const installDate = new Date(selectedClient.installation.startDate);
                                                const today = new Date();
                                                const diffTime = installDate - today;
                                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                                if(diffDays <= 15 && diffDays >= 0) {
                                                    return `<div class="mt-3 text-xs text-red-600 bg-red-50 p-2 rounded border border-red-100 flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i> تنبيه: موعد التركيب اقترب (${diffDays} يوم). يرجى تحصيل الدفعة الأخيرة!</div>`;
                                                }
                                            }
                                            return '';
                                        })()}
                                    </div>

                                    <!-- 3. Scheduling -->
                                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-5 border border-orange-100 dark:border-orange-800">
                                        <h4 class="font-bold text-orange-800 dark:text-orange-400 mb-4 text-sm flex items-center gap-2">
                                            <i data-lucide="calendar" class="w-4 h-4"></i> جدولة التركيب
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                            <div class="space-y-1">
                                                <label class="form-label">تاريخ التركيب المحدد</label>
                                                <input type="date" id="install-date-input" value="${selectedClient?.installation?.startDate || ''}" class="form-input">
                                            </div>
                                            <div class="space-y-1">
                                                <label class="form-label">رقم أمر الشغل (Job No)</label>
                                                <input type="text" id="install-job-input" value="${selectedClient?.installation?.jobNo || ''}" class="form-input font-mono" placeholder="JOB-XXX">
                                            </div>
                                            <div class="space-y-1 md:col-span-2">
                                                <label class="form-label">فريق التركيب (أسماء الفنيين)</label>
                                                <input type="text" id="install-team-input" value="${selectedClient?.installation?.team || ''}" class="form-input" placeholder="مثال: محمد، أحمد، ...">
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap gap-3 mt-4">
                                            <button onclick="saveInstallationSchedule()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 text-xs font-bold flex items-center gap-2">
                                                <i data-lucide="save" class="w-3 h-3"></i> حفظ الموعد
                                            </button>
                                            <button onclick="sendInstallConfirmation()" class="bg-white border border-orange-200 text-orange-700 px-4 py-2 rounded-lg hover:bg-orange-50 text-xs font-bold flex items-center gap-2">
                                                <i data-lucide="message-circle" class="w-3 h-3"></i> إخطار العميل بالموعد
                                            </button>
                                            <button onclick="sendTeamOnWay()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-xs font-bold flex items-center gap-2 ml-auto">
                                                <i data-lucide="truck" class="w-3 h-3"></i> الفريق في الطريق
                                            </button>
                                            <button onclick="printWorkOrder(selectedClientForInstallId)" class="bg-slate-700 text-white px-4 py-2 rounded-lg hover:bg-slate-800 text-xs font-bold flex items-center gap-2">
                                                <i data-lucide="printer" class="w-3 h-3"></i> طباعة أمر شغل
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 4. Post-Installation Uploads -->
                                    <div class="space-y-4">
                                        <h4 class="font-bold text-slate-700 dark:text-slate-200 border-b border-slate-100 dark:border-slate-700 pb-2 flex items-center gap-2">
                                            <i data-lucide="camera" class="w-5 h-5 text-purple-500"></i> توثيق التركيب (صور/فيديو)
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${items.map(item => {
                                                const files = (selectedClient?.installation?.postInstallFiles && selectedClient.installation.postInstallFiles[item.id]) || [];
                                                return `
                                                    <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                                                        <div class="flex justify-between items-center mb-2">
                                                            <span class="font-bold text-sm text-slate-700 dark:text-slate-200">${item.label}</span>
                                                            <div class="relative">
                                                                <button class="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded hover:bg-purple-100 transition flex items-center gap-1">
                                                                    <i data-lucide="upload" class="w-3 h-3"></i> رفع
                                                                </button>
                                                                <input type="file" multiple accept="image/*,video/*" onchange="handlePostInstallUpload(this, '${item.id}')" class="absolute inset-0 opacity-0 cursor-pointer">
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar h-16">
                                                            ${files.map(f => `
                                                                <div onclick="openLightbox('${f.url}')" class="w-16 h-16 flex-shrink-0 rounded bg-slate-100 border border-slate-200 overflow-hidden cursor-pointer relative group">
                                                                    ${f.type.startsWith('video') ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30"><i data-lucide="play" class="w-6 h-6 text-white"></i></div>' : ''}
                                                                    <img src="${f.url}" class="w-full h-full object-cover">
                                                                </div>
                                                            `).join('')}
                                                            ${files.length === 0 ? '<span class="text-[10px] text-slate-400 self-center">لا توجد صور</span>' : ''}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>

                                    <!-- 5. Handover & Completion -->
                                    <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-5 border border-slate-200 dark:border-slate-700">
                                        <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm flex items-center gap-2">
                                            <i data-lucide="file-check" class="w-4 h-4"></i> تسليم المشروع وإغلاقه
                                        </h4>
                                        <div class="flex flex-col md:flex-row gap-6 items-start">
                                            <div class="flex-1 w-full">
                                                <label class="text-xs font-bold text-slate-500 mb-2 block">إيصال الاستلام الموقع (صورة)</label>
                                                <div class="upload-zone bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-50 transition-all h-32 relative rounded-xl">
                                                    <input type="file" accept="image/*" onchange="handleDeliveryReceiptUpload(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                                                    ${selectedClient?.installation?.deliveryReceipt ? 
                                                        `<div class="relative w-full h-full"><img src="${selectedClient.installation.deliveryReceipt}" class="w-full h-full object-contain"><div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white opacity-0 hover:opacity-100 transition">تغيير</div></div>` : 
                                                        `<i data-lucide="file-signature" class="w-8 h-8 text-slate-400 mb-2"></i><span class="text-xs font-bold text-slate-600">رفع الإيصال</span>`
                                                    }
                                                </div>
                                            </div>
                                            <div class="flex-1 w-full flex flex-col justify-end h-full pt-6">
                                                <button onclick="completeProject()" class="w-full bg-green-600 text-white py-4 rounded-xl hover:bg-green-700 shadow-lg shadow-green-900/20 font-bold text-lg flex items-center justify-center gap-2 transition-transform active:scale-95 ${(!isFinalPaid || !selectedClient?.installation?.deliveryReceipt) ? 'opacity-50 cursor-not-allowed' : ''}">
                                                    <i data-lucide="check-circle-2" class="w-6 h-6"></i> تم التركيب وإغلاق المشروع
                                                </button>
                                                <p class="text-[10px] text-slate-400 text-center mt-2">يجب سداد الدفعة الأخيرة ورفع إيصال الاستلام لتفعيل الزر</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        
                        <!-- Sidebar Info -->
                        <div class="lg:col-span-1 space-y-4">
                            ${renderClientInfoCard(selectedClient)}
                            ${selectedClient ? `
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-4">
                                <h4 class="font-bold text-sm mb-2">العنوان</h4>
                                <p class="text-sm text-slate-600 dark:text-slate-300">${selectedClient.address}</p>
                                ${selectedClient.location ? `<a href="${selectedClient.location}" target="_blank" class="text-blue-600 text-xs flex items-center gap-1 mt-2 hover:underline"><i data-lucide="map-pin" class="w-3 h-3"></i> فتح الموقع</a>` : ''}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // 4.5 Completed Projects View
        function renderCompletedProjectsView(data) {
            const completedClients = data.filter(c => c.status === 'completed');
            const totalValue = completedClients.reduce((sum, c) => sum + (parseFloat(c.design?.total) || 0), 0);

            return `
                <div class="space-y-6 animate-fadeIn">
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        ${renderStatCard('المشاريع المكتملة', completedClients.length, 'check-circle', 'bg-green-600', 'text-white')}
                        ${renderStatCard('إجمالي القيمة', totalValue.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'dollar-sign', 'bg-white', 'text-slate-800', 'border-l-4 border-blue-500')}
                        ${renderStatCard('متوسط قيمة المشروع', (completedClients.length ? Math.round(totalValue / completedClients.length) : 0).toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'bar-chart', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <!-- Table -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                <i data-lucide="archive" class="w-5 h-5 text-slate-400"></i> أرشيف المشاريع المنتهية
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-medium">
                                    <tr>
                                        <th class="p-3">العميل</th>
                                        <th class="p-3">تاريخ الانتهاء</th>
                                        <th class="p-3">تفاصيل المشروع</th>
                                        <th class="p-3">القيمة النهائية</th>
                                        <th class="p-3">فريق التركيب</th>
                                        <th class="p-3 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${completedClients.map(c => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                            <td class="p-3">
                                                <div class="font-bold text-slate-800 dark:text-slate-200">${c.name}</div>
                                                <div class="text-xs text-slate-400 font-mono">${c.code}</div>
                                            </td>
                                            <td class="p-3 text-slate-600 dark:text-slate-400 font-mono">${c.installation?.endDate || '-'}</td>
                                            <td class="p-3">
                                                <div class="flex gap-1 flex-wrap">
                                                    ${Object.entries(c.projectDetails).map(([k, v]) => v > 0 ? 
                                                        `<span class="text-[10px] bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300">${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'نوم' : k}</span>` 
                                                        : '').join('')}
                                                </div>
                                            </td>
                                            <td class="p-3 font-bold text-green-600">${parseFloat(c.design?.total || 0).toLocaleString()}</td>
                                            <td class="p-3 text-slate-600 dark:text-slate-400 text-xs">${c.installation?.team || '-'}</td>
                                            <td class="p-3 text-center">
                                                <div class="flex items-center justify-center gap-2">
                                                    <button onclick="openClientModal(${c.id})" class="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors" title="التفاصيل الكاملة">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    ${c.installation?.deliveryReceipt ? `
                                                    <button onclick="openLightbox('${c.installation.deliveryReceipt}')" class="p-2 text-purple-600 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors" title="إيصال الاستلام">
                                                        <i data-lucide="file-check" class="w-4 h-4"></i>
                                                    </button>` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${completedClients.length === 0 ? '<tr><td colspan="6" class="text-center py-10 text-slate-400">لا توجد مشاريع منتهية حتى الآن</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleFinalPayment(checked) {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                if (!client.installation) client.installation = {};
                client.installation.finalPaymentPaid = checked;
                if(checked) {
                    client.installation.lastPayment = (parseFloat(client.design.total) - parseFloat(client.design.firstPayment));
                    client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم تسجيل سداد الدفعة الأخيرة' });
                }
                saveClients();
                render();
            }
        }

        function sendPaymentReminder(amount) {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                const msg = `مرحباً ${client.name}،\nنود تذكيركم بقرب موعد التركيب.\nيرجى التكرم بسداد الدفعة الأخيرة المتبقية وقدرها (${amount.toLocaleString()} ${companySettings.currency || 'SAR'}) لضمان اعتماد موعد التركيب.\nشكراً لتعاونكم.`;
                const url = `https://wa.me/${client.whatsapp || client.phone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            }
        }

        function saveInstallationSchedule() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                const date = document.getElementById('install-date-input').value;
                const job = document.getElementById('install-job-input').value;
                const team = document.getElementById('install-team-input').value;
                
                if(!client.installation) client.installation = {};
                client.installation.startDate = date;
                client.installation.jobNo = job;
                client.installation.team = team;
                client.status = 'installation';
                
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: `تم تحديث موعد التركيب: ${date}` });
                saveClients();
                render();
                alert('تم حفظ البيانات بنجاح');
            }
        }

        function sendInstallConfirmation() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client && client.installation?.startDate) {
                const msg = `مرحباً ${client.name}،\nنؤكد لكم موعد التركيب المحدد بتاريخ: ${client.installation.startDate}.\nنرجو التواجد في الموقع.\nشكراً لاختياركم بيت الخزائن.`;
                const url = `https://wa.me/${client.whatsapp || client.phone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            } else {
                alert('يرجى تحديد تاريخ التركيب وحفظه أولاً');
            }
        }

        function sendTeamOnWay() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                const msg = `مرحباً ${client.name}،\nفريق التركيب في الطريق إليكم الآن 🚚\nيرجى الاستعداد لاستقبالهم.`;
                const url = `https://wa.me/${client.whatsapp || client.phone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            }
        }

        function handlePostInstallUpload(input, itemId) {
            if (!selectedClientForInstallId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (!client) return;

            if (!client.installation.postInstallFiles) client.installation.postInstallFiles = {};
            if (!client.installation.postInstallFiles[itemId]) client.installation.postInstallFiles[itemId] = [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    client.installation.postInstallFiles[itemId].push({
                        type: file.type,
                        url: e.target.result,
                        name: file.name
                    });
                    saveClients();
                    render();
                };
                reader.readAsDataURL(file);
            });
        }

        function handleDeliveryReceiptUpload(input) {
            if (!selectedClientForInstallId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (!client) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                client.installation.deliveryReceipt = e.target.result;
                saveClients();
                render();
            };
            reader.readAsDataURL(input.files[0]);
        }

        function completeProject() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                if(!client.installation.finalPaymentPaid) return alert('يجب سداد الدفعة الأخيرة أولاً');
                if(!client.installation.deliveryReceipt) return alert('يجب رفع إيصال الاستلام');

                if(confirm('هل أنت متأكد من إغلاق المشروع؟ سيتم تحويل الحالة إلى "مكتمل".')) {
                    client.status = 'completed';
                    client.installation.endDate = new Date().toLocaleDateString('en-US');
                    client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم إغلاق المشروع واكتمال التركيب' });
                    saveClients();
                    selectedClientForInstallId = null; // Deselect
                    render();
                    alert('مبروك! تم إكمال المشروع بنجاح 🎉');
                }
            }
        }

        /*
        // 4. Installation View (Old Version - Replaced above)
        function renderInstallationView_OLD(data) {
            const selectedClient = selectedClientForInstallId ? clients.find(c => c.id == selectedClientForInstallId) : null;

            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-orange-500 transition-colors">
                            <div class="flex justify-between items-center mb-6">
                              <h3 class="font-bold text-slate-800 dark:text-white text-lg flex items-center gap-2">
                                <span class="p-2 bg-orange-100 rounded-lg text-orange-600"><i data-lucide="wrench" class="w-5 h-5"></i></span>
                                تفاصيل المشروع والتركيب
                              </h3>
                            </div>

                            <div class="mb-6">
                                <label class="form-label">اختيار العميل (مرحلة التركيب)</label>
                                <div class="relative">
                                    <select onchange="selectClientForInstall(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.filter(c => c.design.signed).map(c => `<option value="${c.id}" ${c.id == selectedClientForInstallId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 ${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm' : ''}">
                              <div class="space-y-1">
                                <label class="form-label">رقم الوظيفة (Job No)</label>
                                <input type="text" id="install-job" value="${selectedClient?.installation?.jobNo || ''}" class="form-input bg-slate-50 dark:bg-slate-700 text-right font-mono" placeholder="J-XXXX">
                              </div>
                              <div class="space-y-1">
                                <label class="form-label">تاريخ بدء التركيب</label>
                                <input type="date" id="install-start" value="${selectedClient?.installation?.startDate || ''}" class="form-input">
                              </div>
                              <div class="space-y-1">
                                <label class="form-label">الدفعة الأخيرة (ريال)</label>
                                <div class="relative">
                                    <input type="number" id="install-last-pay" value="${selectedClient?.installation?.lastPayment || ''}" class="form-input pr-10" placeholder="0">
                                    <span class="absolute left-3 top-2.5 text-xs text-slate-400 font-bold">SAR</span>
                                </div>
                              </div>
                            </div>

                            <div class="mt-8 flex gap-3 justify-end pt-4 border-t border-slate-100 dark:border-slate-700">
                               <button onclick="handleSaveInstallation()" class="bg-orange-500 text-white px-6 py-2.5 rounded-lg hover:bg-orange-600 flex items-center gap-2 shadow-lg shadow-orange-200 transition-all font-bold ${!selectedClient ? 'hidden' : ''}">
                                   <i data-lucide="calendar-check" class="w-5 h-5"></i> تحديث وجدولة
                               </button>
                            </div>
                          </div>
                        </div>
                        
                        <div class="lg:col-span-1 space-y-4">
                             ${renderClientInfoCard(selectedClient)}
                             <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 transition-colors">
                                <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> إحصائيات التركيب</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                                        <span class="text-sm text-blue-800">بالانتظار</span>
                                        <span class="bg-white px-2 py-0.5 rounded text-blue-600 font-bold shadow-sm">${clients.filter(c => c.status === 'design' && c.design.signed).length}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg border border-orange-100">
                                        <span class="text-sm text-orange-800">جاري التركيب</span>
                                        <span class="bg-white px-2 py-0.5 rounded text-orange-600 font-bold shadow-sm">${clients.filter(c => c.status === 'installation').length}</span>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        } 
        */

        // 5. Offers View
        function renderOffersView(data) {
            const offers = clients.filter(c => c.design.total > 0);
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        ${renderStatCard('إجمالي العروض', offers.length, 'file-text', 'bg-blue-600', 'text-white')}
                        ${renderStatCard('قيمة العروض', offers.reduce((a,b) => a + (parseInt(b.design.total)||0), 0).toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'dollar-sign', 'bg-white', 'text-slate-800', 'border-l-4 border-green-500')}
                        ${renderStatCard('تم التعاقد', offers.filter(c => c.design.contractSigned).length, 'check-circle', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200">قائمة عروض الأسعار والفواتير</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 border-b border-slate-100 dark:border-slate-700">
                                    <tr>
                                        <th class="p-3">رقم العرض</th>
                                        <th class="p-3">العميل</th>
                                        <th class="p-3">القيمة الإجمالية</th>
                                        <th class="p-3">الدفعة الأولى</th>
                                        <th class="p-3">الحالة</th>
                                        <th class="p-3 text-center">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${offers.length > 0 ? offers.map(c => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                            <td class="p-3 font-mono text-slate-500">${c.code}-QT</td>
                                            <td class="p-3 font-bold text-slate-800 dark:text-slate-200">${c.name}</td>
                                            <td class="p-3 text-slate-800 dark:text-slate-200 font-bold">${parseInt(c.design.total).toLocaleString()} ${companySettings.currency || 'SAR'}</td>
                                            <td class="p-3 text-green-600">${parseInt(c.design.firstPayment).toLocaleString()} ${companySettings.currency || 'SAR'}</td>
                                            <td class="p-3">
                                                <span class="px-2.5 py-1 rounded-full text-xs font-bold ${c.design.contractSigned ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                                    ${c.design.contractSigned ? 'تم التعاقد' : 'بانتظار الموافقة'}
                                                </span>
                                            </td>
                                            <td class="p-3 text-center">
                                                <button onclick="printInvoice(${c.id})" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors" title="طباعة عرض السعر">
                                                    <i data-lucide="printer" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="printReceipt(${c.id})" class="text-green-600 hover:bg-green-50 p-2 rounded-lg transition-colors" title="طباعة سند قبض">
                                                    <i data-lucide="banknote" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="openClientModal(${c.id})" class="text-purple-600 hover:bg-purple-50 p-2 rounded-lg transition-colors" title="عرض التفاصيل">
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="6" class="text-center py-10 text-slate-400">لا توجد عروض أسعار مسجلة</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6. Financials View (New)
        function renderFinancialsView(data) {
            // Calculate global stats for visible clients
            const totalContract = data.reduce((sum, c) => sum + (parseFloat(c.design.total) || 0), 0);
            const totalPaid = data.reduce((sum, c) => sum + (parseFloat(c.design.firstPayment) || 0) + (parseFloat(c.installation.lastPayment) || 0), 0);
            const totalRemaining = totalContract - totalPaid;

            return `
                <div class="space-y-6 animate-fadeIn">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        ${renderStatCard('إجمالي العقود', totalContract.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'coins', 'bg-blue-600', 'text-white')}
                        ${renderStatCard('المبالغ المحصلة', totalPaid.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'check-circle-2', 'bg-green-600', 'text-white')}
                        ${renderStatCard('المبالغ المتبقية', totalRemaining.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'clock', 'bg-red-500', 'text-white')}
                    </div>

                    <!-- Clients Financial Table -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                <i data-lucide="banknote" class="w-5 h-5 text-slate-400"></i> سجل الدفعات والتحصيل
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-medium">
                                    <tr>
                                        <th class="p-3">العميل</th>
                                        <th class="p-3">قيمة العقد</th>
                                        <th class="p-3">المدفوع</th>
                                        <th class="p-3">المتبقي</th>
                                        <th class="p-3 w-1/4">نسبة السداد</th>
                                        <th class="p-3">الحالة</th>
                                        <th class="p-3 text-center">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${data.map(c => {
                                        const total = parseFloat(c.design.total) || 0;
                                        if(total === 0) return ''; // Skip clients with no contract
                                        const paid = (parseFloat(c.design.firstPayment) || 0) + (parseFloat(c.installation.lastPayment) || 0);
                                        const remaining = total - paid;
                                        const percent = Math.round((paid / total) * 100);
                                        
                                        return `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                            <td class="p-3">
                                                <div class="font-bold text-slate-800 dark:text-slate-200">${c.name}</div>
                                                <div class="text-xs text-slate-400 font-mono">${c.code}</div>
                                            </td>
                                            <td class="p-3 font-bold text-slate-700 dark:text-slate-300">${total.toLocaleString()}</td>
                                            <td class="p-3 text-green-600 font-bold">${paid.toLocaleString()}</td>
                                            <td class="p-3 text-red-500 font-bold">${remaining.toLocaleString()}</td>
                                            <td class="p-3">
                                                <div class="flex items-center gap-2">
                                                    <div class="flex-1 h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                                        <div class="h-full bg-blue-500 rounded-full" style="width: ${percent}%"></div>
                                                    </div>
                                                    <span class="text-xs font-bold text-slate-500">${percent}%</span>
                                                </div>
                                            </td>
                                            <td class="p-3">
                                                ${remaining <= 0 
                                                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">خالص</span>' 
                                                    : '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-bold">متبقي</span>'}
                                            </td>
                                            <td class="p-3 text-center">
                                                <button onclick="openClientModal(${c.id})" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors" title="عرض التفاصيل">
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                    ${data.filter(c => (parseFloat(c.design.total) || 0) > 0).length === 0 ? '<tr><td colspan="6" class="text-center py-8 text-slate-400">لا توجد عقود مالية مسجلة</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6.5 Accounts View (New)
        function renderAccountsView(data) {
            // Calculate Totals
            const totalIncome = data.reduce((sum, c) => sum + (parseFloat(c.design.firstPayment)||0) + (parseFloat(c.installation.lastPayment)||0), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const netProfit = totalIncome - totalExpenses;

            return `
                <div class="space-y-6 animate-fadeIn">
                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        ${renderStatCard('إجمالي الإيرادات', totalIncome.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'arrow-down-circle', 'bg-green-600', 'text-white')}
                        ${renderStatCard('إجمالي المصروفات', totalExpenses.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'arrow-up-circle', 'bg-red-500', 'text-white')}
                        ${renderStatCard('صافي الأرباح', netProfit.toLocaleString() + ' ' + (companySettings.currency || 'SAR'), 'wallet', 'bg-white', 'text-slate-800', `border-l-4 ${netProfit >= 0 ? 'border-green-500' : 'border-red-500'}`)}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Expenses List -->
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                    <i data-lucide="list-minus" class="w-5 h-5 text-slate-400"></i> سجل المصروفات
                                </h3>
                                <button onclick="exportExpenses()" class="text-xs flex items-center gap-1 text-blue-600 hover:bg-blue-50 px-2 py-1 rounded transition-colors">
                                    <i data-lucide="download" class="w-3 h-3"></i> تصدير
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                                <table class="w-full text-right text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-medium sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3">التاريخ</th>
                                            <th class="p-3">البند</th>
                                            <th class="p-3">الوصف</th>
                                            <th class="p-3">المبلغ</th>
                                            <th class="p-3 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).map(e => {
                                            const cat = EXPENSE_CATEGORIES.find(c => c.id === e.category) || { label: e.category, icon: 'circle' };
                                            return `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors group">
                                                <td class="p-3 font-mono text-slate-500 dark:text-slate-400">${e.date}</td>
                                                <td class="p-3">
                                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">
                                                        <i data-lucide="${cat.icon}" class="w-3 h-3"></i> ${cat.label}
                                                    </span>
                                                </td>
                                                <td class="p-3 text-slate-700 dark:text-slate-200">${e.description}</td>
                                                <td class="p-3 font-bold text-red-500">${parseFloat(e.amount).toLocaleString()}</td>
                                                <td class="p-3 text-center">
                                                    <button onclick="deleteExpense(${e.id})" class="text-red-400 hover:bg-red-50 p-1.5 rounded transition-colors opacity-0 group-hover:opacity-100">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                        ${expenses.length === 0 ? '<tr><td colspan="5" class="text-center py-8 text-slate-400">لا توجد مصروفات مسجلة</td></tr>' : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Add Expense Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 sticky top-24 transition-colors">
                                <h3 class="font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-4">
                                    <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i> تسجيل مصروف جديد
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <label class="form-label">نوع المصروف</label>
                                        <select id="exp-category" class="form-input bg-white dark:bg-slate-700">
                                            ${EXPENSE_CATEGORIES.map(c => `<option value="${c.id}">${c.label}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="form-label">المبلغ (${companySettings.currency || 'SAR'})</label>
                                        <input type="number" id="exp-amount" class="form-input" placeholder="0.00">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="form-label">التاريخ</label>
                                        <input type="date" id="exp-date" value="${new Date().toISOString().split('T')[0]}" class="form-input">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="form-label">الوصف / ملاحظات</label>
                                        <textarea id="exp-desc" class="form-input h-24 resize-none" placeholder="تفاصيل المصروف..."></textarea>
                                    </div>
                                    <button onclick="addExpense()" class="w-full bg-[#0f3057] text-white py-3 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 font-bold flex items-center justify-center gap-2 transition-all active:scale-95 mt-2">
                                        <i data-lucide="save" class="w-4 h-4"></i> حفظ المصروف
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6.6 Users View (New)
        function renderUsersView() {
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Users List -->
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                    <i data-lucide="users" class="w-5 h-5 text-slate-400"></i> قائمة المستخدمين
                                </h3>
                                <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-1 rounded-full font-bold">${users.length} مستخدم</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-medium">
                                        <tr>
                                            <th class="p-3">الاسم</th>
                                            <th class="p-3">اسم المستخدم</th>
                                            <th class="p-3">كلمة المرور</th>
                                            <th class="p-3">الصلاحية</th>
                                            <th class="p-3 text-center">إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${users.map(u => `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                                <td class="p-3 font-bold text-slate-800 dark:text-slate-200">${u.name}</td>
                                                <td class="p-3 text-slate-600 dark:text-slate-400 font-mono">${u.username || '-'}</td>
                                                <td class="p-3 text-slate-600 dark:text-slate-400 font-mono">****</td>
                                                <td class="p-3">
                                                    <span class="px-2.5 py-1 rounded-full text-xs font-bold ${getRoleBadgeColor(u.role)}">
                                                        ${USER_ROLES[u.role] || u.role}
                                                    </span>
                                                </td>
                                                <td class="p-3 text-center">
                                                    <button onclick="deleteUser(${u.id})" class="text-red-400 hover:bg-red-50 p-2 rounded-lg transition-colors" ${u.id === 1 ? 'disabled opacity-50 cursor-not-allowed' : ''}>
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Add User Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 sticky top-24 transition-colors">
                                <h3 class="font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-4">
                                    <i data-lucide="user-plus" class="w-5 h-5 text-blue-600"></i> إضافة مستخدم جديد
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <label class="form-label">الاسم الكامل</label>
                                        <input type="text" id="user-name-input" class="form-input" placeholder="مثال: محمد علي">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="form-label">اسم المستخدم (للدخول)</label>
                                        <input type="text" id="user-username-input" class="form-input" placeholder="username">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="form-label">كلمة المرور</label>
                                        <input type="password" id="user-password-input" class="form-input" placeholder="******">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="form-label">الصلاحية</label>
                                        <select id="user-role-input" class="form-input bg-white dark:bg-slate-700">
                                            ${Object.entries(USER_ROLES).map(([k,v]) => `<option value="${k}">${v}</option>`).join('')}
                                        </select>
                                    </div>
                                    <button onclick="addNewUser()" class="w-full bg-[#0f3057] text-white py-3 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 font-bold flex items-center justify-center gap-2 transition-all active:scale-95 mt-2">
                                        <i data-lucide="save" class="w-4 h-4"></i> حفظ المستخدم
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6. Reports View
        function renderReportsView(data) {
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status Chart -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 transition-colors">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">توزيع حالات المشاريع</h3>
                            <div class="relative h-64">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <!-- Financial Chart -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 transition-colors">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">الملخص المالي</h3>
                            <div class="relative h-64">
                                <canvas id="financialChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">إجمالي العقود</p>
                            <p class="text-2xl font-bold text-slate-800 dark:text-white" id="report-total-contracts">0 ${companySettings.currency || 'SAR'}</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">المحصل</p>
                            <p class="text-2xl font-bold text-green-600" id="report-total-collected">0 ${companySettings.currency || 'SAR'}</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">المتبقي</p>
                            <p class="text-2xl font-bold text-red-500" id="report-total-remaining">0 ${companySettings.currency || 'SAR'}</p>
                        </div>
                         <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">عدد العملاء</p>
                            <p class="text-2xl font-bold text-blue-600">${data.length}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // 7. Settings View
        function renderSettingsView() {
            return `
                <div class="max-w-4xl mx-auto space-y-6 animate-fadeIn">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-8 transition-colors">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                            <i data-lucide="settings" class="w-6 h-6 text-slate-400"></i>
                            إعدادات النظام والشركة
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Logo Upload -->
                            <div class="space-y-4">
                                <label class="form-label">شعار الشركة</label>
                                <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors relative">
                                    <div id="settings-logo-preview" class="w-32 h-32 bg-slate-100 dark:bg-slate-900 rounded-xl flex items-center justify-center mb-4 overflow-hidden shadow-sm">
                                        ${companySettings.logo ? `<img src="${companySettings.logo}" class="w-full h-full object-cover">` : '<i data-lucide="image" class="w-10 h-10 text-slate-300"></i>'}
                                    </div>
                                    <input type="file" id="logo-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleLogoUpload(this)">
                                    <p class="text-sm text-slate-500 font-medium">اضغط لتغيير الشعار</p>
                                    <p class="text-xs text-slate-400 mt-1">PNG, JPG (Max 2MB)</p>
                                </div>
                            </div>

                            <!-- Company Info -->
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label class="form-label">اسم الشركة</label>
                                    <input type="text" id="set-name" value="${companySettings.name}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">وصف مختصر (تحت الشعار)</label>
                                    <input type="text" id="set-subtitle" value="${companySettings.subtitle}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="text" id="set-phone" value="${companySettings.phone}" class="form-input dir-ltr text-right">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" id="set-email" value="${companySettings.email}" class="form-input dir-ltr text-right">
                                </div>
                            </div>

                            <!-- Address & Tax -->
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-1">
                                    <label class="form-label">العنوان</label>
                                    <input type="text" id="set-address" value="${companySettings.address}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">العملة</label>
                                    <input type="text" id="set-currency" value="${companySettings.currency || 'SAR'}" class="form-input" placeholder="SAR, USD, EGP...">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">الرقم الضريبي</label>
                                    <input type="text" id="set-tax" value="${companySettings.taxId}" class="form-input font-mono">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">نسبة الضريبة (%)</label>
                                    <input type="number" id="set-tax-rate" value="${companySettings.taxRate || 15}" class="form-input" placeholder="15">
                                </div>
                            </div>

                            <div class="md:col-span-2 space-y-1">
                                <label class="form-label">بنود العقد والشروط (تظهر في الطباعة)</label>
                                <textarea id="set-terms" class="form-input h-32 resize-none" placeholder="اكتب الشروط والأحكام هنا...">${companySettings.contractTerms || ''}</textarea>
                            </div>
                        </div>

                        <!-- Database Management -->
                        <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700">
                            <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <i data-lucide="database" class="w-5 h-5 text-slate-400"></i> إدارة البيانات
                            </h3>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="exportBackup()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 shadow-lg shadow-green-900/20 font-bold flex items-center gap-2 transition-all">
                                    <i data-lucide="download" class="w-5 h-5"></i> تصدير نسخة احتياطية (Backup)
                                </button>
                                
                                <div class="relative">
                                    <button class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 shadow-lg shadow-orange-900/20 font-bold flex items-center gap-2 transition-all">
                                        <i data-lucide="upload" class="w-5 h-5"></i> استعادة نسخة (Restore)
                                    </button>
                                    <input type="file" accept=".json" onchange="restoreBackup(this)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">ملاحظة: استعادة النسخة ستقوم بحذف البيانات الحالية واستبدالها بالنسخة الجديدة.</p>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 flex justify-end">
                            <button onclick="saveSettingsFromView()" class="bg-[#0f3057] text-white px-8 py-3 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 font-bold flex items-center gap-2">
                                <i data-lucide="save" class="w-5 h-5"></i> حفظ الإعدادات
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Helper Renderers ---
        function renderStatCard(title, val, icon, bgClass, textClass, borderClass = '') {
            return `
                <div class="rounded-xl shadow-sm p-5 flex justify-between items-center ${bgClass} ${bgClass.includes('bg-white') ? 'dark:bg-slate-800' : ''} ${borderClass} transition-transform hover:-translate-y-1">
                    <div class="${textClass}">
                        <p class="text-sm opacity-80 font-medium mb-1">${title}</p>
                        <p class="text-3xl font-bold">${val}</p>
                    </div>
                    <div class="p-3 rounded-lg bg-white/20 backdrop-blur-sm ${textClass}">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                </div>
            `;
        }

        function renderCounter(label, key) {
            return `
                <div class="flex flex-col bg-white dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                    <span class="text-xs font-bold text-slate-500 mb-2 text-center block">${label}</span>
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-900 rounded">
                        <button onclick="updateCount('${key}', -1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors font-bold text-lg">-</button>
                        <span id="count-${key}" class="font-bold text-slate-700 dark:text-slate-200 text-sm">${newClientForm.projectDetails[key]}</span>
                        <button onclick="updateCount('${key}', 1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-green-500 hover:bg-green-50 rounded transition-colors font-bold text-lg">+</button>
                    </div>
                </div>
            `;
        }

        function renderUploadZone(icon, label, subLabel, styleClass) {
            // styleClass example: 'bg-blue-50 border-blue-200 text-blue-500'
            const [bg, border, text] = styleClass.split(' ');
            return `
                <div class="upload-zone ${bg} ${border} p-8 text-center cursor-pointer group">
                    <div class="flex justify-center mb-3">
                        <div class="p-4 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform duration-200">
                            <i data-lucide="${icon}" class="${text} w-6 h-6"></i>
                        </div>
                    </div>
                    <h4 class="font-bold text-slate-700 mb-1 group-hover:text-blue-600 transition-colors">${label}</h4>
                    <p class="text-xs text-slate-400">${subLabel}</p>
                </div>
            `;
        }

        function renderClientInfoCard(client) {
            return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 h-full flex flex-col transition-colors">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-700 pb-2">ملف العميل المختصر</h3>
                    <div class="flex-1">
                        ${client ? `
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold text-slate-600 dark:text-slate-300">
                                    ${client.name.charAt(0)}
                                </div>
                                <p class="font-bold text-lg text-slate-800 dark:text-white">${client.name}</p>
                                <p class="text-sm text-slate-400 font-mono">${client.code}</p>
                                <div class="flex justify-center gap-2 mt-2">
                                    <button onclick="openWhatsAppModal(${client.id})" class="p-1.5 bg-green-100 text-green-600 rounded-full hover:bg-green-200"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
                                    <button onclick="openClientModal(${client.id})" class="p-1.5 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div class="space-y-3 bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-500">الحالة الحالية:</span> 
                                    <span class="font-bold px-2 py-0.5 rounded bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-xs">${getStatusLabel(client.status)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500">المقاسات:</span> 
                                    <span class="font-bold ${client.measurements?.status === 'completed' ? 'text-green-600' : 'text-orange-500'}">
                                        ${client.measurements?.status === 'completed' ? 'تمت' : 'لم تتم'}
                                    </span>
                                </div>
                            </div>
                        ` : `
                            <div class="h-full flex flex-col items-center justify-center text-slate-300">
                                <i data-lucide="user" class="w-16 h-16 mb-2 opacity-50"></i>
                                <p>اختر عميلاً لعرض التفاصيل</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function setStatusFilter(status) {
            statusFilter = status;
            render();
        }

        function getStatusLabel(s) { const o = STATUS_OPTIONS.find(x => x.id === s); return o ? o.label : s; }
        function getStatusColor(s) { const o = STATUS_OPTIONS.find(x => x.id === s); return o ? o.color : 'bg-gray-100'; }

        function getRoleLabel(role) {
            const map = { 'admin': 'مدير النظام', 'sales': 'مبيعات', 'designer': 'مصمم', 'accountant': 'محاسب' };
            return map[role] || role;
        }

        function getRoleBadgeColor(role) {
            const map = { 
                'admin': 'bg-red-100 text-red-700', 
                'sales': 'bg-blue-100 text-blue-700', 
                'designer': 'bg-purple-100 text-purple-700', 
                'accountant': 'bg-green-100 text-green-700' 
            };
            return map[role] || 'bg-gray-100 text-gray-700';
        }

        // --- Logic Handlers ---
        function attachInputListeners() {
            const n = document.getElementById('in-name'), p = document.getElementById('in-phone'), e = document.getElementById('in-email'), a = document.getElementById('in-address'), t = document.getElementById('in-type');
            const w = document.getElementById('in-whatsapp'), l = document.getElementById('in-location'), s = document.getElementById('in-source'), tx = document.getElementById('in-tax'), st = document.getElementById('in-status'), nt = document.getElementById('in-notes');
            const md = document.getElementById('in-measure-date'), mt = document.getElementById('in-measure-time'), ma = document.getElementById('in-measure-amount');

            if(n) n.oninput = (ev) => newClientForm.name = ev.target.value;
            if(p) p.oninput = (ev) => newClientForm.phone = ev.target.value;
            if(e) e.oninput = (ev) => newClientForm.email = ev.target.value;
            if(a) a.oninput = (ev) => newClientForm.address = ev.target.value;
            if(t) t.onchange = (ev) => { newClientForm.type = ev.target.value; render(); };
            if(w) w.oninput = (ev) => newClientForm.whatsapp = ev.target.value;
            if(l) l.oninput = (ev) => newClientForm.location = ev.target.value;
            if(s) s.onchange = (ev) => newClientForm.source = ev.target.value;
            if(tx) tx.oninput = (ev) => newClientForm.taxId = ev.target.value;
            if(st) st.onchange = (ev) => newClientForm.clientStatus = ev.target.value;
            if(nt) nt.oninput = (ev) => newClientForm.notes = ev.target.value;
            if(md) md.oninput = (ev) => newClientForm.measureRequest.date = ev.target.value;
            if(mt) mt.oninput = (ev) => newClientForm.measureRequest.time = ev.target.value;
            if(ma) ma.oninput = (ev) => newClientForm.measureRequest.amount = ev.target.value;
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    companySettings.logo = e.target.result;
                    document.getElementById('settings-logo-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveSettingsFromView() {
            companySettings.name = document.getElementById('set-name').value;
            companySettings.subtitle = document.getElementById('set-subtitle').value;
            companySettings.phone = document.getElementById('set-phone').value;
            companySettings.email = document.getElementById('set-email').value;
            companySettings.address = document.getElementById('set-address').value;
            companySettings.currency = document.getElementById('set-currency').value || 'SAR';
            companySettings.taxId = document.getElementById('set-tax').value;
            companySettings.taxRate = document.getElementById('set-tax-rate').value;
            companySettings.contractTerms = document.getElementById('set-terms').value;
            saveSettingsData();
        }

        function initReportsCharts() {
            const ctxStatus = document.getElementById('statusChart');
            const ctxFinancial = document.getElementById('financialChart');
            
            if(!ctxStatus || !ctxFinancial) return;

            // Data Processing
            const statusCounts = {};
            STATUS_OPTIONS.forEach(s => statusCounts[s.id] = 0);
            clients.forEach(c => {
                if(statusCounts[c.status] !== undefined) statusCounts[c.status]++;
                else statusCounts[c.status] = 1; // Fallback
            });

            const totalContracts = clients.reduce((sum, c) => sum + (parseInt(c.design.total) || 0), 0);
            const totalCollected = clients.reduce((sum, c) => sum + (parseInt(c.design.firstPayment) || 0) + (parseInt(c.installation.lastPayment) || 0), 0);
            const totalRemaining = totalContracts - totalCollected;

            // Update Summary Cards
            document.getElementById('report-total-contracts').textContent = totalContracts.toLocaleString() + ' ' + (companySettings.currency || 'SAR');
            document.getElementById('report-total-collected').textContent = totalCollected.toLocaleString() + ' ' + (companySettings.currency || 'SAR');
            document.getElementById('report-total-remaining').textContent = totalRemaining.toLocaleString() + ' ' + (companySettings.currency || 'SAR');

            // Status Chart
            new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: STATUS_OPTIONS.map(s => s.label),
                    datasets: [{
                        data: STATUS_OPTIONS.map(s => statusCounts[s.id]),
                        backgroundColor: ['#3b82f6', '#eab308', '#a855f7', '#6366f1', '#f97316', '#22c55e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'Cairo' } } } } }
            });

            // Financial Chart
            new Chart(ctxFinancial, {
                type: 'bar',
                data: {
                    labels: ['إجمالي العقود', 'المحصل', 'المتبقي'],
                    datasets: [{
                        label: `القيم المالية (${companySettings.currency || 'SAR'})`,
                        data: [totalContracts, totalCollected, totalRemaining],
                        backgroundColor: ['#3b82f6', '#22c55e', '#ef4444'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateCount(k, d) {
            newClientForm.projectDetails[k] = Math.max(0, newClientForm.projectDetails[k] + d);
            render(); 
        }

        function addCompanyItem() {
            const name = document.getElementById('comp-item-name').value;
            const qty = document.getElementById('comp-item-qty').value;
            if(name && qty > 0) {
                newClientForm.customProjects.push({ name, qty });
                render();
            }
        }

        function removeCompanyItem(idx) {
            newClientForm.customProjects.splice(idx, 1);
            render();
        }

        function togglePaidAmount() {
            const isPaid = document.getElementById('in-measure-paid').checked;
            newClientForm.measureRequest.isPaid = isPaid;
            render();
        }

        function saveNewClient(targetStatus = null) {
            if(!newClientForm.name || !newClientForm.phone) return alert('الاسم ورقم الجوال مطلوبان');
            if(clients.some(c => c.phone === newClientForm.phone)) return alert('رقم الجوال مسجل مسبقاً!');

            let client = {
                ...newClientForm,
                id: Date.now(),
                status: targetStatus || newClientForm.clientStatus || 'potential',
                employeeId: currentUser.id,
                logs: [{ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تسجيل جديد' }],
                measurements: { status: 'pending', date: '', files: [] },
                appointment: { date: '', time: '', status: 'pending' },
                design: { status: 'pending', total: 0, firstPayment: 0, offerApproved: false, contractSigned: false },
                designImages: [],
                quotationItems: [],
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                invoices: []
            };

            if(targetStatus === 'measurements') {
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم التحويل لقسم القياسات' });
                // Ensure appointment is set if sending to measurements
                if(!client.appointment.date && newClientForm.measureRequest.date) {
                    client.appointment = { date: newClientForm.measureRequest.date, time: newClientForm.measureRequest.time, status: 'scheduled' };
                }
            }

            clients.unshift(client);
            
            newClientForm = { 
                code: generateCode(), 
                name: '', phone: '', whatsapp: '', email: '', address: '', location: '', 
                type: 'أفراد', source: 'social', taxId: '', clientStatus: 'potential',
                projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 },
                customProjects: [],
                notes: '',
                measureRequest: { date: '', time: '', isPaid: false, amount: 0 }
            };
            
            saveClients();
            alert('تم الحفظ بنجاح');
        }

        function sendToMeasurements() {
            // Check if measurement request exists
            if(!newClientForm.measureRequest.date && !newClientForm.measureRequest.time) {
                if(!confirm('لم يتم تحديد موعد لرفع المقاسات. هل تريد المتابعة وإرسال العميل لقائمة الانتظار في قسم المقاسات؟')) return;
            }
            
            if(confirm('هل أنت متأكد من حفظ البيانات وإرسالها لقسم رفع المقاسات؟')) {
                saveNewClient('measurements');
            }
        }

        function notifyClient() {
            const phone = newClientForm.whatsapp || newClientForm.phone;
            if(!phone) return alert('يرجى إدخال رقم الجوال أو الواتساب أولاً');
            
            const msg = `مرحباً ${newClientForm.name}،\nسعدنا بتواصلك مع بيت الخزائن.\nتم تسجيل بياناتك بنجاح برقم ملف: ${newClientForm.code}\nسيقوم فريقنا بالتواصل معك قريباً.`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function selectClientForMeasure(id) { selectedClientId = id; render(); }
        function selectClientForDesign(id) { selectedClientForDesignId = id; render(); }
        function selectClientForPricing(id) { 
            selectedClientForPricingId = id; 
            const client = clients.find(c => c.id == id);
            
            // استيراد البنود تلقائياً من تفاصيل المشروع إذا كانت القائمة فارغة
            if (client && (!client.quotationItems || client.quotationItems.length === 0)) {
                const items = [];
                const map = { kitchen: 'مطبخ', bedroom: 'غرفة نوم', cladding: 'تجليد', doors: 'أبواب', vanity: 'خزائن', tvUnit: 'وحدة TV' };
                
                if (client.projectDetails) {
                    Object.entries(client.projectDetails).forEach(([key, count]) => {
                        if (count > 0) {
                            items.push({ name: map[key] || key, qty: parseInt(count), price: 0 });
                        }
                    });
                }
                
                if (client.customProjects) {
                    client.customProjects.forEach(p => {
                        items.push({ name: p.name, qty: parseInt(p.qty), price: 0 });
                    });
                }
                
                if (items.length > 0) {
                    client.quotationItems = items;
                    saveClients();
                }
            }
            render(); 
        }
        function selectClientForInstall(id) { selectedClientForInstallId = id; render(); }

        function saveAppointment() {
            if (!selectedClientId) return;
            const date = document.getElementById('measure-date').value;
            const time = document.getElementById('measure-time').value;
            if(!date || !time) return alert('يرجى تحديد التاريخ والوقت');
            
            const client = clients.find(c => c.id == selectedClientId);
            if(client) {
                client.appointment = { date, time, status: 'scheduled' };
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: `تم تحديد موعد قياس: ${date} ${time}` });
                saveClients();
                alert('تم حفظ الموعد بنجاح');
            }
        }

        function getMeasurementItems(client) {
            let items = [];
            if (client.customProjects && client.customProjects.length > 0) {
                client.customProjects.forEach((p, i) => items.push({ id: `custom-${i}`, label: `${p.name} (العدد: ${p.qty})` }));
            }
            
            const map = { kitchen: 'مطبخ', bedroom: 'غرفة نوم', cladding: 'تجليد', doors: 'أبواب', vanity: 'خزائن', tvUnit: 'وحدة TV' };
            if (client.projectDetails) {
                Object.entries(client.projectDetails).forEach(([key, count]) => {
                    if (count > 0) {
                        for(let i=1; i<=count; i++) items.push({ id: `${key}-${i}`, label: `${map[key] || key} ${count > 1 ? i : ''}` });
                    }
                });
            }
            return items;
        }

        function getMeasurementCroquis(client) {
            if(!client.measurements.itemFiles) return [];
            let files = [];
            Object.values(client.measurements.itemFiles).forEach(arr => files.push(...arr.filter(f => f.category === 'croquis')));
            return files;
        }

        function getSitePhotos(client) {
            if(!client.measurements.itemFiles) return [];
            let files = [];
            Object.values(client.measurements.itemFiles).forEach(arr => files.push(...arr.filter(f => f.category === 'site')));
            return files;
        }

        function handleSaveMeasurements() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (client) {
                client.measurements.status = 'completed';
                client.measurements.date = new Date().toLocaleDateString('en-US');
                client.status = 'measurements';
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم رفع المقاسات' });
                saveClients();
                render();
                alert('تم حفظ المقاسات وتحديث الحالة');
            }
        }

        function sendToDesign() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (client) {
                if(client.measurements.status !== 'completed') {
                    if(!confirm('لم يتم تأكيد رفع المقاسات بعد. هل تريد المتابعة؟')) return;
                }
                client.status = 'design';
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم التحويل لقسم التصميم' });
                saveClients();
                render();
                alert('تم إرسال العميل لقسم التصميم');
            }
        }

        function notifyClientMeasurement() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if(client) {
                let msg = `مرحباً ${client.name}،\n`;
                if(client.appointment && client.appointment.status === 'scheduled') {
                    msg += `تم تحديد موعد لرفع المقاسات بتاريخ ${client.appointment.date} الساعة ${client.appointment.time}.`;
                } else if (client.measurements.status === 'completed') {
                    msg += `تم الانتهاء من رفع المقاسات بنجاح، وجاري العمل على التصميم.`;
                } else {
                    msg += `نود إبلاغك بمستجدات مشروعك لدى بيت الخزائن.`;
                }
                const url = `https://wa.me/${client.phone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            }
        }

        function handleMeasurementUpload(input, itemId, type) {
            if (!selectedClientId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (!client) return;

            if (!client.measurements.itemFiles) client.measurements.itemFiles = {};
            if (!client.measurements.itemFiles[itemId]) client.measurements.itemFiles[itemId] = [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    client.measurements.itemFiles[itemId].push({
                        type: file.type,
                        url: e.target.result,
                        name: file.name,
                        category: type // 'site' or 'croquis'
                    });
                    saveClients();
                };
                reader.readAsDataURL(file);
            });
        }

        function deleteMeasurementFile(itemId, idx) {
            const client = clients.find(c => c.id == selectedClientId);
            if (client && client.measurements.itemFiles && client.measurements.itemFiles[itemId]) {
                if(confirm('هل أنت متأكد من حذف هذا الملف؟')) {
                    client.measurements.itemFiles[itemId].splice(idx, 1);
                    saveClients();
                }
            }
        }

        // Design Images Logic
        function handleDesignImageUpload(input) {
            if (!selectedClientForDesignId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (!client) return;

            if (!client.designImages) client.designImages = [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    client.designImages.push(e.target.result);
                    saveClients();
                    render(); // Re-render to show images
                };
                reader.readAsDataURL(file);
            });
        }

        function deleteDesignImage(idx) {
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (client && client.designImages) {
                if(confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                    client.designImages.splice(idx, 1);
                    saveClients();
                    render();
                }
            }
        }

        function handleItemDesignUpload(input, itemId) {
            if (!selectedClientForDesignId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (!client) return;

            if (!client.design.itemFiles) client.design.itemFiles = {};
            if (!client.design.itemFiles[itemId]) client.design.itemFiles[itemId] = [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    client.design.itemFiles[itemId].push({
                        type: file.type,
                        url: e.target.result,
                        name: file.name
                    });
                    saveClients();
                    render();
                };
                reader.readAsDataURL(file);
            });
        }

        function deleteItemDesignImage(itemId, idx) {
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (client && client.design.itemFiles && client.design.itemFiles[itemId]) {
                if(confirm('هل أنت متأكد من حذف هذا الملف؟')) {
                    client.design.itemFiles[itemId].splice(idx, 1);
                    saveClients();
                    render();
                }
            }
        }

        function updateDesignStatus(status) {
            if (!selectedClientForDesignId) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (client) {
                client.design.status = status;
                saveClients();
                render();
                
                // WhatsApp Notification
                let msg = '';
                if(status === 'approved') msg = `مرحباً ${client.name}،\nتم اعتماد التصميم الخاص بكم ✅\nسنقوم الآن بتجهيز عرض السعر والعقد.`;
                else if(status === 'review') msg = `مرحباً ${client.name}،\nتم تحويل التصميم للمراجعة ⏳`;
                else if(status === 'rejected') msg = `مرحباً ${client.name}،\nتم استلام ملاحظاتكم للتعديل على التصميم 📝`;
                
                if(msg && confirm('هل تريد إرسال إشعار للعميل عبر واتساب؟')) {
                    const phone = client.whatsapp || client.phone;
                    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
                    window.open(url, '_blank');
                }
            }
        }

        function saveDesignWork() {
            if (!selectedClientForDesignId) return;
            saveClients();
            alert('تم حفظ العمل بنجاح. يمكنك العودة للتعديل في أي وقت.');
        }

        function sendToPricing() {
            if (!selectedClientForDesignId) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if(client) {
                if(client.design.status !== 'approved') {
                    if(!confirm('حالة التصميم ليست "موافقة". هل أنت متأكد من الإرسال للتسعير؟')) return;
                }
                switchTab('pricing');
                selectClientForPricing(client.id);
            }
        }

        function createDesignPackage() {
            if (!selectedClientForDesignId) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (!client) return;

            // Notify user
            const btn = document.activeElement;
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin inline"></i> جاري المعالجة...';
            lucide.createIcons();

            // Create temp container
            const element = document.createElement('div');
            element.style.width = '800px';
            element.style.padding = '40px';
            element.style.direction = 'rtl';
            element.style.fontFamily = 'Cairo, sans-serif';
            element.style.background = 'white';
            
            // Header
            let html = `
                <div style="text-align:center; margin-bottom:40px; border-bottom:2px solid #0f3057; padding-bottom:20px;">
                    <h1 style="color:#0f3057; margin:0;">${companySettings.name}</h1>
                    <p style="color:#64748b;">ملف التصميم والمواصفات الفنية</p>
                </div>
                <div style="background:#f8fafc; padding:20px; border-radius:10px; margin-bottom:30px; border:1px solid #e2e8f0;">
                    <table style="width:100%; border-collapse:collapse;">
                        <tr>
                            <td style="padding:8px; font-weight:bold; color:#0f3057;">العميل:</td>
                            <td style="padding:8px;">${client.name}</td>
                            <td style="padding:8px; font-weight:bold; color:#0f3057;">الكود:</td>
                            <td style="padding:8px;">${client.code}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; font-weight:bold; color:#0f3057;">الجوال:</td>
                            <td style="padding:8px;">${client.phone}</td>
                            <td style="padding:8px; font-weight:bold; color:#0f3057;">التاريخ:</td>
                            <td style="padding:8px;">${new Date().toLocaleDateString('ar-EG')}</td>
                        </tr>
                    </table>
                </div>
            `;

            // Content
            const items = getMeasurementItems(client);
            let hasContent = false;

            items.forEach(item => {
                const designFiles = (client.design?.itemFiles && client.design.itemFiles[item.id]) || [];
                const measureFiles = (client.measurements?.itemFiles && client.measurements.itemFiles[item.id]) || [];
                const allFiles = [...designFiles, ...measureFiles].filter(f => f.type.startsWith('image'));

                if(allFiles.length > 0) {
                    hasContent = true;
                    html += `
                        <div style="margin-bottom:30px; page-break-inside:avoid;">
                            <h3 style="color:#0f3057; border-right:4px solid #f97316; padding-right:10px; margin-bottom:15px;">${item.label}</h3>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    `;
                    
                    allFiles.forEach(f => {
                        html += `
                            <div style="border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
                                <img src="${f.url}" style="width:100%; height:250px; object-fit:cover;">
                                <div style="padding:8px; background:#f1f5f9; text-align:center; font-size:12px;">${f.name}</div>
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                }
            });

            if(!hasContent) {
                html += `<div style="text-align:center; padding:40px; color:#94a3b8;">لا توجد صور أو تصاميم متاحة لهذا العميل.</div>`;
            }

            // Footer
            html += `
                <div style="margin-top:50px; padding-top:20px; border-top:1px solid #e2e8f0; text-align:center; font-size:12px; color:#94a3b8;">
                    تم إنشاء هذا الملف بواسطة نظام CRP
                </div>
            `;

            element.innerHTML = html;

            // Generate PDF
            const opt = {
                margin: 10,
                filename: `Design_Package_${client.code}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
            }).catch(err => {
                console.error(err);
                alert('حدث خطأ أثناء إنشاء الملف');
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
            });
        }

        function downloadFiles(type) {
            let clientId = null;
            if (activeTab === 'design') clientId = selectedClientForDesignId;
            else if (activeTab === 'pricing') clientId = selectedClientForPricingId;
            else if (activeTab === 'installation') clientId = selectedClientForInstallId;
            
            if (!clientId) return alert('يرجى اختيار عميل أولاً');
            
            const client = clients.find(c => c.id == clientId);
            if (!client) return;

            const items = getMeasurementItems(client);
            let groupedData = [];
            let totalFiles = 0;

            items.forEach(item => {
                let itemFiles = [];
                if (type === 'measurements') {
                     if (client.measurements?.itemFiles?.[item.id]) {
                        itemFiles = client.measurements.itemFiles[item.id];
                     }
                } else {
                     if (client.design?.itemFiles?.[item.id]) {
                        itemFiles = client.design.itemFiles[item.id];
                     }
                }

                if (itemFiles.length > 0) {
                    groupedData.push({ name: item.label, files: itemFiles });
                    totalFiles += itemFiles.length;
                }
            });

            if (totalFiles === 0) return alert('لا توجد ملفات متاحة للتحميل');

            // Create a simple HTML page to display/download files
            const win = window.open('', '_blank');
            win.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تحميل ملفات ${type === 'measurements' ? 'المقاسات' : 'التصميم'} - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        :root { --primary: #0f3057; --bg: #f8f9fc; }
                        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); margin: 0; padding: 40px; color: #334155; }
                        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
                        .header h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 24px; }
                        .header p { color: #64748b; margin: 0; font-size: 14px; }
                        .client-info { background: #f1f5f9; padding: 20px; border-radius: 12px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; margin-bottom: 40px; }
                        .info-item h3 { font-size: 11px; color: #64748b; margin: 0 0 5px 0; text-transform: uppercase; }
                        .info-item p { font-size: 15px; font-weight: bold; color: var(--primary); margin: 0; }
                        
                        .section-title { font-size: 18px; font-weight: bold; color: var(--primary); margin: 30px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; }
                        .section-title span { background: #e0f2fe; color: #0284c7; padding: 5px 10px; border-radius: 8px; font-size: 12px; }

                        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
                        .card { border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; background: white; }
                        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
                        .preview { height: 160px; background: #f8fafc; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 1px solid #e2e8f0; position: relative; }
                        .preview img { width: 100%; height: 100%; object-fit: cover; }
                        .preview video { width: 100%; height: 100%; object-fit: cover; }
                        .preview .icon { font-size: 40px; }
                        .details { padding: 12px; }
                        .filename { font-size: 13px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; color: #334155; text-decoration: none; }
                        .type { font-size: 10px; color: #94a3b8; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; display: inline-block; }
                        .actions { margin-top: 10px; display: flex; gap: 8px; }
                        .btn { flex: 1; text-align: center; padding: 6px 0; font-size: 11px; border-radius: 6px; text-decoration: none; font-weight: bold; transition: background 0.2s; cursor: pointer; border: none; display: inline-block; }
                        .btn-download { background: #eff6ff; color: #2563eb; }
                        .btn-download:hover { background: #dbeafe; }
                        .btn-view { background: #f8fafc; color: #475569; }
                        .btn-view:hover { background: #f1f5f9; }
                        .print-btn { display: block; width: 200px; margin: 40px auto 0; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-family: inherit; font-weight: bold; cursor: pointer; transition: background 0.2s; }
                        .print-btn:hover { background: #1e40af; }
                        .footer { margin-top: 40px; text-align: center; font-size: 11px; color: #94a3b8; }
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; padding: 0; max-width: 100%; }
                            .print-btn, .actions { display: none; }
                            .card { break-inside: avoid; border: 1px solid #ccc; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>ملفات ${type === 'measurements' ? 'المقاسات والموقع' : 'التصميم المعتمدة'}</h1>
                            <p>${companySettings.name} - نظام إدارة العملاء</p>
                        </div>
                        <div class="client-info">
                            <div class="info-item"><h3>العميل</h3><p>${client.name}</p></div>
                            <div class="info-item"><h3>رقم الملف</h3><p>${client.code}</p></div>
                            <div class="info-item"><h3>عدد الملفات</h3><p>${totalFiles} ملف</p></div>
                            <div class="info-item"><h3>التاريخ</h3><p>${new Date().toLocaleDateString('ar-EG')}</p></div>
                        </div>
                        
                        ${groupedData.map(group => `
                            <div class="section-title">
                                ${group.name} <span>${group.files.length} ملفات</span>
                            </div>
                            <div class="grid">
                                ${group.files.map(f => {
                                    let preview = f.type.startsWith('image') ? `<img src="${f.url}">` : (f.type.startsWith('video') ? `<video src="${f.url}"></video><div style="position:absolute;color:white;background:rgba(0,0,0,0.5);padding:5px;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">▶</div>` : `<div class="icon">${f.type.includes('pdf') ? '📄' : '📁'}</div>`);
                                    return `<div class="card"><div class="preview">${preview}</div><div class="details"><div class="filename" title="${f.name}">${f.name || 'بدون اسم'}</div><span class="type">${f.type.startsWith('image') ? 'صورة' : (f.type.includes('pdf') ? 'مستند' : 'ملف')}</span><div class="actions"><a href="${f.url}" download="${f.name || 'file'}" class="btn btn-download">تحميل</a><a href="${f.url}" target="_blank" class="btn btn-view">عرض</a></div></div></div>`;
                                }).join('')}
                            </div>
                        `).join('')}

                        <button onclick="window.print()" class="print-btn">طباعة / حفظ كـ PDF</button>
                        <div class="footer"><p>تم استخراج هذا التقرير من نظام CRP</p></div>
                    </div>
                </body>
                </html>
            `);
        }

        function updatePricingRemaining(paid, total) {
            const remaining = total - (parseFloat(paid) || 0);
            const el = document.getElementById('pricing-remaining');
            if(el) el.innerHTML = `${remaining.toLocaleString()} <span class="text-xs font-normal">${companySettings.currency || 'SAR'}</span>`;
        }

        function updateItemDesignNote(itemId, note) {
            if (!selectedClientForDesignId) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (client) {
                if (!client.design.itemNotes) client.design.itemNotes = {};
                client.design.itemNotes[itemId] = note;
                saveClients();
            }
        }

        // Pricing Logic
        function addPricingItem() {
            if(!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if(!client.quotationItems) client.quotationItems = [];
            client.quotationItems.push({ name: '', qty: 1, price: 0 });
            render();
        }

        function resetPricingItems() {
            if(!selectedClientForPricingId) return;
            if(!confirm('هل أنت متأكد من إعادة تعيين البنود؟ سيتم حذف التعديلات الحالية واسترجاع البنود من تفاصيل المشروع.')) return;
            
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if(!client) return;

            const items = [];
            const map = { kitchen: 'مطبخ', bedroom: 'غرفة نوم', cladding: 'تجليد', doors: 'أبواب', vanity: 'خزائن', tvUnit: 'وحدة TV' };
            
            if (client.projectDetails) {
                Object.entries(client.projectDetails).forEach(([key, count]) => {
                    if (count > 0) {
                        items.push({ name: map[key] || key, qty: parseInt(count), price: 0 });
                    }
                });
            }
            
            if (client.customProjects) {
                client.customProjects.forEach(p => {
                    items.push({ name: p.name, qty: parseInt(p.qty), price: 0 });
                });
            }
            
            client.quotationItems = items;
            saveClients();
            render();
        }

        function removePricingItem(idx) {
            const client = clients.find(c => c.id == selectedClientForPricingId);
            client.quotationItems.splice(idx, 1);
            render();
        }

        function updatePricingItem(idx, field, value) {
            const client = clients.find(c => c.id == selectedClientForPricingId);
            client.quotationItems[idx][field] = field === 'name' ? value : parseFloat(value);
            // Re-render to update totals
            render();
        }

        function savePricingData() {
            if (!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if (client) {
                const items = client.quotationItems || [];
                const subTotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
                const taxRate = parseFloat(companySettings.taxRate) || 0;
                const total = subTotal + (subTotal * (taxRate / 100));
                const first = document.getElementById('pricing-first-payment').value;
                
                const offerApproved = document.getElementById('offer-approved').checked;
                const contractSigned = document.getElementById('contract-signed').checked;
                const installDate = document.getElementById('contract-install-date').value;

                client.design.total = total;
                client.design.firstPayment = first;
                client.design.offerApproved = offerApproved;
                client.design.contractSigned = contractSigned;
                
                if(installDate) {
                    if(!client.installation) client.installation = {};
                    client.installation.startDate = installDate;
                }
                
                saveClients();
                render();
                alert('تم حفظ عرض السعر بنجاح');
            }
        }

        function sendToInstallationFromPricing() {
            if (!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if(client) {
                if(!client.design.contractSigned) return alert('يجب توقيع العقد أولاً قبل الإرسال للتركيب');
                client.status = 'installation'; // Move to installation phase
                saveClients();
                render();
                alert('تم إرسال العميل لمرحلة التركيب');
            }
        }

        function generateContract() {
            if (!selectedClientForPricingId) return;
            alert('جاري إنشاء العقد...');
        }

        // Accounts Functions
        function addExpense() {
            const category = document.getElementById('exp-category').value;
            const amount = document.getElementById('exp-amount').value;
            const date = document.getElementById('exp-date').value;
            const desc = document.getElementById('exp-desc').value;

            if(!amount || !date) return alert('يرجى إدخال المبلغ والتاريخ');

            expenses.push({
                id: Date.now(),
                category,
                amount: parseFloat(amount),
                date,
                description: desc
            });
            saveExpenses();
            alert('تم إضافة المصروف بنجاح');
        }

        function deleteExpense(id) {
            if(confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses();
            }
        }

        // User Management Functions
        function addNewUser() {
            const name = document.getElementById('user-name-input').value;
            const username = document.getElementById('user-username-input').value;
            const password = document.getElementById('user-password-input').value;
            const role = document.getElementById('user-role-input').value;

            if(!name || !username || !password) return alert('يرجى إدخال جميع البيانات');
            if(users.some(u => u.username === username)) return alert('اسم المستخدم موجود مسبقاً');

            users.push({
                id: Date.now(),
                name,
                username,
                password,
                role
            });
            saveUsers();
            alert('تم إضافة المستخدم بنجاح');
        }

        function deleteUser(id) {
            if(id === 1) return alert('لا يمكن حذف المدير الرئيسي');
            if(confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                users = users.filter(u => u.id !== id);
                saveUsers();
            }
        }

        function handleSaveInstallation() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                client.installation.jobNo = document.getElementById('install-job').value;
                client.installation.startDate = document.getElementById('install-start').value;
                client.installation.lastPayment = document.getElementById('install-last-pay').value;
                client.status = 'installation';
                saveClients();
                alert('تم جدولة التركيب بنجاح');
            }
        }

        function renderEditCounter(label, key, value) {
            return `
                <div class="flex flex-col bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-600 items-center">
                    <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1">${label}</span>
                    <div class="flex items-center gap-2">
                        <button onclick="adjustEditCount('${key}', -1)" class="w-6 h-6 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded hover:bg-red-100 text-slate-600 dark:text-slate-300 font-bold">-</button>
                        <span id="edit-count-${key}" class="font-bold text-sm dark:text-white w-4 text-center">${value}</span>
                        <button onclick="adjustEditCount('${key}', 1)" class="w-6 h-6 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded hover:bg-green-100 text-slate-600 dark:text-slate-300 font-bold">+</button>
                    </div>
                </div>
            `;
        }

        function adjustEditCount(key, delta) {
            const el = document.getElementById(`edit-count-${key}`);
            if(el) {
                let val = parseInt(el.textContent) || 0;
                val = Math.max(0, val + delta);
                el.textContent = val;
            }
        }

        function renderEditCustomItemsList(client) {
            if (!client.customProjects || client.customProjects.length === 0) {
                return '<p class="text-sm text-slate-400 text-center py-2 italic">لم يتم إضافة بنود بعد</p>';
            }
            return client.customProjects.map((item, idx) => `
                <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-700 shadow-sm text-sm">
                    <span class="font-medium text-slate-700 dark:text-slate-200">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">${item.qty}</span>
                        <button onclick="removeEditCustomItem(${client.id}, ${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function addEditCustomItem(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;
            const nameInput = document.getElementById('edit-custom-name');
            const qtyInput = document.getElementById('edit-custom-qty');
            const name = nameInput.value;
            const qty = parseInt(qtyInput.value);
            if(name && qty > 0) {
                if(!client.customProjects) client.customProjects = [];
                client.customProjects.push({ name, qty });
                nameInput.value = '';
                qtyInput.value = '';
                nameInput.focus();
                document.getElementById('edit-custom-list').innerHTML = renderEditCustomItemsList(client);
                lucide.createIcons();
            }
        }

        function removeEditCustomItem(id, idx) {
            const client = clients.find(c => c.id === id);
            if(client && client.customProjects) {
                client.customProjects.splice(idx, 1);
                document.getElementById('edit-custom-list').innerHTML = renderEditCustomItemsList(client);
                lucide.createIcons();
            }
        }

        function openEditClientModal(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;
            const modal = document.getElementById('editClientModal');
            const pd = client.projectDetails || { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 };
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-scaleIn flex flex-col transition-colors">
                    <div class="bg-orange-500 text-white p-4 flex justify-between items-center">
                        <h2 class="text-lg font-bold">تعديل بيانات العميل: ${client.name}</h2>
                        <button onclick="document.getElementById('editClientModal').classList.add('hidden')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[80vh] space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="form-label">الاسم</label>
                                <input type="text" id="edit-name" value="${client.name}" class="form-input">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">الجوال</label>
                                <input type="text" id="edit-phone" value="${client.phone}" class="form-input">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">العنوان</label>
                                <input type="text" id="edit-address" value="${client.address}" class="form-input">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">الموقع (رابط)</label>
                                <input type="text" id="edit-location" value="${client.location || ''}" class="form-input">
                            </div>
                        </div>

                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                            <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4"></i> تعديل تفاصيل المشروع (المطلوب)</h4>
                            <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                                ${renderEditCounter('مطبخ', 'kitchen', pd.kitchen || 0)}
                                ${renderEditCounter('نوم', 'bedroom', pd.bedroom || 0)}
                                ${renderEditCounter('تجليد', 'cladding', pd.cladding || 0)}
                                ${renderEditCounter('أبواب', 'doors', pd.doors || 0)}
                                ${renderEditCounter('خزائن', 'vanity', pd.vanity || 0)}
                                ${renderEditCounter('TV', 'tvUnit', pd.tvUnit || 0)}
                            </div>
                        </div>

                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                            <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm flex items-center gap-2"><i data-lucide="plus-square" class="w-4 h-4"></i> بنود مخصصة (إضافية)</h4>
                            <div class="flex gap-2 items-end mb-3">
                                <div class="flex-1">
                                    <label class="text-xs text-slate-500 mb-1 block">اسم البند</label>
                                    <input type="text" id="edit-custom-name" class="form-input text-sm" placeholder="مثال: مكتبة..">
                                </div>
                                <div class="w-20">
                                    <label class="text-xs text-slate-500 mb-1 block">العدد</label>
                                    <input type="number" id="edit-custom-qty" class="form-input text-sm" placeholder="0">
                                </div>
                                <button onclick="addEditCustomItem(${client.id})" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors h-[38px] w-[38px] flex items-center justify-center"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div id="edit-custom-list" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar">
                                ${renderEditCustomItemsList(client)}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                            <h4 class="font-bold text-blue-800 mb-3 text-sm">تحديث طلب المقاسات</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">تاريخ الزيارة</label>
                                    <input type="date" id="edit-measure-date" value="${client.appointment?.date || ''}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">الوقت</label>
                                    <input type="time" id="edit-measure-time" value="${client.appointment?.time || ''}" class="form-input">
                                </div>
                                <div class="flex items-center gap-2 mt-4">
                                    <input type="checkbox" id="edit-measure-paid" ${client.measureRequest?.isPaid ? 'checked' : ''} class="w-4 h-4">
                                    <label class="text-sm">مدفوع؟</label>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">المبلغ</label>
                                    <input type="number" id="edit-measure-amount" value="${client.measureRequest?.amount || 0}" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-2">
                        <button onclick="updateClient(${client.id})" class="bg-[#0f3057] text-white px-6 py-2 rounded-lg font-bold hover:bg-[#1a4b82]">حفظ التعديلات</button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function updateClient(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            client.name = document.getElementById('edit-name').value;
            client.phone = document.getElementById('edit-phone').value;
            client.address = document.getElementById('edit-address').value;
            client.location = document.getElementById('edit-location').value;
            
            // Update Project Details
            if(!client.projectDetails) client.projectDetails = {};
            ['kitchen', 'bedroom', 'cladding', 'doors', 'vanity', 'tvUnit'].forEach(key => {
                const el = document.getElementById(`edit-count-${key}`);
                if(el) client.projectDetails[key] = parseInt(el.textContent) || 0;
            });
            
            const mDate = document.getElementById('edit-measure-date').value;
            const mTime = document.getElementById('edit-measure-time').value;
            const mPaid = document.getElementById('edit-measure-paid').checked;
            const mAmount = document.getElementById('edit-measure-amount').value;

            if(mDate) {
                client.appointment = { date: mDate, time: mTime, status: 'scheduled' };
                client.measureRequest = { date: mDate, time: mTime, isPaid: mPaid, amount: mAmount };
                
                // If client was potential, move to measurements automatically if date is set
                if(client.status === 'potential' || client.status === 'new') {
                    if(confirm('تم تحديد موعد مقاسات. هل تريد نقل العميل لقائمة "رفع المقاسات"؟')) {
                        client.status = 'measurements';
                    }
                }
            }

            saveClients();
            render();
            document.getElementById('editClientModal').classList.add('hidden');
            alert('تم تحديث البيانات بنجاح');
        }

        function openClientModal(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;
            const modal = document.getElementById('clientModal');
            
            // Prepare Project Details HTML
            let projectHtml = '';
            // Handle legacy projectDetails
            if(client.projectDetails && Object.values(client.projectDetails).some(v => v > 0)) {
                Object.entries(client.projectDetails).forEach(([k, v]) => {
                    if(v > 0) {
                        const label = k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة نوم' : k === 'cladding' ? 'تجليد' : k === 'doors' ? 'أبواب' : k === 'vanity' ? 'خزائن' : k === 'tvUnit' ? 'وحدة TV' : k;
                        projectHtml += `<span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-sm font-bold border border-blue-100">${label}: ${v}</span>`;
                    }
                });
            }
            // Handle customProjects
            if(client.customProjects && client.customProjects.length > 0) {
                client.customProjects.forEach(p => {
                    projectHtml += `<span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-sm font-bold border border-blue-100">${p.name}: ${p.qty}</span>`;
                });
            }
            if(!projectHtml) projectHtml = '<span class="text-slate-400 italic">لا توجد تفاصيل مسجلة</span>';

            // Prepare Quotation HTML
            let quotationHtml = '';
            if(client.quotationItems && client.quotationItems.length > 0) {
                quotationHtml = `
                    <div class="mt-6">
                        <h3 class="font-bold text-slate-800 dark:text-white mb-3 flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i> تفاصيل عرض السعر</h3>
                        <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">
                                    <tr>
                                        <th class="p-2">البند</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                    ${client.quotationItems.map(item => `
                                        <tr>
                                            <td class="p-2 dark:text-slate-300">${item.name}</td>
                                            <td class="p-2 dark:text-slate-300">${item.qty}</td>
                                            <td class="p-2 dark:text-slate-300">${item.price.toLocaleString()}</td>
                                            <td class="p-2 font-bold dark:text-slate-200">${(item.qty * item.price).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // Prepare Files HTML
            let filesHtml = '';
            const measureFiles = getMeasurementCroquis(client).concat(getSitePhotos(client));
            const designFiles = [];
            if(client.design?.itemFiles) {
                Object.values(client.design.itemFiles).forEach(arr => designFiles.push(...arr));
            }
            
            if(measureFiles.length > 0 || designFiles.length > 0) {
                filesHtml = `
                    <div class="mt-6">
                        <h3 class="font-bold text-slate-800 dark:text-white mb-3 flex items-center gap-2"><i data-lucide="folder" class="w-4 h-4 text-slate-400"></i> الملفات والمرفقات</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${measureFiles.map(f => `
                                <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-100 dark:border-slate-700 flex items-center gap-2">
                                    <i data-lucide="ruler" class="w-4 h-4 text-indigo-500"></i>
                                    <span class="text-xs truncate dark:text-slate-300" title="${f.name}">${f.name}</span>
                                </div>
                            `).join('')}
                            ${designFiles.map(f => `
                                <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-100 dark:border-slate-700 flex items-center gap-2">
                                    <i data-lucide="image" class="w-4 h-4 text-purple-500"></i>
                                    <span class="text-xs truncate dark:text-slate-300" title="${f.name}">${f.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-scaleIn max-h-[90vh] flex flex-col transition-colors">
                    <!-- Header -->
                    <div class="bg-[#0f3057] text-white p-6 flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-2xl font-bold">${client.name}</h2>
                                <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-mono">${client.code}</span>
                                <span class="bg-white/10 px-2 py-0.5 rounded text-xs">${getStatusLabel(client.status)}</span>
                            </div>
                            <div class="flex flex-wrap gap-4 text-sm text-blue-200">
                                <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${client.phone}</span>
                                ${client.email ? `<span class="flex items-center gap-1"><i data-lucide="mail" class="w-3 h-3"></i> ${client.email}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="document.getElementById('clientModal').classList.add('hidden')" class="hover:bg-white/10 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>

                    <!-- Body -->
                    <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                        
                        <!-- Info Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">البيانات الأساسية</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between"><span class="text-slate-500">النوع:</span> <span class="font-medium dark:text-slate-200">${client.type}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500">المصدر:</span> <span class="font-medium dark:text-slate-200">${client.source || '-'}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500">الرقم الضريبي:</span> <span class="font-mono dark:text-slate-200">${client.taxId || '-'}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500">العنوان:</span> <span class="font-medium dark:text-slate-200 truncate w-32 text-left" title="${client.address}">${client.address || '-'}</span></div>
                                    ${client.location ? `<div class="flex justify-between items-center"><span class="text-slate-500">الموقع:</span> <a href="${client.location}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> الخريطة</a></div>` : ''}
                                </div>
                            </div>

                            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700 md:col-span-2">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">تفاصيل المشروع</h3>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${projectHtml}
                                </div>
                                ${client.notes ? `
                                    <div class="pt-3 border-t border-slate-200 dark:border-slate-700">
                                        <p class="text-xs text-slate-400 mb-1">ملاحظات:</p>
                                        <p class="text-sm text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-600">${client.notes}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Workflow Status -->
                        <div>
                            <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="git-commit" class="w-5 h-5 text-blue-500"></i> مسار العمل</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Measurements -->
                                <div class="border rounded-xl p-4 ${client.measurements.status === 'completed' ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm flex items-center gap-2 dark:text-slate-200">
                                            <i data-lucide="ruler" class="w-4 h-4"></i> المقاسات
                                        </span>
                                        ${client.measurements.status === 'completed' ? '<i data-lucide="check" class="w-4 h-4 text-green-600"></i>' : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mb-1">الحالة: <span class="font-bold dark:text-slate-300">${client.measurements.status === 'completed' ? 'مكتمل' : 'معلق'}</span></p>
                                    ${client.appointment && client.appointment.date ? `<p class="text-[10px] text-slate-400">موعد: ${client.appointment.date} ${client.appointment.time}</p>` : ''}
                                    ${client.measureRequest && client.measureRequest.date ? `
                                        <div class="mt-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                                            <p class="text-[10px] font-bold text-slate-600">طلب العميل:</p>
                                            <p class="text-[10px] text-slate-500">${client.measureRequest.date} - ${client.measureRequest.time}</p>
                                            ${client.measureRequest.isPaid ? `<span class="text-[10px] text-green-600 font-bold">مدفوع (${client.measureRequest.amount})</span>` : '<span class="text-[10px] text-slate-400">غير مدفوع</span>'}
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Design -->
                                <div class="border rounded-xl p-4 ${client.design.contractSigned ? 'bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm flex items-center gap-2 dark:text-slate-200">
                                            <i data-lucide="pen-tool" class="w-4 h-4"></i> التصميم
                                        </span>
                                        ${client.design.contractSigned ? '<i data-lucide="check" class="w-4 h-4 text-purple-600"></i>' : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mb-1">الحالة: <span class="font-bold dark:text-slate-300">${client.design.contractSigned ? 'تم التعاقد' : 'جاري العمل'}</span></p>
                                    ${client.design.total > 0 ? `<p class="text-[10px] text-slate-400">العقد: ${parseInt(client.design.total).toLocaleString()} ريال</p>` : ''}
                                </div>

                                <!-- Installation -->
                                <div class="border rounded-xl p-4 ${client.installation.startDate ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm flex items-center gap-2 dark:text-slate-200">
                                            <i data-lucide="hammer" class="w-4 h-4"></i> التركيب
                                        </span>
                                    </div>
                                    <p class="text-xs text-slate-500 mb-1">الحالة: <span class="font-bold dark:text-slate-300">${client.installation.startDate ? 'مجدول' : 'لم يحدد'}</span></p>
                                    ${client.installation.startDate ? `<p class="text-[10px] text-slate-400">تاريخ: ${client.installation.startDate}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${quotationHtml}
                        
                        ${filesHtml}

                        <!-- Logs -->
                        <div>
                            <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-slate-400"></i> سجل النشاطات</h3>
                            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-700 p-4 max-h-48 overflow-y-auto custom-scrollbar space-y-3">
                                ${client.logs && client.logs.length > 0 ? client.logs.map(log => `
                                    <div class="flex gap-3 text-sm items-start">
                                        <span class="text-slate-400 text-[10px] font-mono whitespace-nowrap bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 mt-0.5">${log.date}</span>
                                        <p class="text-slate-600 dark:text-slate-300 leading-tight">${log.text}</p>
                                    </div>
                                `).join('') : '<p class="text-slate-400 text-sm italic text-center">لا يوجد سجل نشاط</p>'}
                            </div>
                        </div>

                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-slate-50 dark:bg-slate-900 p-4 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                        <button onclick="document.getElementById('clientModal').classList.add('hidden')" class="px-6 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors font-bold text-sm">إغلاق</button>
                        <button onclick="openWhatsAppModal(${client.id})" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-bold text-sm flex items-center gap-2"><i data-lucide="message-circle" class="w-4 h-4"></i> مراسلة واتساب</button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        
        function printInvoice(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>عرض سعر - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 40px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 10px 0; font-size: 24px; }
                        .company-info p { margin: 2px 0; font-size: 13px; color: #64748b; }
                        .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 12px; }
                        .meta-item h3 { font-size: 12px; color: #64748b; margin: 0 0 5px 0; }
                        .meta-item p { font-size: 16px; font-weight: bold; color: #0f172a; margin: 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background: #0f3057; color: white; padding: 12px; text-align: right; font-size: 14px; }
                        td { border-bottom: 1px solid #e2e8f0; padding: 12px; font-size: 14px; color: #334155; }
                        .total-section { background: #f8fafc; padding: 20px; border-radius: 12px; margin-left: auto; width: 300px; }
                        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
                        .total-row.final { border-top: 1px solid #e2e8f0; padding-top: 10px; font-weight: bold; font-size: 18px; color: #0f3057; }
                        .footer { margin-top: 60px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                            th { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.address}</p>
                            <p>هاتف: ${companySettings.phone}</p>
                            <p>البريد الإلكتروني: ${companySettings.email}</p>
                            <p>الرقم الضريبي: ${companySettings.taxId}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="invoice-meta">
                        <div class="meta-item">
                            <h3>العميل</h3>
                            <p>${client.name}</p>
                            <p style="font-size: 12px; font-weight: normal; margin-top: 2px">${client.phone}</p>
                        </div>
                        <div class="meta-item">
                            <h3>رقم الملف</h3>
                            <p>${client.code}</p>
                        </div>
                        <div class="meta-item">
                            <h3>التاريخ</h3>
                            <p>${new Date().toLocaleDateString('en-US')}</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>الوصف</th>
                                <th width="150">القيمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <strong>عرض سعر / عقد تنفيذ أعمال</strong><br>
                                    <span style="font-size: 12px; color: #64748b">
                                        يشمل: 
                                        ${Object.entries(client.projectDetails).filter(([k,v]) => v > 0).map(([k,v]) => `${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة نوم' : k === 'cladding' ? 'تجليد' : k === 'doors' ? 'أبواب' : k === 'vanity' ? 'خزائن' : k === 'tvUnit' ? 'وحدة TV' : k} (${v})`).join('، ')}
                                        ${client.customProjects && client.customProjects.length ? '، ' + client.customProjects.map(p => `${p.name} (${p.qty})`).join('، ') : ''}
                                    </span>
                                </td>
                                <td>${parseInt(client.design.total).toLocaleString()} ${companySettings.currency || 'SAR'}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>الإجمالي</span>
                            <span>${parseInt(client.design.total).toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>
                        <div class="total-row">
                            <span>الدفعة الأولى</span>
                            <span style="color: #16a34a">${parseInt(client.design.firstPayment).toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>
                        <div class="total-row final">
                            <span>المتبقي</span>
                            <span>${(parseInt(client.design.total) - parseInt(client.design.firstPayment)).toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>
                    </div>

                    <div style="margin-top: 40px; page-break-inside: avoid;">
                        <h3 style="border-bottom: 1px solid #cbd5e1; padding-bottom: 10px; margin-bottom: 15px; color: #0f3057;">الشروط والأحكام</h3>
                        <div style="font-size: 12px; color: #334155; line-height: 1.8; white-space: pre-line;">
                            ${companySettings.contractTerms || 'لا توجد شروط إضافية.'}
                        </div>
                    </div>

                    <div class="footer">
                        <p>تم إصدار هذا المستند إلكترونياً من نظام إدارة العملاء CRP</p>
                        <p>العنوان: الرياض - طريق الملك فهد - برج العليا</p>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printReceipt(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            if(!client.design.firstPayment || client.design.firstPayment <= 0) {
                alert('لا توجد دفعة أولى مسجلة لهذا العميل لطباعة سند لها.');
                return;
            }

            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            // Prepare Project Details String
            const projectDetailsText = Object.entries(client.projectDetails)
                .filter(([k,v]) => v > 0)
                .map(([k,v]) => `${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة نوم' : k === 'cladding' ? 'تجليد' : k === 'doors' ? 'أبواب' : k === 'vanity' ? 'خزائن' : k === 'tvUnit' ? 'وحدة TV' : k} (${v})`)
                .join('، ');
            
            const customDetailsText = client.customProjects && client.customProjects.length 
                ? client.customProjects.map(p => `${p.name} (${p.qty})`).join('، ') 
                : '';

            const fullDetails = [projectDetailsText, customDetailsText].filter(Boolean).join('، ');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>سند قبض - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; border: 1px solid #eee; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 30px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 5px 0; font-size: 22px; }
                        .company-info p { margin: 2px 0; font-size: 12px; color: #64748b; }
                        .receipt-title { text-align: center; margin-bottom: 30px; }
                        .receipt-title h2 { background: #f1f5f9; display: inline-block; padding: 10px 30px; border-radius: 20px; color: #0f3057; border: 1px solid #cbd5e1; }
                        .content { line-height: 2.5; font-size: 16px; color: #334155; }
                        .field { border-bottom: 1px dotted #94a3b8; padding: 0 10px; font-weight: bold; color: #0f172a; }
                        .amount-box { border: 2px solid #0f3057; padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; background: #f8fafc; }
                        .amount-box span { font-size: 24px; font-weight: bold; color: #0f3057; }
                        .signatures { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; }
                        .sig-block { text-align: center; width: 200px; }
                        .sig-line { border-top: 1px solid #cbd5e1; margin-top: 40px; }
                        @media print {
                            body { border: none; padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.address}</p>
                            <p>هاتف: ${companySettings.phone}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="receipt-title">
                        <h2>سند قبض | RECEIPT VOUCHER</h2>
                    </div>

                    <div class="content">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>التاريخ: <span class="field">${new Date().toLocaleDateString('en-US')}</span></div>
                            <div>رقم السند: <span class="field">RV-${client.code}-${Math.floor(Math.random() * 1000)}</span></div>
                        </div>

                        <div>استلمنا من السيد/السادة: <span class="field" style="display: inline-block; min-width: 300px;">${client.name}</span></div>
                        
                        <div class="amount-box">
                            مبلغ وقدره: <span>${parseInt(client.design.firstPayment).toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>

                        <div>وذلك مقابل: <span class="field">دفعة أولى - عقد تنفيذ أعمال</span></div>
                        <div>تفاصيل المشروع: <span class="field" style="display: block; margin-top: 5px; line-height: 1.8;">${fullDetails}</span></div>
                    </div>

                    <div class="signatures">
                        <div class="sig-block">
                            <p>المحاسب</p>
                            <div class="sig-line"></div>
                        </div>
                        <div class="sig-block">
                            <p>المستلم</p>
                            <div class="sig-line"></div>
                        </div>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function openWhatsAppModal(id) {
             const c = clients.find(x => x.id === id);
             if(!c) return;
             const phone = c.whatsapp || c.phone;
             const url = `https://wa.me/${phone}`;
             window.open(url, '_blank');
        }

        function printDetailedQuotation(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            const items = client.quotationItems || [];
            const subTotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const taxRate = parseFloat(companySettings.taxRate) || 0;
            const taxAmount = subTotal * (taxRate / 100);
            const total = subTotal + taxAmount;

            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>عرض سعر تفصيلي - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 40px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 10px 0; font-size: 24px; }
                        .company-info p { margin: 2px 0; font-size: 13px; color: #64748b; }
                        .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 12px; }
                        .meta-item h3 { font-size: 12px; color: #64748b; margin: 0 0 5px 0; }
                        .meta-item p { font-size: 16px; font-weight: bold; color: #0f172a; margin: 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background: #0f3057; color: white; padding: 12px; text-align: right; font-size: 14px; }
                        td { border-bottom: 1px solid #e2e8f0; padding: 12px; font-size: 14px; color: #334155; }
                        .text-center { text-align: center; }
                        .total-section { background: #f8fafc; padding: 20px; border-radius: 12px; margin-left: auto; width: 300px; }
                        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
                        .total-row.final { border-top: 1px solid #e2e8f0; padding-top: 10px; font-weight: bold; font-size: 18px; color: #0f3057; }
                        .footer { margin-top: 60px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        @media print {
                            body { padding: 0; }
                            th { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.address}</p>
                            <p>هاتف: ${companySettings.phone}</p>
                            <p>البريد الإلكتروني: ${companySettings.email}</p>
                            <p>الرقم الضريبي: ${companySettings.taxId}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="invoice-meta">
                        <div class="meta-item">
                            <h3>العميل</h3>
                            <p>${client.name}</p>
                            <p style="font-size: 12px; font-weight: normal; margin-top: 2px">${client.phone}</p>
                        </div>
                        <div class="meta-item">
                            <h3>رقم العرض</h3>
                            <p>QT-${client.code}</p>
                        </div>
                        <div class="meta-item">
                            <h3>التاريخ</h3>
                            <p>${new Date().toLocaleDateString('en-US')}</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th width="50" class="text-center">#</th>
                                <th>البند / الوصف</th>
                                <th width="80" class="text-center">الكمية</th>
                                <th width="120">السعر الإفرادي</th>
                                <th width="120">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map((item, idx) => `
                                <tr>
                                    <td class="text-center">${idx + 1}</td>
                                    <td>${item.name}</td>
                                    <td class="text-center">${item.qty}</td>
                                    <td>${item.price.toLocaleString()}</td>
                                    <td>${(item.qty * item.price).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>المجموع قبل الضريبة</span>
                            <span>${subTotal.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>
                        <div class="total-row">
                            <span>الضريبة (${taxRate}%)</span>
                            <span>${taxAmount.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>
                        <div class="total-row final">
                            <span>المجموع الكلي</span>
                            <span>${total.toLocaleString()} ${companySettings.currency || 'SAR'}</span>
                        </div>
                    </div>

                    <div style="margin-top: 40px; page-break-inside: avoid;">
                        <h3 style="border-bottom: 1px solid #cbd5e1; padding-bottom: 10px; margin-bottom: 15px; color: #0f3057;">الشروط والأحكام</h3>
                        <div style="font-size: 12px; color: #334155; line-height: 1.8; white-space: pre-line;">
                            ${companySettings.contractTerms || 'لا توجد شروط إضافية.'}
                        </div>
                    </div>

                    <div class="footer">
                        <p>تم إصدار هذا العرض إلكترونياً من نظام إدارة العملاء CRP</p>
                        <p>صلاحية العرض 15 يوماً من تاريخه</p>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printWorkOrder(id) {
            const client = clients.find(c => c.id == id);
            if(!client) return;

            const items = client.quotationItems || [];
            
            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>أمر شغل - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 30px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 5px 0; font-size: 22px; }
                        .title-box { text-align: center; margin-bottom: 30px; }
                        .title-box h2 { background: #0f3057; color: white; display: inline-block; padding: 8px 30px; border-radius: 5px; margin: 0; font-size: 18px; }
                        
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #f8fafc; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
                        .info-row { margin-bottom: 8px; font-size: 14px; }
                        .info-label { color: #64748b; font-weight: bold; width: 100px; display: inline-block; }
                        .info-val { color: #0f172a; font-weight: bold; }

                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background: #e2e8f0; color: #0f3057; padding: 10px; text-align: right; font-size: 13px; border: 1px solid #cbd5e1; }
                        td { border: 1px solid #cbd5e1; padding: 10px; font-size: 14px; color: #334155; }
                        
                        .notes-section { border: 1px dashed #cbd5e1; padding: 15px; min-height: 100px; margin-bottom: 30px; border-radius: 8px; }
                        .notes-title { font-weight: bold; margin-bottom: 10px; font-size: 14px; color: #0f3057; }

                        .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
                        .sig-box { width: 45%; text-align: center; }
                        .sig-line { border-top: 1px solid #000; margin-top: 40px; }

                        @media print {
                            body { padding: 0; }
                            th { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.phone}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="title-box">
                        <h2>أمر شغل / تركيب | WORK ORDER</h2>
                    </div>

                    <div class="info-grid">
                        <div>
                            <div class="info-row"><span class="info-label">العميل:</span> <span class="info-val">${client.name}</span></div>
                            <div class="info-row"><span class="info-label">الجوال:</span> <span class="info-val">${client.phone}</span></div>
                            <div class="info-row"><span class="info-label">العنوان:</span> <span class="info-val">${client.address}</span></div>
                        </div>
                        <div>
                            <div class="info-row"><span class="info-label">رقم الملف:</span> <span class="info-val">${client.code}</span></div>
                            <div class="info-row"><span class="info-label">رقم الوظيفة:</span> <span class="info-val">${client.installation?.jobNo || '-'}</span></div>
                            <div class="info-row"><span class="info-label">تاريخ التركيب:</span> <span class="info-val">${client.installation?.startDate || 'غير محدد'}</span></div>
                            <div class="info-row"><span class="info-label">فريق التركيب:</span> <span class="info-val">${client.installation?.team || '-'}</span></div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th width="50">#</th>
                                <th>وصف البند / العمل المطلوب</th>
                                <th width="80" style="text-align:center">الكمية</th>
                                <th width="150">ملاحظات الفني</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.length > 0 ? items.map((item, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${item.name}</td>
                                    <td style="text-align:center; font-weight:bold;">${item.qty}</td>
                                    <td></td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" style="text-align:center; padding: 20px;">لا توجد بنود مسجلة</td></tr>'}
                        </tbody>
                    </table>

                    <div class="notes-section">
                        <div class="notes-title">ملاحظات التركيب / الموقع:</div>
                        <p style="font-size: 12px; color: #64748b;">${client.notes || ''}</p>
                    </div>

                    <div class="signatures">
                        <div class="sig-box">
                            <p>توقيع مشرف التركيب</p>
                            <div class="sig-line"></div>
                        </div>
                        <div class="sig-box">
                            <p>توقيع العميل (على إتمام التركيب)</p>
                            <div class="sig-line"></div>
                        </div>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Backup & Restore Functions
        function exportBackup() {
            const backupData = {
                clients: clients,
                settings: companySettings,
                version: '1.0',
                date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CRP_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('تحذير: سيتم استبدال جميع البيانات الحالية بالبيانات الموجودة في ملف النسخة الاحتياطية. هل أنت متأكد من المتابعة؟')) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.clients) {
                        clients = backup.clients;
                        localStorage.setItem('crm_clients_data', JSON.stringify(clients));
                    }
                    if (backup.settings) {
                        companySettings = { ...companySettings, ...backup.settings };
                        localStorage.setItem('crm_settings', JSON.stringify(companySettings));
                    }
                    alert('تم استعادة النسخة الاحتياطية بنجاح!');
                    location.reload();
                } catch (error) {
                    alert('حدث خطأ أثناء استعادة الملف: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Lightbox Functions
        function openLightbox(url) {
            const modal = document.getElementById('lightboxModal');
            const img = document.getElementById('lightboxImage');
            img.src = url;
            modal.classList.remove('hidden');
        }

        function closeLightbox() {
            document.getElementById('lightboxModal').classList.add('hidden');
        }

        init();
    </script>
    
    <!-- Lightbox Modal -->
    <div id="lightboxModal" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm transition-all duration-300" onclick="closeLightbox()">
        <div class="relative max-w-5xl max-h-[90vh] w-full flex items-center justify-center">
            <img id="lightboxImage" src="" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl animate-scaleIn" onclick="event.stopPropagation()">
            <button onclick="closeLightbox()" class="absolute -top-12 right-0 text-white hover:text-gray-300 bg-white/10 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>
</body>
</html>
